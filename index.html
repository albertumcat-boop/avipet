<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Control Pro - Automatizaci√≥n de Insumos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; padding: 0; }
            input, textarea, select { border: none !important; outline: none !important; background: transparent; appearance: none; }
            #doctorNombrePrint { display: block !important; }
        }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900">

    <div id="loginSection" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <h2 class="text-2xl font-bold mb-6">Panel Administrativo</h2>
            <input type="password" id="pinInput" placeholder="PIN de Seguridad" class="w-full p-3 border rounded-lg mb-4 text-center text-2xl tracking-widest">
            <button onclick="verificarPin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">ENTRAR</button>
        </div>
    </div>

    <main id="adminSection" class="hidden max-w-5xl mx-auto p-4">
        <nav class="flex space-x-8 border-b mb-6 no-print">
            <button onclick="showTab('historia')" id="tabH" class="tab-active py-2">Historia Cl√≠nica</button>
            <button onclick="showTab('insumos')" id="tabI" class="py-2 text-gray-500">Costos e Insumos Autom√°ticos</button>
        </nav>

        <section id="sectionHistoria" class="bg-white p-8 shadow-md border border-gray-400">
            <div class="flex justify-between items-start border-b-2 border-black pb-4 mb-4">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 border-2 border-black flex items-center justify-center font-bold text-xl">MV</div>
                    <div>
                        <select id="selectDoctor" class="no-print font-bold uppercase border p-1 text-sm mb-1 bg-blue-50">
                            <option value="DR. DARWIN SANDOVAL">DR. DARWIN SANDOVAL</option>
                            <option value="DR. JOAN SILVA">DR. JOAN SILVA</option>
                        </select>
                        <div id="doctorNombrePrint" class="hidden font-bold uppercase text-lg">DR. DARWIN SANDOVAL</div>
                        <p class="text-[10px] font-bold">M√âDICO VETERINARIO</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs">FECHA: <input type="text" id="fechaDoc" class="border-b border-black w-24 text-center"></p>
                </div>
            </div>

            <div class="no-print mb-6 p-4 bg-blue-900 text-white rounded-lg shadow-lg">
                <label class="block font-bold mb-2">SELECCIONAR SERVICIOS (Esto carga insumos autom√°ticamente):</label>
                <select id="selectorServicios" onchange="agregarServicio(this.value)" class="w-full p-2 text-black rounded font-bold">
                    <option value="">-- Seleccionar Servicio --</option>
                    <optgroup label="VACUNAS">
                        <option value="Sextuple">Sextuple</option>
                        <option value="Antirrabica">Antirrabica</option>
                        <option value="KC">KC / Puppy</option>
                        <option value="Triple Felina">Triple Felina</option>
                    </optgroup>
                    <optgroup label="LABORATORIO">
                        <option value="Hematologia">Hematologia</option>
                        <option value="Quimica">Quimica</option>
                        <option value="Descarte Hemoparasito">Descarte Hemoparasito</option>
                    </optgroup>
                    <optgroup label="OTROS">
                        <option value="Eutanasia <5kg">Eutanasia <5kg</option>
                        <option value="Consulta General">Consulta General</option>
                    </optgroup>
                </select>
                <div id="serviciosSeleccionados" class="mt-3 flex flex-wrap gap-2"></div>
            </div>

            <div class="grid grid-cols-2 gap-0 border border-black text-[11px]">
                <div class="border-r border-black p-2">
                    <h3 class="bg-gray-200 font-bold text-center border-b border-black mb-2 uppercase">Mascota</h3>
                    <p>NOMBRE: <input id="hNombre" type="text" class="border-b border-gray-300 w-32 font-bold"></p>
                    <p>RAZA: <input id="hRaza" type="text" class="border-b border-gray-300 w-32"></p>
                </div>
                <div class="p-2 text-[11px]">
                    <h3 class="bg-gray-200 font-bold text-center border-b border-black mb-2 uppercase">Motivo</h3>
                    <textarea id="hMotivo" class="w-full h-12 border-none resize-none"></textarea>
                </div>
            </div>

            <div class="mt-4 border border-black text-[11px]">
                <h3 class="bg-gray-100 p-1 font-bold border-b border-black">TRATAMIENTO / OBSERVACIONES:</h3>
                <textarea id="hTratamiento" class="w-full p-2 h-40 resize-none"></textarea>
            </div>

            <button onclick="guardarYImprimir()" class="no-print mt-6 bg-green-600 text-white px-8 py-3 rounded font-bold">üíæ GUARDAR E IMPRIMIR</button>
        </section>

        <section id="sectionInsumos" class="hidden bg-white p-8 border border-blue-400">
            <h2 class="text-xl font-bold text-blue-900 mb-6 uppercase border-b pb-2">Desglose de Insumos por Servicio</h2>
            
            <table class="w-full text-sm border-collapse border border-gray-300 mb-6">
                <thead class="bg-slate-800 text-white">
                    <tr>
                        <th class="p-2 border">Insumo</th>
                        <th class="p-2 border w-24">Costo $</th>
                        <th class="p-2 border w-20">Cant.</th>
                        <th class="p-2 border w-24">Subtotal</th>
                        <th class="p-2 border no-print w-10"></th>
                    </tr>
                </thead>
                <tbody id="cuerpoInsumos">
                    </tbody>
            </table>

            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="p-4 border bg-gray-50"><p class="text-xs font-bold">TOTAL INSUMOS</p><p id="totalInsumosLabel" class="text-2xl font-black">$0.00</p></div>
                <div class="p-4 border bg-blue-50"><p class="text-xs font-bold">COBRO CLIENTE</p>
                    <input type="number" id="precioVenta" value="0" oninput="calcularFinanzas()" class="text-2xl font-black w-24 bg-transparent text-center border-b-2 border-blue-600">
                </div>
                <div class="p-4 border bg-green-50"><p class="text-xs font-bold">UTILIDAD TIENDA</p><p id="utilidadLabel" class="text-2xl font-black text-green-700">$0.00</p></div>
            </div>
        </section>
    </main>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- DICCIONARIO DE INSUMOS POR SERVICIO ---
        const recetas = {
            "Sextuple": [
                { nombre: "Vacuna Sextuple (Vial)", costo: 8.50 },
                { nombre: "Jeringa 3cc", costo: 0.25 },
                { nombre: "Algod√≥n y Alcohol", costo: 0.10 },
                { nombre: "Guantes Par", costo: 0.50 }
            ],
            "Hematologia": [
                { nombre: "Tubo EDTA", costo: 0.80 },
                { nombre: "Inyec. 3cc", costo: 0.25 },
                { nombre: "Servicio Lab Externo", costo: 12.00 }
            ],
            "Eutanasia <5kg": [
                { nombre: "Cat√©ter 24G", costo: 1.20 },
                { nombre: "Propofol/Eutanex", costo: 15.00 },
                { nombre: "Guantes", costo: 0.50 },
                { nombre: "Bolsa Desecho", costo: 2.00 }
            ]
            // Aqu√≠ puedes seguir agregando todos los servicios de la imagen...
        };

        window.verificarPin = () => {
            if(document.getElementById('pinInput').value === "2026") {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                document.getElementById('fechaDoc').value = new Date().toLocaleDateString();
            }
        };

        window.showTab = (t) => {
            document.getElementById('sectionHistoria').classList.toggle('hidden', t !== 'historia');
            document.getElementById('sectionInsumos').classList.toggle('hidden', t !== 'insumos');
        };

        // --- AGREGAR SERVICIOS ---
        window.agregarServicio = (servicio) => {
            if (!servicio || !recetas[servicio]) return;

            // 1. Mostrar etiqueta en historia
            const lista = document.getElementById('serviciosSeleccionados');
            const span = document.createElement('span');
            span.className = "bg-blue-200 text-blue-800 px-2 py-1 rounded text-xs font-bold mr-2 mb-2";
            span.innerText = servicio;
            lista.appendChild(span);

            // 2. Cargar insumos en la tabla de costos
            const tbody = document.getElementById('cuerpoInsumos');
            recetas[servicio].forEach(insumo => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 border font-bold text-xs">${insumo.nombre} <span class="text-[8px] text-gray-400">(${servicio})</span></td>
                    <td class="p-2 border text-center"><input type="number" class="i-cost w-full bg-transparent" value="${insumo.costo}" oninput="calcularFinanzas()"></td>
                    <td class="p-2 border text-center"><input type="number" class="i-cant w-full bg-transparent font-bold" value="1" oninput="calcularFinanzas()"></td>
                    <td class="p-2 border font-bold i-sub text-center bg-gray-50">$${insumo.costo.toFixed(2)}</td>
                    <td class="p-2 border no-print text-center"><button onclick="this.parentElement.parentElement.remove(); calcularFinanzas()" class="text-red-500">√ó</button></td>
                `;
                tbody.appendChild(tr);
            });
            calcularFinanzas();
        };

        window.calcularFinanzas = () => {
            let totalI = 0;
            document.querySelectorAll('#cuerpoInsumos tr').forEach(f => {
                const c = parseFloat(f.querySelector('.i-cost').value) || 0;
                const n = parseFloat(f.querySelector('.i-cant').value) || 0;
                const s = c * n;
                f.querySelector('.i-sub').innerText = `$${s.toFixed(2)}`;
                totalI += s;
            });
            const venta = parseFloat(document.getElementById('precioVenta').value) || 0;
            const util = venta - totalI - ((venta - totalI) * 0.30); // 30% vet

            document.getElementById('totalInsumosLabel').innerText = `$${totalI.toFixed(2)}`;
            document.getElementById('utilidadLabel').innerText = `$${util.toFixed(2)}`;
        };

        window.guardarYImprimir = async () => {
            const doc = document.getElementById('selectDoctor').value;
            document.getElementById('doctorNombrePrint').innerText = doc;
            window.print();
        };
    </script>
</body>
</html>
