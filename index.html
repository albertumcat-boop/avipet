<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AVIPET - SISTEMA INTEGRAL PROFESIONAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f1f5f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1e293b;
    }
    .print-area {
      background: #ffffff;
      border-radius: 28px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    .header-box {
      border: 1px solid #cbd5e1;
      padding: 4px;
      text-align: center;
      font-weight: bold;
      font-size: 10px;
      background: #f8fafc;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .tab-active {
      border-bottom: 4px solid #2563eb;
      color: #2563eb;
      font-weight: bold;
    }
    input, textarea {
      outline: none;
      background: transparent;
      width: 100%;
      transition: all 0.2s;
    }
    input:focus { border-bottom: 2px solid #2563eb !important; }
    button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    button:active { transform: scale(0.95); }
    button:hover  { filter: brightness(1.1); }
    .menu-desplegable {
      width: 100%;
      padding: 14px;
      border: 2px solid #3b82f6;
      border-radius: 10px;
      background-color: #eff6ff;
      font-weight: bold;
      color: #1e40af;
      font-size: 13px;
      margin-bottom: 10px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e40af' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
    }
    @media screen {
      #doctorPrint { display: none; }
      #hTratamientoPrint { display: none; }
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(-10px); }
      to   { opacity:1; transform: translateY(0);     }
    }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }

  @media print {
  .no-print, button, select, nav, #loginSection,
  .finanzas-ocultar, .menu-desplegable { display:none !important; }

  body {
    background-color:white !important;
    padding:0; margin:0;
  }

  .print-area {
    border:none !important;
    box-shadow:none !important;
    width:100% !important;
  }

  #doctorPrint {
    display:block !important;
    font-weight:800;
    text-transform:uppercase;
    font-size:14px;
    color:black;
    margin-top:10px;
  }

  #hTratamiento { display:none !important; }

  #hTratamientoPrint {
    display:block !important;
    border:none !important;
    height:auto !important;
    overflow:visible !important;
    white-space:pre-wrap !important;
    font-size:13px;
    line-height:1.6;
    color:black !important;
    width:100% !important;
  }

  input {
    border:none !important;
    color:black !important;
    font-weight:bold;
  }

  /* --- HOJA DE VACUNAS: AJUSTES PARA IMPRESI√ìN --- */
  #sectionHojaVacunas {
    border:none !important;
    box-shadow:none !important;
    width:100% !important;
    max-width:100% !important;
    margin:0 !important;
    border-radius:0 !important;
    page-break-after:auto;
  }
}
  </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

<main id="adminSection" class="max-w-5xl mx-auto p-2 md:p-4">

  <!-- NAV -->
  <nav class="flex justify-around border-b-2 border-gray-200 mb-4 no-print bg-white sticky top-0 z-40 py-1">
    <button onclick="showTab('historia')" id="tabH"
            class="tab-active py-2 text-[11px] px-2 uppercase font-bold">
      Historia Cl√≠nica
    </button>
    <button onclick="showTab('buscador')" id="tabB"
            class="py-2 text-gray-500 text-[11px] px-2 uppercase font-bold">
      Buscador
    </button>
    <button onclick="showTab('reporte')" id="tabR"
            class="py-2 text-gray-500 text-[11px] px-2 uppercase font-bold">
      Finanzas / Caja
    </button>
    <button onclick="showTab('espera')" id="tabE"
            class="py-2 text-gray-500 text-[11px] px-2 uppercase font-bold">
      Sala de Espera
    </button>
    <button onclick="showTab('config_precios')"
            class="px-4 py-2 font-black text-[10px] uppercase bg-slate-100 rounded-lg shadow-sm border border-slate-200">
      ‚öôÔ∏è Ajustes de Precios
    </button>
  </nav>

<!-- ========== HISTORIA CL√çNICA ========== -->
  <section id="sectionHistoria"
           class="block bg-white p-4 shadow-sm border border-slate-200 rounded-xl print-area">

    <!-- Encabezado -->
    <div class="flex justify-between items-center border-b-2 border-blue-600 pb-4 mb-4">
      <div class="flex items-center gap-3">
        <div
          class="w-12 h-12 bg-blue-600 flex items-center justify-center text-white font-black text-2xl rounded-lg">
          A
        </div>
        <div>
          <h1 class="text-xl font-black text-slate-800">AVIPET</h1>
          <select id="selectDoctor"
                  onchange="window.validarAccesoDoctor(this.value)"
                  class="no-print text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 outline-none">
            <option value="">-- SELECCIONE DOCTOR --</option>
            <option value="Darwin Sandoval">DR. DARWIN SANDOVAL</option>
            <option value="Joan Silva">DRA. JOAN SILVA</option>
          </select>
          <!-- Botones PIN -->
          <div class="no-print mt-1 flex gap-2">
            <button type="button"
                    class="text-[9px] text-blue-500 underline"
                    onclick="window.cambiarPinDoctor(document.getElementById('selectDoctor').value || '')">
              Cambiar mi PIN
            </button>
            <button type="button"
                    class="text-[9px] text-red-500 underline"
                    onclick="window.solicitarCambioPinDoctor()">
              Olvid√© mi PIN
            </button>
          </div>
          <h2 id="doctorPrint"
              class="hidden print:block font-bold text-sm uppercase text-slate-700">
            DOCTOR CARGO
          </h2>
        </div>
      </div>
      <div class="text-right">
        <input type="text" id="fechaDoc"
               class="w-24 text-right font-black text-xs text-slate-500 bg-transparent"
               readonly>
      </div>
    </div>

    <!-- Ficha Mascota / Propietario -->
    <div class="grid grid-cols-1 md:grid-cols-2 border border-slate-400 text-[11px] mb-4">
      <div class="p-3 border-b md:border-b-0 md:border-r border-slate-400 space-y-2">
        <div class="header-box italic">Ficha T√©cnica de Mascota</div>
        <div class="grid grid-cols-2 gap-2">
          <div class="col-span-2">
            <label class="text-[9px] font-bold text-slate-400">MASCOTA</label>
            <input id="hNombre" class="border-b w-full font-bold uppercase text-blue-700">
          </div>
          <div>
            <label class="text-[9px] font-bold text-slate-400">ESPECIE</label>
            <input id="hEspecie" class="border-b w-full uppercase">
          </div>
          <div>
            <label class="text-[9px] font-bold text-slate-400">RAZA</label>
            <input id="hRaza" class="border-b w-full uppercase">
          </div>
          <div>
            <label class="text-[9px] font-bold text-slate-400">PESO (KG)</label>
            <input id="hPeso" class="border-b w-full">
          </div>
          <!-- AJUSTADO: 3 columnas EDAD / SEXO / COLOR -->
          <div class="grid grid-cols-3 gap-1">
            <div>
              <label class="text-[9px] font-bold text-slate-400">EDAD</label>
              <input id="hEdad" class="border-b w-full uppercase">
            </div>
            <div>
              <label class="text-[9px] font-bold text-slate-400">SEXO</label>
              <input id="hSexo" class="border-b w-full uppercase">
            </div>
            <div>
              <label class="text-[9px] font-bold text-slate-400">COLOR</label>
              <input id="hColor" class="border-b w-full uppercase">
            </div>
          </div>
        </div>
      </div>

      <div class="p-3 space-y-2">
        <div class="header-box italic">Datos del Propietario</div>
        <div>
          <div class="flex justify-between items-center">
            <label class="text-[9px] font-bold text-slate-400">NOMBRE Y APELLIDO</label>
            <label class="flex items-center gap-1 cursor-pointer no-print opacity-60">
              <input type="checkbox" id="hAlerta" class="w-3 h-3 accent-red-600">
              <span class="text-[8px] font-bold text-slate-400 italic">Ref. Interna</span>
            </label>
          </div>
          <input id="hProp" class="border-b w-full uppercase">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-[9px] font-bold text-slate-400">C√âDULA</label>
            <input id="hCI" onblur="window.autocompletarPorCedula(this.value)" class="border-b w-full font-bold text-blue-700">
          </div>
          <div>
            <label class="text-[9px] font-bold text-slate-400">TEL√âFONO</label>
            <input id="hTlf" class="border-b w-full">
          </div>
        </div>
        <div>
          <label class="text-[9px] font-bold text-slate-400">CORREO ELECTR√ìNICO</label>
          <input id="hMail" class="border-b w-full">
        </div>
        <div>
          <label class="text-[9px] font-bold text-slate-400">DIRECCI√ìN</label>
          <input id="hDir" class="border-b w-full uppercase text-[10px]">
        </div>
      </div>
    </div>

    <!-- Servicios -->
    <div class="border border-slate-400 mb-6 rounded-lg overflow-hidden">
      <div class="bg-slate-100 p-3 no-print">
        <label class="block text-blue-900 text-[10px] font-black uppercase mb-1">
          A√±adir Servicios R√°pidos:
        </label>
        <select id="selectorServicios" class="menu-desplegable"
                onchange="window.insertarServicio(this.value)">
          <option value="">-- SELECCIONE UN SERVICIO --</option>
          <optgroup label="ü©∫ CONSULTAS">
            <option value="CONSULTA GENERAL">CONSULTA GENERAL</option>
            <option value="CONSULTA OFTALMOL√ìGICA">CONSULTA OFTALMOL√ìGICA</option>
            <option value="CONSULTA CAMADA 3-4 CACHORROS">CONSULTA CAMADA 3-4 CACHORROS</option>
            <option value="CONSULTA CAMADA HASTA 8 CACHORROS">CONSULTA CAMADA HASTA 8 CACHORROS</option>
            <option value="CONSULTA CAMADA MAS DE 8 CACHORROS">CONSULTA CAMADA MAS DE 8 CACHORROS</option>
            <option value="CONSULTA DE EMERGENCIA">CONSULTA DE EMERGENCIA</option>
          </optgroup>
          <optgroup label="üíâ VACUNAS">
            <option value="VACUNA SEXTUPLE">VACUNA SEXTUPLE</option>
            <option value="VACUNA PUPPY">VACUNA PUPPY</option>
            <option value="VACUNA ANTIRR√ÅBICA">VACUNA ANTIRR√ÅBICA</option>
            <option value="VACUNA KC (TOS DE LAS PERRERAS)">VACUNA KC (TOS DE LAS PERRERAS)</option>
            <option value="VACUNA TRIPLE FELINA">VACUNA TRIPLE FELINA</option>
            <option value="VACUNA QUINTUPLE FELINA">VACUNA QUINTUPLE FELINA</option>
            <option value="VACUNA BIOVETA">VACUNA BIOVETA</option>
          </optgroup>
          <optgroup label="üî¨ LABORATORIO">
            <option value="HEMATOLOG√çA COMPLETA">HEMATOLOG√çA COMPLETA</option>
            <option value="QU√çMICA SANGU√çNEA">QU√çMICA SANGU√çNEA</option>
            <option value="DESCARTE HEMOPARASITO">DESCARTE HEMOPARASITO</option>
            <option value="DISTEMPER">DISTEMPER</option>
            <option value="PARVOVIRUS - CORONAVIRUS">PARVOVIRUS - CORONAVIRUS</option>
            <option value="FILARIASIS">FILARIASIS</option>
            <option value="SIDA - LEUCEMIA">SIDA - LEUCEMIA</option>
            <option value="HEMATOLOGIA+QUIMICA+HEMOPARASITOS">COMBO LABORATORIO</option>
            <option value="EXAMEN DE HECES">EXAMEN DE HECES</option>
            <option value="EXAMENES DE ORINA">EXAMENES DE ORINA</option>
            <option value="CITOLOGIA 1 OIDO">CITOLOG√çA 1 O√çDO</option>
            <option value="CITOLOGIA 2 OIDOS">CITOLOG√çA 2 O√çDOS</option>
            <option value="RASPADO PIEL">RASPADO PIEL</option>
            <option value="PERFIL ANEMICO">PERFIL AN√âMICO</option>
          </optgroup>
          <optgroup label="üêæ OTROS PROCEDIMIENTOS">
            <option value="ABSCESO">ABSCESO</option>
            <option value="ECOGRAF√çA">ECOGRAF√çA</option>
            <option value="EUTANASIA HASTA 5KG">EUTANASIA HASTA 5KG</option>
            <option value="EUTANASIA HASTA 15KG">EUTANASIA HASTA 15KG</option>
            <option value="EUTANASIA HASTA 25KG">EUTANASIA HASTA 25KG</option>
            <option value="EUTANASIA HASTA 35KG">EUTANASIA HASTA 35KG</option>
            <option value="KG ADICIONAL">KG ADICIONAL</option>
            <option value="DISPOSICION">DISPOSICI√ìN</option>
            <option value="CREMACION CON CENIZAS">CREMACI√ìN CON CENIZAS</option>
          </optgroup>
        </select>

        <!-- NUEVO: LISTA DESPLEGABLE DE MEDICAMENTOS -->
        <label class="block text-blue-900 text-[10px] font-black uppercase mb-1 mt-3">
          A√±adir Medicamentos:
        </label>
        <select id="selectorMedicamentos" class="menu-desplegable"
                onchange="window.agregarMedicamento(this.value)">
          <option value="">-- SELECCIONE UN MEDICAMENTO --</option>
          <option value="Piroyet">Piroyet</option>
          <option value="Enrofloxacina">Enrofloxacina</option>
          <option value="Sulfatrim">Sulfatrim</option>
          <option value="Dexametasona">Dexametasona</option>
          <option value="Carprofen">Carprofen</option>
          <option value="Flunixin">Flunixin</option>
          <option value="Metadol">Metadol</option>
          <option value="Complejo B">Complejo B</option>
          <option value="Suero hiperinmune">Suero hiperinmune (por ml)</option>
          <option value="Bromuro de hioscina">Bromuro de hioscina</option>
          <option value="Fenobarbital">Fenobarbital</option>
          <option value="Gastrine">Gastrine</option>
          <option value="Ranitidina">Ranitidina</option>
          <option value="Metoclopramida">Metoclopramida</option>
          <option value="Furosemina">Furosemina</option>
          <option value="Vit K">Vit K</option>
          <option value="Eritrogen">Eritrogen</option>
          <option value="Aminovit">Aminovit</option>
          <option value="Oxitetraciclina">Oxitetraciclina</option>
          <option value="Pimobendan">Pimobendan</option>
          <option value="Ceftriaxona">Ceftriaxona</option>
          <option value="Adrenalina / Epin">Adrenalina / Epin</option>
          <option value="Artrosan">Artrosan 1 ml x 20kg</option>
          <option value="Lisavac">Lisavac 1 ml x kg</option>
          <option value="Soroglobulin">Soroglobulin</option>
          <option value="Infervac">Infervac</option>
        </select>
      </div>
      <textarea id="hTratamiento"
          class="w-full h-64 p-4 text-sm font-medium leading-relaxed bg-white outline-none"
                placeholder="Escriba aqu√≠ el diagn√≥stico..."
                oninput="document.getElementById('hTratamientoPrint').innerText = this.value"></textarea>
      <div id="hTratamientoPrint"
           class="hidden print:block p-4 whitespace-pre-wrap text-sm leading-relaxed border-none"></div>
    </div>

    <!-- Insumos -->
    <div id="contenedorInsumos"
         class="no-print mt-4 mb-6 border-2 border-blue-100 rounded-xl overflow-hidden hidden">
      <table class="w-full text-[11px] text-left">
        <thead class="bg-blue-600 text-white uppercase italic">
        <tr>
          <th class="p-2">Insumo</th>
          <th class="p-2 w-16 text-center">Cant.</th>
          <th class="p-2 w-16 text-center">Precio $</th>
          <th class="p-2 w-10"></th>
        </tr>
        </thead>
        <tbody id="listaInsumosDinamica" class="bg-white"></tbody>
      </table>
      <div class="bg-slate-50 p-2 border-t border-blue-100 flex gap-2 items-center">
        <input type="text" id="nombreExtra"
               placeholder="A√±adir algo extra..."
               class="flex-1 text-[10px] p-2 border rounded bg-white">
        <input type="number" id="costoExtra"
               placeholder="0.00"
               class="w-14 text-[10px] p-2 border rounded bg-white">
        <button onclick="window.agregarInsumoManual()"
                class="bg-blue-600 text-white px-4 py-2 rounded text-[10px] font-black">
          + AGREGAR
        </button>
      </div>
    </div>

    <!-- Monto (solo precio cobrado) -->
    <div class="no-print flex justify-center mb-6">
      <div class="w-full md:w-2/3 lg:w-1/2 bg-blue-50 p-6 rounded-3xl border-2 border-blue-200 text-center shadow-inner">
        <label class="text-[10px] text-blue-600 font-bold uppercase block mb-1 tracking-widest">
          Monto Total a Cobrar ($)
        </label>
        <input type="number" id="precioVenta" value="0"
               oninput="window.calcularTodo()"
               class="text-5xl font-black w-full bg-transparent text-center text-blue-700 outline-none placeholder-blue-300">
      </div>
    </div>
    <div id="displayGananciaDoctor" class="hidden">
      <p id="montoDoctor">$ 0.00</p>
    </div>
    <input type="number" id="gastoInsumos" value="0" class="hidden" readonly>

    <!-- Botones Guardar -->
    <div class="grid grid-cols-2 gap-3">
      <button type="button"
              onclick="guardarFirebase(false)"
              class="bg-slate-200 py-4 rounded-xl font-black uppercase text-xs">
        Guardar Datos
      </button>
      <button type="button"
              onclick="guardarFirebase(true)"
              class="bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">
        Guardar e Imprimir
      </button>
    </div>

    <!-- üìÑ Receta Sin Costos -->
    <button type="button"
            onclick="imprimirRecetaLimpia && imprimirRecetaLimpia()"
            class="w-full bg-cyan-500 text-white py-4 rounded-xl font-black uppercase text-xs mt-3">
      üìÑ Receta Sin Costos
    </button>

    <!-- üíâ Hoja de Vacunas del Paciente -->
    <button type="button"
            onclick="window.abrirHojaVacunasDesdeHistoria()"
            class="w-full bg-emerald-500 text-white py-3 rounded-xl font-black uppercase text-[10px] mt-3 no-print">
      üíâ Hoja de Vacunas del Paciente
    </button>

    <!-- NUEVO: Recepci√≥n ‚Üí Cola de Espera -->
    <button type="button"
            onclick="window.enviarAColaEspera()"
            class="w-full bg-emerald-500 text-white py-3 rounded-xl font-black uppercase text-[10px] mt-3 no-print">
      ‚ûï Enviar a Cola de Espera
    </button>
  </section>

  <!-- ========== HOJA DE VACUNAS / DESPARASITACIONES ========== -->
  <section id="sectionHojaVacunas"
           class="hidden bg-white p-4 shadow-sm border border-slate-200 rounded-xl max-w-3xl mx-auto mt-4 print-area text-[11px]">

    <!-- ENCABEZADO CON LOGO DE DOCTOR + DIRECCI√ìN FIJA -->
    <div class="border-b border-slate-400 pb-2 mb-3 flex items-start gap-3">
      <!-- Logo din√°mico del doctor -->
      <div class="w-16 h-16 border border-slate-300 rounded-lg flex items-center justify-center overflow-hidden">
        <img id="hv_logoDoctor"
             src=""
             alt="Logo Doctor"
             class="max-w-full max-h-full object-contain">
      </div>

      <div class="flex-1">
        <h2 id="hv_nombreDoctor"
            class="text-xs font-black text-slate-800 uppercase tracking-wide">
          <!-- Nombre doctor din√°mico -->
        </h2>
        <p id="hv_clinicaDoctor"
           class="text-[10px] text-slate-600 leading-tight">
          <!-- Cl√≠nica / texto secundario -->
        </p>
        <p class="mt-1 text-[9px] text-slate-500 leading-snug">
          DIRECCI√ìN: Av. Francisco de Miranda, Sector Buena Vista, a 600mts del Metro La California
          (frente al Gimnasio Vertical El Dorado), Tienda Av√≠cola Petare (0212-2710435),
          Petare - Edo. Miranda.
        </p>
      </div>

      <div class="text-right">
        <p class="text-[9px] font-bold text-slate-500 uppercase">Fecha</p>
        <input type="text" id="hv_fecha"
               class="w-24 text-right font-black text-xs text-slate-700 bg-transparent border-b border-slate-400"
               readonly>
      </div>
    </div>

    <!-- DATOS DEL PROPIETARIO / PACIENTE -->
    <div class="border border-slate-400 rounded-lg p-2 mb-3">
      <div class="grid grid-cols-2 gap-2">
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">NOMBRE (PROPIETARIO):</span>
          <input id="hv_propietario"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">C.I:</span>
          <input id="hv_cedula"
                 class="w-full border-b border-slate-400 text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">TLF:</span>
          <input id="hv_telefono"
                 class="w-full border-b border-slate-400 text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">DIRECCI√ìN:</span>
          <input id="hv_direccion"
                 class="w-full border-b border-slate-400 uppercase text-[10px]">
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-2">
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">ESPECIE:</span>
          <input id="hv_especie"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">RAZA:</span>
          <input id="hv_raza"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">NOMBRE (PACIENTE):</span>
          <input id="hv_paciente"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
      </div>

      <div class="grid grid-cols-4 gap-2 mt-2">
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">EDAD:</span>
          <input id="hv_edad"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">SEXO:</span>
          <input id="hv_sexo"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">PESO:</span>
          <input id="hv_peso"
                 class="w-full border-b border-slate-400 text-[11px]">
        </div>
        <div>
          <span class="text-[9px] font-bold uppercase text-slate-500">COLOR:</span>
          <input id="hv_color"
                 class="w-full border-b border-slate-400 uppercase text-[11px]">
        </div>
      </div>
    </div>

    <!-- DESPARASITACIONES -->
    <div class="border border-slate-400 rounded-lg mb-3">
      <div class="bg-slate-100 px-2 py-1 border-b border-slate-400">
        <span class="text-[10px] font-black uppercase text-slate-700">
          DESPARASITACIONES
        </span>
      </div>
      <table class="w-full text-[9px]">
        <thead class="bg-slate-50 text-slate-700 uppercase">
          <tr>
            <th class="border-b border-slate-400 py-1 text-left">Fecha</th>
            <th class="border-b border-slate-400 py-1 text-left">Desparasitante</th>
            <th class="border-b border-slate-400 py-1 text-left">Edad / Peso</th>
            <th class="border-b border-slate-400 py-1 text-left">Pr√≥xima desparasitaci√≥n</th>
            <th class="border-b border-slate-400 py-1 text-left">Firma / Sello</th>
          </tr>
        </thead>
        <tbody>
          <tr class="h-10">
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
          </tr>
          <tr class="h-10">
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
          </tr>
          <tr class="h-10">
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- CONTROL DE VACUNA -->
    <div class="border border-slate-400 rounded-lg mb-3">
      <div class="bg-slate-100 px-2 py-1 border-b border-slate-400 flex justify-between items-center">
        <span class="text-[10px] font-black uppercase text-slate-700">
          CONTROL DE VACUNA
        </span>
      </div>
      <table class="w-full text-[9px]">
        <thead class="bg-slate-50 text-slate-700 uppercase">
          <tr>
            <th class="border-b border-slate-400 py-2 text-left">Fecha Vacunaci√≥n</th>
            <th class="border-b border-slate-400 py-2 text-left">Lote / Vacuna</th>
            <th class="border-b border-slate-400 py-2 text-left">Peso</th>
            <th class="border-b border-slate-400 py-2 text-left">Pr√≥xima vacunaci√≥n</th>
            <th class="border-b border-slate-400 py-2 text-left">Sello / Firma</th>
          </tr>
        </thead>
        <tbody>
          <tr class="h-16">
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
          </tr>
          <tr class="h-16">
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
          </tr>
          <tr class="h-16">
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
            <td class="border-b border-slate-300 px-1"><input class="w-full text-[9px]"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- BOTONES HOJA VACUNAS -->
    <div class="no-print flex flex-col sm:flex-row justify-between gap-2 mt-3">
      <button type="button"
              onclick="window.volverAHistoriaDesdeVacunas()"
              class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-black text-[10px] uppercase">
        ‚¨Ö Volver a Historia Cl√≠nica
      </button>
      <button type="button"
              onclick="window.imprimirHojaVacunas()"
              class="flex-1 bg-emerald-600 text-white py-2 rounded-lg font-black text-[10px] uppercase">
        üñ® Imprimir Hoja de Vacunas
      </button>
    </div>
  </section>

  <!-- ========== BUSCADOR ========== -->
  <section id="sectionBuscador" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100 max-w-2xl mx-auto">
      <h2 class="text-blue-600 font-black uppercase text-center mb-6">üîé Central de B√∫squeda</h2>
      <div class="flex gap-2 mb-6">
        <input type="text" id="searchCI"
               placeholder="C√©dula del propietario..."
               class="w-full p-4 border rounded-xl outline-none focus:border-blue-500">
        <button onclick="window.buscarPorCedula()"
                class="bg-blue-600 text-white px-6 rounded-xl font-bold">
          BUSCAR
        </button>
      </div>
      <div id="resultadosBusqueda" class="space-y-4"></div>
    </div>
  </section>

  <!-- ========== REPORTE / CAJA ========== -->
  <section id="sectionReporte" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm max-w-2xl mx-auto">
      <h2 class="font-black text-center mb-2 uppercase text-slate-700 text-2xl tracking-tighter">
        Gesti√≥n de Caja Diaria
      </h2>

      <div class="text-center mb-4">
        <span class="bg-slate-100 text-slate-500 px-4 py-1 rounded-full text-[10px] font-bold uppercase border border-slate-200">
          Pacientes: <span id="totalPacientes" class="text-slate-800">0</span>
        </span>
      </div>

      <div id="listaReporte"
           class="divide-y mb-6 text-[10px] max-h-40 overflow-y-auto bg-slate-50 p-2 rounded-lg border border-slate-100"></div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
          <p class="text-[10px] font-bold uppercase text-slate-400">Bruto Total</p>
          <p id="repBruto" class="text-2xl font-black text-slate-700 font-mono">$0.00</p>
        </div>
        <div class="p-4 bg-amber-50 rounded-2xl border-l-4 border-amber-400">
          <p class="text-[10px] font-bold uppercase text-amber-600">Costos Operativos</p>
          <p id="repGastos" class="text-2xl font-black text-amber-700 font-mono">$0.00</p>
        </div>
        <div class="p-4 bg-blue-50 rounded-2xl border-l-4 border-blue-400 col-span-2 space-y-2">
          <div class="flex justify-between items-center border-b border-blue-100 pb-1">
            <span class="text-[11px] font-black uppercase text-blue-800">Dr. Darwin Sandoval:</span>
            <span id="repDocSandoval" class="text-lg font-black text-blue-600 font-mono">$0.00</span>
          </div>
          <div class="flex justify-between items-center pt-1">
            <span class="text-[11px] font-black uppercase text-blue-800">Dra. Joan Silva:</span>
            <span id="repDocSilva" class="text-lg font-black text-blue-600 font-mono">$0.00</span>
          </div>
        </div>
        <div class="p-4 bg-emerald-50 rounded-2xl border-l-4 border-emerald-500 col-span-2 shadow-sm">
          <p class="text-[10px] font-bold uppercase text-emerald-600">Utilidad Neta (Avipet)</p>
          <p id="repNeto" class="text-3xl font-black text-emerald-700 font-mono">$0.00</p>
        </div>
      </div>

      <!-- Bloque an√°lisis inteligente -->
      <div id="contenedorAnalisis"
           class="hidden mt-6 pt-6 border-t-2 border-slate-100 animate-fadeIn">
        <h3 class="text-center font-black text-indigo-900 uppercase text-sm mb-4 tracking-widest">
          üìä An√°lisis Estrat√©gico Mensual
        </h3>
        <div id="gridAnalisis" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 mb-6">
          <p class="text-[10px] font-bold uppercase text-indigo-600 mb-2">Desempe√±o de Equipo</p>
          <div id="analisisDoctores" class="space-y-2"></div>
        </div>
      </div>

      <button onclick="generarAnalisisCompleto && generarAnalisisCompleto()"
              class="w-full mb-4 bg-indigo-600 text-white py-3 rounded-xl font-black shadow-lg active:scale-95 transition-all uppercase text-xs">
        üìà Generar An√°lisis Inteligente
      </button>
      <div class="flex flex-col gap-2">
        <button onclick="cargarReporte()"
                class="w-full bg-slate-700 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all uppercase text-xs">
          üîÑ Actualizar Balance
        </button>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="descargarReporte && descargarReporte()"
                  class="bg-slate-100 text-slate-600 py-3 rounded-xl font-black text-[10px] hover:bg-slate-200 transition-colors uppercase">
            üì• Descargar TXT
          </button>
          <button onclick="guardarResumenDelDia && guardarResumenDelDia()"
                  class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[10px] shadow-md hover:bg-emerald-700 transition-colors uppercase">
            üíæ Guardar en Nube
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== CONFIG PRECIOS ========== -->
  <section id="sectionConfigPrecios" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg max-w-4xl mx-auto">
      <h2 class="text-2xl font-black text-blue-900 mb-2 uppercase italic">
        üõ† Panel de Control Maestro
      </h2>
      <p class="text-[10px] text-slate-500 mb-6 font-bold uppercase tracking-widest text-center border-b pb-2">
        Gesti√≥n de Tarifas, Comisiones y Costos de Materiales
      </p>

      <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
        <button onclick="window.cambiarSubTabConfig('servicios')" id="btnTabServ"
                class="flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-blue-600 shadow-sm">
          üíâ Servicios y Ganancias
        </button>
        <button onclick="window.cambiarSubTabConfig('insumos')" id="btnTabIns"
                class="flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg-white/50">
          üì¶ Costo de Insumos
        </button>
      </div>

      <div id="areaBtnAgregarInsumo" class="hidden mb-4 flex justify-end">
        <button onclick="window.agregarInsumoNuevoManual()"
                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow-md font-black text-[10px] uppercase transition-all">
          ‚ûï Agregar Insumo Nuevo
        </button>
      </div>

      <div id="bannerSincro"
           class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded-xl flex items.center justify-between gap-4">
        <div class="flex-1">
          <h3 class="text-[10px] font-black text-orange-600 uppercase">Sincronizaci√≥n Maestra</h3>
          <p class="text-[9px] text-orange-400">
            Usa esto solo para subir los datos del c√≥digo a la nube por primera vez.
          </p>
        </div>
        <button onclick="window.inicializarBaseDeDatosCompleta()"
                class="bg-orange-600 text-white px-6 py-3 rounded-xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-transform">
          üöÄ Sincronizar Todo
        </button>
      </div>

      <div id="contenedorTabServicios"
           class="overflow-x-auto bg-slate-50 rounded-xl border border-slate-100 p-2">
        <table class="w-full text-left text-[12px]">
          <thead>
          <tr class="text-blue-900 font-black uppercase text-[10px]">
            <th class="p-3">Servicio / Tratamiento</th>
            <th class="p-3 w-28 text-center">Precio ($)</th>
            <th class="p-3 w-28 text-center">Doc (%)</th>
            <th class="p-3 w-24 text-center">Acci√≥n</th>
          </tr>
          </thead>
          <tbody id="tablaMaestraServicios" class="bg-white divide-y"></tbody>
        </table>
      </div>

      <div id="contenedorTabInsumos"
           class="hidden overflow-x-auto bg-slate-50 rounded-xl border border-slate-100 p-2">
        <table class="w-full text-left text-[12px]">
          <thead>
          <tr class="text-emerald-900 font-black uppercase text-[10px]">
            <th class="p-3">Insumo / Material</th>
            <th class="p-3 w-32 text-center">Costo Unitario ($)</th>
            <th class="p-3 w-24 text-center">Acci√≥n</th>
          </tr>
          </thead>
          <tbody id="tablaMaestraInsumos" class="bg-white divide-y"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========== SALA DE ESPERA ========== -->
  <section id="sectionEspera" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg max-w-3xl mx-auto">
      <h2 class="text-xl font-black text-blue-900 mb-4 uppercase">Pacientes en Espera</h2>
      <div id="listaEspera" class="space-y-2 max-h-80 overflow-y-auto text-[11px]"></div>
    </div>
  </section>

</main>

<!-- MODAL LOGIN -->
<section id="modalLogin"
         class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
  <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full border border-slate-200">
    <h3 class="text-center font-black text-slate-700 uppercase text-sm mb-4">
      üîê Acceso Privado
    </h3>
    <input type="password" id="inputPass"
           placeholder="Ingrese PIN"
           class="w-full p-3 rounded-xl border border-slate-200 mb-2 text-center text-lg font-mono">
    <button onclick="validarAcceso()"
            class="w-full bg-slate-800 text-white py-3 rounded-xl font-black uppercase text-xs mb-3">
      Entrar
    </button>
    <button onclick="recuperarPin()"
            class="w-full text-slate-400 text-[10px] uppercase font-bold hover:text-indigo-600 transition-colors">
      He olvidado mi PIN
    </button>
    <button onclick="cerrarModalLogin()"
            class="w-full mt-2 text-red-400 text-[10px] uppercase font-bold">
      Cancelar
    </button>
  </div>
</section>

  <!-- ========== REPORTE / CAJA ========== -->
  <section id="sectionReporte" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm max-w-2xl mx-auto">
      <h2 class="font-black text-center mb-2 uppercase text-slate-700 text-2xl tracking-tighter">
        Gesti√≥n de Caja Diaria
      </h2>

      <div class="text-center mb-4">
        <span class="bg-slate-100 text-slate-500 px-4 py-1 rounded-full text-[10px] font-bold uppercase border border-slate-200">
          Pacientes: <span id="totalPacientes" class="text-slate-800">0</span>
        </span>
      </div>

      <div id="listaReporte"
           class="divide-y mb-6 text-[10px] max-h-40 overflow-y-auto bg-slate-50 p-2 rounded-lg border border-slate-100"></div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
          <p class="text-[10px] font-bold uppercase text-slate-400">Bruto Total</p>
          <p id="repBruto" class="text-2xl font-black text-slate-700 font-mono">$0.00</p>
        </div>
        <div class="p-4 bg-amber-50 rounded-2xl border-l-4 border-amber-400">
          <p class="text-[10px] font-bold uppercase text-amber-600">Costos Operativos</p>
          <p id="repGastos" class="text-2xl font-black text-amber-700 font-mono">$0.00</p>
        </div>
        <div class="p-4 bg-blue-50 rounded-2xl border-l-4 border-blue-400 col-span-2 space-y-2">
          <div class="flex justify-between items-center border-b border-blue-100 pb-1">
            <span class="text-[11px] font-black uppercase text-blue-800">Dr. Darwin Sandoval:</span>
            <span id="repDocSandoval" class="text-lg font-black text-blue-600 font-mono">$0.00</span>
          </div>
          <div class="flex justify-between items-center pt-1">
            <span class="text-[11px] font-black uppercase text-blue-800">Dra. Joan Silva:</span>
            <span id="repDocSilva" class="text-lg font-black text-blue-600 font-mono">$0.00</span>
          </div>
        </div>
        <div class="p-4 bg-emerald-50 rounded-2xl border-l-4 border-emerald-500 col-span-2 shadow-sm">
          <p class="text-[10px] font-bold uppercase text-emerald-600">Utilidad Neta (Avipet)</p>
          <p id="repNeto" class="text-3xl font-black text-emerald-700 font-mono">$0.00</p>
        </div>
      </div>

      <!-- Bloque an√°lisis inteligente -->
      <div id="contenedorAnalisis"
           class="hidden mt-6 pt-6 border-t-2 border-slate-100 animate-fadeIn">
        <h3 class="text-center font-black text-indigo-900 uppercase text-sm mb-4 tracking-widest">
          üìä An√°lisis Estrat√©gico Mensual
        </h3>
        <div id="gridAnalisis" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 mb-6">
          <p class="text-[10px] font-bold uppercase text-indigo-600 mb-2">Desempe√±o de Equipo</p>
          <div id="analisisDoctores" class="space-y-2"></div>
        </div>
      </div>

      <button onclick="generarAnalisisCompleto && generarAnalisisCompleto()"
              class="w-full mb-4 bg-indigo-600 text-white py-3 rounded-xl font-black shadow-lg active:scale-95 transition-all uppercase text-xs">
        üìà Generar An√°lisis Inteligente
      </button>
      <div class="flex flex-col gap-2">
        <button onclick="cargarReporte()"
                class="w-full bg-slate-700 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all uppercase text-xs">
          üîÑ Actualizar Balance
        </button>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="descargarReporte && descargarReporte()"
                  class="bg-slate-100 text-slate-600 py-3 rounded-xl font-black text-[10px] hover:bg-slate-200 transition-colors uppercase">
            üì• Descargar TXT
          </button>
          <button onclick="guardarResumenDelDia && guardarResumenDelDia()"
                  class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[10px] shadow-md hover:bg-emerald-700 transition-colors uppercase">
            üíæ Guardar en Nube
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== CONFIG PRECIOS ========== -->
  <section id="sectionConfigPrecios" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg max-w-4xl mx-auto">
      <h2 class="text-2xl font-black text-blue-900 mb-2 uppercase italic">
        üõ† Panel de Control Maestro
      </h2>
      <p class="text-[10px] text-slate-500 mb-6 font-bold uppercase tracking-widest text-center border-b pb-2">
        Gesti√≥n de Tarifas, Comisiones y Costos de Materiales
      </p>

      <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
        <button onclick="window.cambiarSubTabConfig('servicios')" id="btnTabServ"
                class="flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-blue-600 shadow-sm">
          üíâ Servicios y Ganancias
        </button>
        <button onclick="window.cambiarSubTabConfig('insumos')" id="btnTabIns"
                class="flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg-white/50">
          üì¶ Costo de Insumos
        </button>
      </div>

      <div id="areaBtnAgregarInsumo" class="hidden mb-4 flex justify-end">
        <button onclick="window.agregarInsumoNuevoManual()"
                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow-md font-black text-[10px] uppercase transition-all">
          ‚ûï Agregar Insumo Nuevo
        </button>
      </div>

      <div id="bannerSincro"
           class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded-xl flex items.center justify-between gap-4">
        <div class="flex-1">
          <h3 class="text-[10px] font-black text-orange-600 uppercase">Sincronizaci√≥n Maestra</h3>
          <p class="text-[9px] text-orange-400">
            Usa esto solo para subir los datos del c√≥digo a la nube por primera vez.
          </p>
        </div>
        <button onclick="window.inicializarBaseDeDatosCompleta()"
                class="bg-orange-600 text-white px-6 py-3 rounded-xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-transform">
          üöÄ Sincronizar Todo
        </button>
      </div>

      <div id="contenedorTabServicios"
           class="overflow-x-auto bg-slate-50 rounded-xl border border-slate-100 p-2">
        <table class="w-full text-left text-[12px]">
          <thead>
          <tr class="text-blue-900 font-black uppercase text-[10px]">
            <th class="p-3">Servicio / Tratamiento</th>
            <th class="p-3 w-28 text-center">Precio ($)</th>
            <th class="p-3 w-28 text-center">Doc (%)</th>
            <th class="p-3 w-24 text-center">Acci√≥n</th>
          </tr>
          </thead>
          <tbody id="tablaMaestraServicios" class="bg-white divide-y"></tbody>
        </table>
      </div>

      <div id="contenedorTabInsumos"
           class="hidden overflow-x-auto bg-slate-50 rounded-xl border border-slate-100 p-2">
        <table class="w-full text-left text-[12px]">
          <thead>
          <tr class="text-emerald-900 font-black uppercase text-[10px]">
            <th class="p-3">Insumo / Material</th>
            <th class="p-3 w-32 text-center">Costo Unitario ($)</th>
            <th class="p-3 w-24 text-center">Acci√≥n</th>
          </tr>
          </thead>
          <tbody id="tablaMaestraInsumos" class="bg-white divide-y"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========== SALA DE ESPERA ========== -->
  <section id="sectionEspera" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg max-w-3xl mx-auto">
      <h2 class="text-xl font-black text-blue-900 mb-4 uppercase">Pacientes en Espera</h2>
      <div id="listaEspera" class="space-y-2 max-h-80 overflow-y-auto text-[11px]"></div>
    </div>
  </section>

</main>

<!-- MODAL LOGIN -->
<section id="modalLogin"
         class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
  <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full border border-slate-200">
    <h3 class="text-center font-black text-slate-700 uppercase text-sm mb-4">
      üîê Acceso Privado
    </h3>
        <input type="password" id="inputPass"
           placeholder="Ingrese PIN"
           class="w-full p-3 rounded-xl border border-slate-200 mb-2 text-center text-lg font-mono">
    <button onclick="validarAcceso()"
            class="w-full bg-slate-800 text-white py-3 rounded-xl font-black uppercase text-xs mb-3">
      Entrar
    </button>
    <button onclick="recuperarPin()"
            class="w-full text-slate-400 text-[10px] uppercase font-bold hover:text-indigo-600 transition-colors">
      He olvidado mi PIN
    </button>
    <button onclick="cerrarModalLogin()"
            class="w-full mt-2 text-red-400 text-[10px] uppercase font-bold">
      Cancelar
    </button>
  </div>
</section>
<script type="module">
  import { db } from './firebase-config.js';
  import {
    collection, addDoc, query, where, getDocs, serverTimestamp,
    doc, getDoc, setDoc, updateDoc, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ========= [02] UTILIDADES Y CAT√ÅLOGOS =========
  const normalizarNombre = (n) => {
    if (!n) return "";
    return n.toLowerCase()
      .replace(/\s+/g, '')
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  };

  const CONFIG_SERVICIOS = {
    "CONSULTA GENERAL": { precio: 0, porc: 40 },
    "CONSULTA OFTALMOL√ìGICA": { precio: 0, porc: 12.5 },
    "CONSULTA CAMADA 3-4 CACHORROS": { precio: 0, porc: 40 },
    "CONSULTA CAMADA HASTA 8 CACHORROS": { precio: 0, porc: 40 },
    "CONSULTA CAMADA MAS DE 8 CACHORROS": { precio: 0, porc: 40 },
    "CONSULTA DE EMERGENCIA": { precio: 0, porc: 40 }, // NUEVO
    "ABSCESO": { precio: 0, porc: 50 },
    "ECOGRAF√çA": { precio: 0, porc: 40 },
    "COLOCACION VIA": { precio: 0, porc: 50 },
    "ADMINISTRACION MEDICINA": { precio: 0, porc: 50 },
    "TOMA DE MUESTRA SANGRE": { precio: 0, porc: 50 },
    "VACUNA SEXTUPLE": { precio: 0, porc: 50 },
    "VACUNA PUPPY": { precio: 0, porc: 50 },
    "VACUNA ANTIRR√ÅBICA": { precio: 0, porc: 50 },
    "VACUNA KC (TOS DE LAS PERRERAS)": { precio: 0, porc: 50 },
    "VACUNA TRIPLE FELINA": { precio: 0, porc: 50 },
    "VACUNA QUINTUPLE FELINA": { precio: 0, porc: 50 },
    "VACUNA BIOVETA": { precio: 0, porc: 50 },
    "HEMATOLOG√çA COMPLETA": { precio: 0, porc: 34.78 },
    "QU√çMICA SANGU√çNEA": { precio: 0, porc: 50 },
    "DESCARTE HEMOPARASITO": { precio: 0, porc: 50 },
    "DISTEMPER": { precio: 0, porc: 50 },
    "PARVOVIRUS - CORONAVIRUS": { precio: 0, porc: 50 },
    "FILARIASIS": { precio: 0, porc: 50 },
    "SIDA - LEUCEMIA": { precio: 0, porc: 50 },
    "HEMATOLOGIA + QUIMICA + HEMOPARASITOS": { precio: 0, porc: 50 },
    "EXAMEN DE HECES": { precio: 0, porc: 50 },
    "EXAMENES DE ORINA": { precio: 0, porc: 50 },
    "CITOLOGIA 1 OIDO": { precio: 0, porc: 50 },
    "CITOLOGIA 2 OIDOS": { precio: 0, porc: 50 },
    "RASPADO PIEL": { precio: 0, porc: 50 },
    "PERFIL ANEMICO": { precio: 0, porc: 17.5 },
    "CITOLOGIA FLUIDOS, SECRECIONES": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 5KG": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 15KG": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 25KG": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 35KG": { precio: 0, porc: 50 },
    "KG ADICIONAL": { precio: 0, porc: 0 },
    "DISPOSICION": { precio: 0, porc: 0 },
    "CREMACION CON CENIZAS": { precio: 0, porc: 0 },
    "REFERIDO: EXAMEN DE HECES": { precio: 0, porc: 50 },
    "REFERIDO: EXAMENES DE ORINA": { precio: 0, porc: 50 },
    "REFERIDO: CULTIVOS": { precio: 0, porc: 50 },
    "REFERIDO: DESCARTE HEMOPARASITO": { precio: 0, porc: 50 },
    "REFERIDO: DISTEMPER": { precio: 0, porc: 50 },
    "REFERIDO: PARVOVIRUS - CORONAVIRUS": { precio: 0, porc: 50 }
  };

  const insumosFijosMedicos = [
    { nombre: "Guantes de examen", costo: 0.50 },
    { nombre: "Alcohol", costo: 0.10 },
    { nombre: "Algod√≥n", costo: 0.10 },
    { nombre: "Hojas - Papeler√≠a", costo: 0.10 }
  ];

  const insumosBaseVacuna = [
    { nombre: "Jeringa 3cc", costo: 0.25 },
    { nombre: "Xeruk", costo: 0.10 },
    { nombre: "Crema", costo: 0.10 }
  ];

  const CONFIG_MEDICAMENTOS = {
  "Piroyet":           { precioCliente: 10 },
  "Enrofloxacina":     { precioCliente: 5  },
  "Sulfatrim":         { precioCliente: 5  },
  "Dexametasona":      { precioCliente: 4  },
  "Carprofen":         { precioCliente: 10 },
  "Flunixin":          { precioCliente: 5  },
  "Metadol":           { precioCliente: 5  },
  "Complejo B":        { precioCliente: 5  },
  "Suero hiperinmune": { precioClientePorMl: 10 },
  "Bromuro de hioscina": { precioCliente: 10 },
  "Fenobarbital":      { precioCliente: 5  },
  "Gastrine":          { precioCliente: 7  },
  "Ranitidina":        { precioCliente: 5  },
  "Metoclopramida":    { precioCliente: 5  },
  "Furosemina":        { precioCliente: 5  },
  "Vit K":             { precioCliente: 5  },
  "Eritrogen":         { precioCliente: 5  },
  "Aminovit":          { precioCliente: 10 },
  "Oxitetraciclina":   { precioCliente: 5  },
  "Pimobendan":        { precioCliente: 0  },
  "Ceftriaxona":       { precioCliente: 12 },
  "Adrenalina / Epin": { precioCliente: 14 },
  "Artrosan":          { precioCliente: 20 }, // 20 $ por 1 ml (1 ml x 20kg)
  "Lisavac":           { precioCliente: 5  }, // 5 $ por 1 ml (1 ml x kg)
  "Soroglobulin":      { precioCliente: 25 },
  "Infervac":          { precioCliente: 0  }
};

  const recetas = {
    "CONSULTA GENERAL": {
      precioVenta: 30,
      insumos: [{ nombre: "Crema", costo: 0.50 }]
    },
    "CONSULTA OFTALMOL√ìGICA": {
      precioVenta: 80,
      insumos: [{ nombre: "Tiras Fluoresce√≠na - Insumos", costo: 2.50 }]
    },
    "CONSULTA CAMADA 3-4 CACHORROS": {
      precioVenta: 50,
      insumos: [{ nombre: "Insumos Camada", costo: 2.00 }]
    },
    "CONSULTA CAMADA HASTA 8 CACHORROS": {
      precioVenta: 80,
      insumos: [{ nombre: "Insumos Camada Grande", costo: 4.00 }]
    },
    "CONSULTA CAMADA MAS DE 8 CACHORROS": {
      precioVenta: 100,
      insumos: [{ nombre: "Insumos Camada XL", costo: 6.00 }]
    },
    "CONSULTA DE EMERGENCIA": {      // NUEVO
      precioVenta: 40,
      insumos: [{ nombre: "Crema", costo: 0.50 }]
    },
    "ABSCESO": {
      precioVenta: 25,
      insumos: [
        { nombre: "Jelco", costo: 4.50 },
        { nombre: "Agua Oxigenada", costo: 0.50 },
        { nombre: "Compresa", costo: 0.50 },
        { nombre: "Antibiotico", costo: 0.50 },
        { nombre: "Antinflamatorio", costo: 0.50 },
        { nombre: "Sedacion", costo: 0.50 }
      ]
    },
    "ECOGRAF√çA": {
      precioVenta: 40,
      insumos: [
        { nombre: "Gel Ecogr√°fico", costo: 1.00 },
        { nombre: "Papel Absorbente", costo: 0.50 },
        { nombre: "Toall√≠n/Servilletas", costo: 0.30 }
      ]
    },
    "COLOCACION VIA": {
      precioVenta: 15,
      insumos: [
        { nombre: "Jelco", costo: 1.50 },
        { nombre: "Jeringa 5cc", costo: 0.50 },
        { nombre: "Adhesivo", costo: 0.30 },
        { nombre: "Mariposa", costo: 1.00 },
        { nombre: "Obturador", costo: 1.00 }
      ]
    },
    "ADMINISTRACION MEDICINA": {
      precioVenta: 10,
      insumos: [{ nombre: "Jeringa", costo: 0.50 }]
    },
    "TOMA DE MUESTRA SANGRE": {
      precioVenta: 10,
      insumos: [
        { nombre: "Jeringa", costo: 0.50 },
        { nombre: "Mariposa", costo: 1.00 },
        { nombre: "Tubo Morado o Naranja", costo: 1.20 }
      ]
    },
    "VACUNA SEXTUPLE": {
      precioVenta: 40,
      insumos: [{ nombre: "Vial Sextuple", costo: 8.50 }]
    },
    "VACUNA PUPPY": {
      precioVenta: 40,
      insumos: [{ nombre: "Vial Puppy", costo: 7.00 }]
    },
    "VACUNA ANTIRR√ÅBICA": {
      precioVenta: 30,
      insumos: [{ nombre: "Vial Antirr√°bica", costo: 4.00 }]
    },
    "VACUNA KC (TOS DE LAS PERRERAS)": {
      precioVenta: 45,
      insumos: [{ nombre: "Vial KC", costo: 9.00 }]
    },
    "VACUNA TRIPLE FELINA": {
      precioVenta: 45,
      insumos: [{ nombre: "Vial Triple Felina", costo: 10.00 }]
    },
    "VACUNA QUINTUPLE FELINA": {
      precioVenta: 50,
      insumos: [{ nombre: "Vial Quintuple Felina", costo: 15.00 }]
    },
    "VACUNA BIOVETA": {
      precioVenta: 60,
      insumos: [{ nombre: "Vial Bioveta", costo: 6.50 }]
    },
    "HEMATOLOG√çA COMPLETA": {
      precioVenta: 23,
      insumos: [{ nombre: "Tubo EDTA - Reactivos", costo: 4.50 }]
    },
    "QU√çMICA SANGU√çNEA": {
      precioVenta: 60,
      insumos: [{ nombre: "Tubo Seco - Reactivos Qu√≠mica", costo: 10.00 }]
    },
    "DESCARTE HEMOPARASITO": {
      precioVenta: 50,
      insumos: [{ nombre: "Test Hemopar√°sitos", costo: 9.00 }]
    },
    "DISTEMPER": {
      precioVenta: 35,
      insumos: [{ nombre: "Kit Test Distemper", costo: 11.00 }]
    },
    "PARVOVIRUS - CORONAVIRUS": {
      precioVenta: 35,
      insumos: [{ nombre: "Kit Test Parvo - Corona", costo: 12.00 }]
    },
    "FILARIASIS": {
      precioVenta: 40,
      insumos: [{ nombre: "Kit Test Filarias", costo: 11.00 }]
    },
    "SIDA - LEUCEMIA": {
      precioVenta: 40,
      insumos: [{ nombre: "Kit Test Sida - Leucemia", costo: 15.00 }]
    },
    "HEMATOLOGIA + QUIMICA + HEMOPARASITOS": {
      precioVenta: 110,
      insumos: [{ nombre: "Pack Laboratorio Completo", costo: 25.00 }]
    },
    "EXAMEN DE HECES": {
      precioVenta: 10,
      insumos: [{ nombre: "Portas - Soluci√≥n - Envase", costo: 1.50 }]
    },
    "EXAMENES DE ORINA": {
      precioVenta: 10,
      insumos: [{ nombre: "Tira Reactiva - Sedimento", costo: 2.00 }]
    },
    "CITOLOGIA 1 OIDO": {
      precioVenta: 15,
      insumos: [{ nombre: "Hisopo - Tincion", costo: 2.50 }]
    },
    "CITOLOGIA 2 OIDOS": {
      precioVenta: 20,
      insumos: [{ nombre: "Hisopos - Tinciones", costo: 4.00 }]
    },
    "RASPADO PIEL": {
      precioVenta: 10,
      insumos: [{ nombre: "Hoja Bistur√≠ - Aceite - Porta", costo: 3.00 }]
    },
    "PERFIL ANEMICO": {
      precioVenta: 25,
      insumos: [{ nombre: "Kit Anemia", costo: 8.00 }]
    },
    "CITOLOGIA FLUIDOS, SECRECIONES": {
      precioVenta: 20,
      insumos: [{ nombre: "Insumos Citolog√≠a Especial", costo: 5.00 }]
    },
    "EUTANASIA HASTA 5KG": {
      precioVenta: 80,
      insumos: [
        { nombre: "Propofol", costo: 4.00 },
        { nombre: "Xilacina", costo: 1.00 }
      ]
    },
    "EUTANASIA HASTA 15KG": {
      precioVenta: 110,
      insumos: [
        { nombre: "Propofol", costo: 7.00 },
        { nombre: "Xilacina", costo: 2.00 }
      ]
    },
    "EUTANASIA HASTA 25KG": {
      precioVenta: 140,
      insumos: [
        { nombre: "Propofol", costo: 10.00 },
        { nombre: "Xilacina", costo: 3.00 }
      ]
    },
    "EUTANASIA HASTA 35KG": {
      precioVenta: 170,
      insumos: [
        { nombre: "Propofol", costo: 15.00 },
        { nombre: "Xilacina", costo: 4.00 }
      ]
    }
  };

  // =========================================================
// [03] ESTADO
// =========================================================
const pinsDoctores = { "Darwin Sandoval": "1111", "Joan Silva": "2222" };
// Hacer doctorVerificado global en window
window.doctorVerificado = "";
let serviciosEnLista = [];
// Para no duplicar insumos base de medicamentos
let insumosBaseMedicamentoAgregados = false;

  // =========================================================
  // [15] SEGURIDAD AVANZADA DOCTORES (PIN+MASTER)
  // =========================================================
  const MASTER_KEY = "AVIPET2026";

  window.validarDoctorConMaster = async (nombreDoc, pinIngresado) => {
    if (pinIngresado === MASTER_KEY) {
      console.log(`üîì Acceso admin para: ${nombreDoc}`);
      return true;
    }
    try {
      const docRef = doc(db, "doctores", nombreDoc);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const pinReal = snap.data().pin;
        return pinIngresado === pinReal;
      } else {
        const backupPins = { "Darwin Sandoval": "1111", "Joan Silva": "2222" };
        return pinIngresado === backupPins[nombreDoc];
      }
    } catch (e) {
      console.error("Error en validaci√≥n:", e);
      return false;
    }
  };

 window.cambiarPinDoctor = async (nombreDoc) => {
  if (!nombreDoc) {
    alert("Seleccione un doctor en la lista primero.");
    return;
  }

  const pinActual = prompt(`üîê [${nombreDoc}] Ingrese PIN actual o Llave Maestra:`);
  if (!pinActual) return;

  const esValido = await window.validarDoctorConMaster(nombreDoc, pinActual);

  if (esValido) {
    const nuevoPin = prompt("üÜï Ingrese su NUEVO PIN (4 d√≠gitos):");
    if (nuevoPin && nuevoPin.length >= 4) {
      await setDoc(
        doc(db, "doctores", nombreDoc),
        { pin: nuevoPin, ultimaActualizacion: serverTimestamp() },
        { merge: true }
      );
      alert("‚úÖ PIN actualizado con √©xito.");
    } else {
      alert("‚ö†Ô∏è El PIN debe tener al menos 4 d√≠gitos.");
    }
  } else {
    alert("üö´ Validaci√≥n fallida.");
  }
};

  window.validarDoctorPerfil = async (nombreDoc, pinIngresado) => {
    if (pinIngresado === MASTER_KEY) return true;
    try {
      const snap = await getDoc(doc(db, "doctores", nombreDoc));
      if (snap.exists()) {
        return pinIngresado === snap.data().pin;
      } else {
        const defaults = { "Darwin Sandoval": "1111", "Joan Silva": "2222" };
        return pinIngresado === defaults[nombreDoc];
      }
    } catch (e) {
      return false;
    }
  };

  window.solicitarCambioPinDoctor = async () => {
  const nombreDoc = prompt("Ingrese su nombre (Darwin Sandoval / Joan Silva):");
  if (!nombreDoc) return;

  // Preguntar clave de recuperaci√≥n (llave maestra o PIN admin)
  const claveAdmin = prompt("üîê Recuperaci√≥n de PIN\nIngrese la Llave Maestra o PIN administrativo:");
  if (!claveAdmin) return;

  // 1) MASTER_KEY siempre es v√°lida
  if (claveAdmin === MASTER_KEY) {
    const nuevoPin = prompt(`Ingrese el NUEVO PIN para ${nombreDoc} (m√≠nimo 4 d√≠gitos):`);
    if (nuevoPin && nuevoPin.length >= 4) {
      await setDoc(
        doc(db, "doctores", nombreDoc),
        { pin: nuevoPin },
        { merge: true }
      );
      alert(`‚úÖ PIN de ${nombreDoc} actualizado por recuperaci√≥n (Llave Maestra).`);
    }
    return;
  }

  // 2) Tambi√©n permite usar el PIN administrativo de "configuracion/seguridad"
  try {
    const snapSeg = await getDoc(doc(db, "configuracion", "seguridad"));
    const pinAdmin = snapSeg.exists() ? (snapSeg.data().pin || "AVIPET2026") : "AVIPET2026";

    if (claveAdmin === pinAdmin) {
      const nuevoPin = prompt(`Ingrese el NUEVO PIN para ${nombreDoc} (m√≠nimo 4 d√≠gitos):`);
      if (nuevoPin && nuevoPin.length >= 4) {
        await setDoc(
          doc(db, "doctores", nombreDoc),
          { pin: nuevoPin },
          { merge: true }
        );
        alert(`‚úÖ PIN de ${nombreDoc} actualizado por administrador.`);
      }
    } else {
      alert("üö´ Clave administrativa incorrecta.");
    }
  } catch (e) {
    console.error("Error validando clave admin:", e);
    alert("‚ùå Error al validar clave administrativa.");
  }
};

  // =========================================================
// [04] VALIDAR DOCTOR
// =========================================================
window.validarAccesoDoctor = async (nombre) => {
  // Si se limpia el select (elige opci√≥n vac√≠a)
  if (!nombre) {
    window.doctorVerificado = "";
    const dPrint = document.getElementById('doctorPrint');
    if (dPrint) dPrint.innerText = "SELECCIONE DOCTOR";
    return;
  }

  // Pedir PIN o Llave Maestra
  const pinIngresado = prompt(`ACCESO RESTRINGIDO: PIN para ${nombre.toUpperCase()} (o Llave Maestra):`);
  if (!pinIngresado) {
    // Si cancela o deja vac√≠o, se revierte la selecci√≥n
    const sel = document.getElementById('selectDoctor');
    if (sel) sel.value = "";
    return;
  }

  const esValido = await window.validarDoctorConMaster(nombre, pinIngresado);

  if (esValido) {
    window.doctorVerificado = nombre;
    const prefijo = (nombre === "Joan Silva") ? "DRA. " : "DR. ";
    const dPrint = document.getElementById('doctorPrint');
    if (dPrint) dPrint.innerText = prefijo + nombre.toUpperCase();
    alert(`‚úÖ Identidad confirmada: ${prefijo}${nombre}`);
    await window.calcularTodo();
  } else {
    alert("‚ùå PIN INCORRECTO.");
    const sel = document.getElementById('selectDoctor');
    if (sel) sel.value = "";
    window.doctorVerificado = "";
    const dPrint = document.getElementById('doctorPrint');
    if (dPrint) dPrint.innerText = "SELECCIONE DOCTOR";
  }
};
  // =========================================================
  // [05] INSERTAR SERVICIO
  // =========================================================
  window.insertarServicio = async (v) => {
    if (!v) return;
    const area = document.getElementById('hTratamiento');

    let nombreFinal = v;
    let precioFinal = 0;
    let porcentajeServicio = 30;

    const vLimpio = normalizarNombre(v);

    try {
      const docRef = doc(db, "servicios_maestro", v);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        precioFinal = parseFloat(data.precioVenta) || 0;
        porcentajeServicio = parseFloat(data.porcDoc ?? data.porcentajeDoc ?? 30);
      } else {
        const llaveReceta = Object.keys(recetas).find(
          k => normalizarNombre(k) === vLimpio
        );
        const llaveConfig = Object.keys(CONFIG_SERVICIOS).find(
          k => normalizarNombre(k) === vLimpio
        );

        precioFinal = llaveReceta ? recetas[llaveReceta].precioVenta : 0;
        porcentajeServicio = llaveConfig ? CONFIG_SERVICIOS[llaveConfig].porc : 30;
      }
    } catch (e) {
      console.warn("‚ö†Ô∏è Error de conexi√≥n. Usando respaldo local con normalizaci√≥n.");
      const llaveReceta = Object.keys(recetas).find(
        k => normalizarNombre(k) === vLimpio
      );
      const llaveConfig = Object.keys(CONFIG_SERVICIOS).find(
        k => normalizarNombre(k) === vLimpio
      );
      precioFinal = llaveReceta ? recetas[llaveReceta].precioVenta : 0;
      porcentajeServicio = llaveConfig ? CONFIG_SERVICIOS[llaveConfig].porc : 30;
    }

    // Excepciones de negocio
    if (vLimpio.includes("kgadicional")) {
      const kgs = prompt("Ingrese la cantidad de KG adicionales:");
      if (kgs && !isNaN(kgs)) {
        const numKgs = parseFloat(kgs);
        nombreFinal = `KG ADICIONAL (${numKgs}kg)`;
        precioFinal = numKgs * 7;
        porcentajeServicio = 0;
      } else return;
    } else if (vLimpio === "disposicion" || vLimpio === "cremacionconcenizas") {
      const monto = prompt(`Precio pactado para ${v}:`);
      if (monto && !isNaN(monto)) {
        precioFinal = parseFloat(monto);
        porcentajeServicio = 0;
      } else return;
    } else {
      // Combos
      if (vLimpio.includes("vacunakc")) {
        const tieneOtraVacuna = serviciosEnLista.some(s => {
          const n = normalizarNombre(s);
          return n.includes("vacuna") || n.includes("sextuple") ||
                 n.includes("puppy") || n.includes("antirrabica") ||
                 n.includes("triplefelina");
        });
        if (tieneOtraVacuna) {
          precioFinal = 40;
          nombreFinal += " (Combo)";
        } else {
          precioFinal = 45;
        }
      } else if (vLimpio.includes("hematologiacompleta")) {
        const tieneOtroLab = serviciosEnLista.some(s => {
          const n = normalizarNombre(s);
          return n.includes("quimica") || n.includes("hemoparasito") ||
                 n.includes("heces") || n.includes("orina") ||
                 n.includes("perfil") || n.includes("citologia");
        });
        if (tieneOtroLab) {
          precioFinal = 20;
          nombreFinal += " (Combo)";
        } else {
          precioFinal = 23;
        }
      } else if (vLimpio.includes("vacunaantirrabica")) {
        // ANTIRR√ÅBICA: sola 30, en combo con otra vacuna 25
        const tieneOtraVacuna = serviciosEnLista.some(s => {
          const n = normalizarNombre(s);
          return n.includes("vacuna") && !n.includes("antirrabica");
        });
        if (tieneOtraVacuna) {
          precioFinal = 25;
          nombreFinal += " (Combo)";
        } else {
          precioFinal = 30;
        }
      }
    }

    const grupoID = "srv-" + Date.now();
    serviciosEnLista.push(v);
    area.value += (area.value ? "\n" : "") + "=> " + nombreFinal;

    document.getElementById('contenedorInsumos').classList.remove('hidden');
    const cuerpo = document.getElementById('listaInsumosDinamica');

    const filaTitulo = document.createElement('tr');
    filaTitulo.className =
      "bg-slate-50 border-b-2 border-slate-200 text-slate-700 font-black servicio-principal";
    filaTitulo.setAttribute('data-grupo', grupoID);
    filaTitulo.setAttribute('data-precio', precioFinal);
    filaTitulo.setAttribute('data-porc', porcentajeServicio);

    filaTitulo.innerHTML = `
      <td colspan="3" class="p-2 text-[11px] uppercase">
        üîπ ${nombreFinal} ($${precioFinal.toFixed(2)})
        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full ml-2 text-[9px] border border-blue-200">
          ${porcentajeServicio.toFixed(1)}% DOC
        </span>
      </td>
      <td class="p-2 text-center">
        <button onclick="window.eliminarServicioCompleto('${grupoID}', ${precioFinal}, event)"
                class="text-red-500 font-bold text-lg">√ó</button>
      </td>`;
    cuerpo.appendChild(filaTitulo);

    let listaNuevos = [];
    if (cuerpo.querySelectorAll('.servicio-principal').length === 1) {
      listaNuevos = [...insumosFijosMedicos];
    }
    if (vLimpio.includes("vacuna")) {
      const yaHayVacuna = Array.from(cuerpo.querySelectorAll('td'))
        .some(td => td.innerText.includes("VIAL"));
      if (!yaHayVacuna) listaNuevos = [...listaNuevos, ...insumosBaseVacuna];
    }

    const llaveRecetaIns = Object.keys(recetas).find(
      k => normalizarNombre(k) === vLimpio
    );
    if (llaveRecetaIns && recetas[llaveRecetaIns].insumos) {
      listaNuevos = [...listaNuevos, ...recetas[llaveRecetaIns].insumos];
    }

    listaNuevos.forEach(insumo => {
      const tr = document.createElement('tr');
      tr.className = `border-b border-gray-100 insumo-fila ${grupoID}`;
      tr.innerHTML = `
        <td class="p-2 font-bold text-gray-700 text-[11px] italic">
          ${insumo.nombre.toUpperCase()}
        </td>
        <td class="p-2 text-center">
          <input type="number" value="1"
                 oninput="window.calcularTodo()"
                 class="i-cant w-12 text-center border rounded">
        </td>
        <td class="p-2 text-center">
          <input type="number" value="${insumo.costo.toFixed(2)}" step="0.01"
                 oninput="window.calcularTodo()"
                 class="i-cost w-16 text-center border rounded">
        </td>
        <td class="p-2 text-center text-red-500 font-bold cursor-pointer"
            onclick="this.parentElement.remove(); window.calcularTodo()">
          ‚úï
        </td>`;
      cuerpo.appendChild(tr);
    });

    await window.calcularTodo();
    document.getElementById('selectorServicios').value = "";
  };

 window.agregarMedicamento = (nombreMed) => {
  if (!nombreMed) return;
  const cfg = CONFIG_MEDICAMENTOS[nombreMed];
  if (!cfg) return;

  let precioCliente = 0;
  let descripcion = nombreMed;

  // SUERO HIPERINMUNE: por ml
  if (nombreMed === "Suero hiperinmune") {
    const ml = prompt("Ingrese cantidad (ml) de Suero hiperinmune:");
    if (!ml || isNaN(ml) || parseFloat(ml) <= 0) {
      document.getElementById('selectorMedicamentos').value = "";
      return;
    }
    const cantMl = parseFloat(ml);
    precioCliente = (cfg.precioClientePorMl || 0) * cantMl;
    descripcion  += ` (${cantMl} ml)`;

  // ARTROSAN: 1 ml cada 20 kg
  } else if (nombreMed === "Artrosan") {
    const kg = prompt("Ingrese el peso del paciente (kg) para Artrosan (1 ml cada 20 kg):");
    if (!kg || isNaN(kg) || parseFloat(kg) <= 0) {
      document.getElementById('selectorMedicamentos').value = "";
      return;
    }
    const pesoKg = parseFloat(kg);
    const mlNecesarios = pesoKg / 20;
    precioCliente = (cfg.precioCliente || 0) * mlNecesarios;
    descripcion  += ` (${mlNecesarios.toFixed(2)} ml para ${pesoKg} kg)`;

  // LISAVAC: 1 ml por kg
  } else if (nombreMed === "Lisavac") {
    const kg = prompt("Ingrese el peso del paciente (kg) para Lisavac (1 ml por kg):");
    if (!kg || isNaN(kg) || parseFloat(kg) <= 0) {
      document.getElementById('selectorMedicamentos').value = "";
      return;
    }
    const pesoKg = parseFloat(kg);
    const mlNecesarios = pesoKg;
    precioCliente = (cfg.precioCliente || 0) * mlNecesarios;
    descripcion  += ` (${mlNecesarios.toFixed(2)} ml para ${pesoKg} kg)`;

  // RESTO: monto fijo
  } else {
    precioCliente = cfg.precioCliente || 0;
  }

  // 1) CREAR UNA FILA "SERVICIO PRINCIPAL" PARA EL MEDICAMENTO
  const cuerpo = document.getElementById('listaInsumosDinamica');
  document.getElementById('contenedorInsumos').classList.remove('hidden');

  const grupoID = "med-" + Date.now(); // id √∫nico para el medicamento

 const porcentajeServicioMedicamento = 40; // 40% doctor, 60% Avipet, igual que otras consultas

  const filaTitulo = document.createElement('tr');
  filaTitulo.className =
    "bg-slate-100 border-b-2 border-slate-300 text-slate-700 font-black servicio-principal";
  filaTitulo.setAttribute('data-grupo', grupoID);
  filaTitulo.setAttribute('data-precio', precioCliente);
  filaTitulo.setAttribute('data-porc', porcentajeServicioMedicamento);

  filaTitulo.innerHTML = `
    <td colspan="3" class="p-2 text-[11px] uppercase">
      üíä ${descripcion} ($${precioCliente.toFixed(2)})
      <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full ml-2 text-[9px] border border-purple-200">
        MEDICAMENTO
      </span>
    </td>
    <td class="p-2 text-center">
      <button onclick="window.eliminarServicioCompleto('${grupoID}', ${precioCliente}, event)"
              class="text-red-500 font-bold text-lg">√ó</button>
    </td>`;
  cuerpo.appendChild(filaTitulo);

  // 2) ANOTAR EN EL TRATAMIENTO
  const area = document.getElementById('hTratamiento');
  if (area) {
    area.value += (area.value ? "\n" : "") +
      `=> MEDICAMENTO: ${descripcion} ($${precioCliente.toFixed(2)})`;
    document.getElementById('hTratamientoPrint').innerText = area.value;
  }

  // 3) SUMAR AL MONTO TOTAL A COBRAR
  const inputVenta = document.getElementById('precioVenta');
  const montoActual = parseFloat(inputVenta.value) || 0;
  const nuevoMonto  = montoActual + precioCliente;
  inputVenta.value  = nuevoMonto.toFixed(2);

  // 4) INSUMOS BASE DE MEDICAMENTO: SOLO LA PRIMERA VEZ
  if (!insumosBaseMedicamentoAgregados) {
    const insumosMedicamento = [
      { nombre: "Jeringa para medicamento", costo: 0.50 },
      { nombre: "Algod√≥n para medicamento", costo: 0.10 },
      { nombre: "Alcohol para medicamento", costo: 0.10 }
    ];

    insumosMedicamento.forEach(insumo => {
      const tr = document.createElement('tr');
      tr.className = `border-b border-gray-100 insumo-fila bg-yellow-50 ${grupoID}`;
      tr.innerHTML = `
        <td class="p-2 font-bold text-[11px] italic">
          ‚ûï ${insumo.nombre.toUpperCase()}
        </td>
        <td class="p-2 text-center">
          <input type="number" value="1"
                 oninput="window.calcularTodo()"
                 class="i-cant w-12 text-center border rounded">
        </td>
        <td class="p-2 text-center">
          <input type="number"
                 value="${insumo.costo.toFixed(2)}"
                 step="0.01"
                 oninput="window.calcularTodo()"
                 class="i-cost w-16 text-center border rounded">
        </td>
        <td class="p-2 text-center text-red-500 font-bold cursor-pointer"
            onclick="this.parentElement.remove(); window.calcularTodo()">
          ‚úï
        </td>`;
      cuerpo.appendChild(tr);
    });

    insumosBaseMedicamentoAgregados = true;
  }

  // 5) RECALCULAR COSTOS E INGRESOS
  window.calcularTodo();

  // 6) RESET SELECTOR
  document.getElementById('selectorMedicamentos').value = "";
};
  // =========================================================
  // [06] ELIMINAR SERVICIO COMPLETO
  // =========================================================
  window.eliminarServicioCompleto = async (idGrupo, precioARestar, event) => {
    if (event) event.preventDefault();
    if (!confirm("¬øEliminar este servicio y sus insumos?")) return;

    const area = document.getElementById('hTratamiento');
    const filaTitulo = document.querySelector(`[data-grupo="${idGrupo}"]`);

    if (filaTitulo) {
      const nombreParaTexto = filaTitulo.innerText
        .split('($')[0]
        .replace('üîπ', '')
        .trim();

      if (area && area.value) {
        const lineas = area.value.split('\n');
        const lineasLimpias = lineas.filter(
          linea => !linea.includes("=> " + nombreParaTexto)
        );
        area.value = lineasLimpias.join('\n');
      }

      const nombreBorrando = normalizarNombre(filaTitulo.innerText);
      const index = serviciosEnLista.indexOf(nombreBorrando);
      if (index !== -1) serviciosEnLista.splice(index, 1);

      filaTitulo.remove();
    }

    document.querySelectorAll('.' + idGrupo).forEach(el => el.remove());

    const filasRestantes = document.querySelectorAll('.servicio-principal');

    filasRestantes.forEach(fila => {
      const texto = normalizarNombre(fila.innerText);

      if (texto.includes("vacunakc")) {
        const tieneOtraVacuna = Array.from(filasRestantes).some(f => {
          const n = normalizarNombre(f.innerText);
          return f !== fila &&
                 (n.includes("vacuna") || n.includes("sextuple") ||
                  n.includes("puppy") || n.includes("antirrabica"));
        });
        if (!tieneOtraVacuna) {
          fila.setAttribute('data-precio', 45);
          const td = fila.querySelector('td');
          if (td) {
            td.innerHTML = td.innerHTML
              .replace("40.00", "45.00")
              .replace("(Combo)", "")
              .replace("(COMBO)", "");
          }
        }
      }

      if (texto.includes("hematologiacompleta")) {
        const tieneOtroLab = Array.from(filasRestantes).some(f => {
          const n = normalizarNombre(f.innerText);
          return f !== fila &&
                 (n.includes("quimica") || n.includes("hemoparasito") ||
                  n.includes("perfil") || n.includes("examen"));
        });
        if (!tieneOtroLab) {
          fila.setAttribute('data-precio', 23);
          const td = fila.querySelector('td');
          if (td) {
            td.innerHTML = td.innerHTML
              .replace("20.00", "23.00")
              .replace("(Combo)", "")
              .replace("(COMBO)", "");
          }
        }
      }
      // NUEVO: Recalcular VACUNA ANTIRR√ÅBICA cuando se elimina alg√∫n servicio
      if (texto.includes("vacunaantirrabica")) {
        // Ver si todav√≠a existe alguna OTRA vacuna (distinta de la antirr√°bica)
        const tieneOtraVacuna = Array.from(filasRestantes).some(f => {
          if (f === fila) return false;
          const n = normalizarNombre(f.innerText);
          return n.includes("vacuna") && !n.includes("antirrabica");
        });

        // Si ya NO hay otra vacuna, la antirr√°bica debe volver a su precio normal: 30
        if (!tieneOtraVacuna) {
          fila.setAttribute('data-precio', 30);
          const td = fila.querySelector('td');
          if (td) {
            td.innerHTML = td.innerHTML
              .replace("25.00", "30.00")
              .replace("(Combo)", "")
              .replace("(COMBO)", "");
          }
        }
      }
    });

    const inputPrecioVenta = document.getElementById('precioVenta');
    if (inputPrecioVenta) {
      let nuevoTotalVenta = 0;
      document.querySelectorAll('.servicio-principal').forEach(f => {
        nuevoTotalVenta += parseFloat(f.getAttribute('data-precio')) || 0;
      });
      inputPrecioVenta.value = nuevoTotalVenta.toFixed(2);
    }

    await window.calcularTodo();
  };

  window.agregarInsumoManual = () => {
    const n = document.getElementById('nombreExtra');
    const c = document.getElementById('costoExtra');
    if (!n.value) return alert("Ingrese nombre del insumo.");

    const todasLasFilas = document.querySelectorAll('.servicio-principal');
    const ultimoGrupo =
      todasLasFilas.length > 0
        ? todasLasFilas[todasLasFilas.length - 1].getAttribute('data-grupo')
        : "manual";

    const tr = document.createElement('tr');
    tr.className =
      `border-b border-gray-100 insumo-fila bg-yellow-50 ${ultimoGrupo}`;
    tr.innerHTML = `
      <td class="p-2 font-bold text-[11px] italic">
        ‚ûï ${n.value.toUpperCase()}
      </td>
      <td class="p-2 text-center">
        <input type="number" value="1"
               oninput="window.calcularTodo()"
               class="i-cant w-12 text-center border rounded">
      </td>
      <td class="p-2 text-center">
        <input type="number"
               value="${parseFloat(c.value || 0).toFixed(2)}"
               step="0.01"
               oninput="window.calcularTodo()"
               class="i-cost w-16 text-center border rounded">
      </td>
      <td class="p-2 text-center text-red-500 font-bold cursor-pointer"
          onclick="this.parentElement.remove(); window.calcularTodo()">
        ‚úï
      </td>`;
    document.getElementById('listaInsumosDinamica').appendChild(tr);
    n.value = "";
    c.value = "";
    window.calcularTodo();
  };

  // =========================================================
  // [08] MOTOR FINANCIERO
  // =========================================================
  window.calcularTodo = async () => {
    let totalComisionDoctores = 0;
    let totalGastosInsumos = 0;
    let totalVentaCalculada = 0;

    if (window.porcGlobalCache === undefined) {
      try {
        const cfgSnap = await getDoc(doc(db, "configuracion", "tarifas"));
        window.porcGlobalCache = cfgSnap.exists()
          ? (cfgSnap.data().porcDoc ?? cfgSnap.data().porcentajeDoc)
          : null;
      } catch (e) {
        window.porcGlobalCache = null;
      }
    }

    const filasServicios = document.querySelectorAll('.servicio-principal');
    filasServicios.forEach(fila => {
      const precioServicio = parseFloat(fila.getAttribute('data-precio')) || 0;
      const porcServicioDefault = parseFloat(fila.getAttribute('data-porc')) || 0;

      const porcAEfectuar =
        (window.porcGlobalCache !== null && window.porcGlobalCache !== undefined)
          ? window.porcGlobalCache
          : porcServicioDefault;

      totalVentaCalculada += precioServicio;

      const grupoID = fila.getAttribute('data-grupo');
      let gastosGrupo = 0;

      document.querySelectorAll(`.${grupoID}.insumo-fila`).forEach(insumo => {
        const cant = parseFloat(insumo.querySelector('.i-cant').value) || 0;
        const cost = parseFloat(insumo.querySelector('.i-cost').value) || 0;
        gastosGrupo += (cant * cost);
      });

      totalGastosInsumos += gastosGrupo;

      const utilidadNetaServicio = precioServicio - gastosGrupo;
      if (utilidadNetaServicio > 0) {
        totalComisionDoctores +=
          (utilidadNetaServicio * (porcAEfectuar / 100));
      }
    });

    const inputVenta = document.getElementById('precioVenta');
    if (inputVenta) inputVenta.value = totalVentaCalculada.toFixed(2);

    const inputGasto = document.getElementById('gastoInsumos');
    if (inputGasto) inputGasto.value = totalGastosInsumos.toFixed(2);

    const displayDr = document.getElementById('montoDoctor');
    if (displayDr) {
      displayDr.innerText = `$ ${totalComisionDoctores.toFixed(2)}`;
    }

    console.log(
      `‚úÖ Combo Calculado: Bruto $${totalVentaCalculada} | Insumos $${totalGastosInsumos} | Dr $${totalComisionDoctores.toFixed(2)}`
    );
  };

  // =========================================================
  // [09] BUSCADOR
  // =========================================================
  window.buscarPorCedula = async () => {
    const input = document.getElementById('searchCI');
    const contenedor = document.getElementById('resultadosBusqueda');

    if (!input.value || !input.value.trim()) {
      alert("‚ö†Ô∏è Ingrese una c√©dula.");
      return;
    }
    const ci = input.value.trim();
    contenedor.innerHTML =
      `<div class="text-center py-8">
         <div class="animate-spin h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
         <p>Buscando...</p>
       </div>`;

    try {
      const q = query(
        collection(db, "consultas"),
        where("cedula", "==", ci),
        orderBy("fecha", "desc")
      );
      const snap = await getDocs(q);

      if (snap.empty) {
        contenedor.innerHTML =
          `<p class="p-6 text-center">No hay registros para: ${ci}</p>`;
        return;
      }
      contenedor.innerHTML = "";

      snap.forEach(docSnap => {
        const d = docSnap.data();
        const div = document.createElement('div');
        div.className =
          "mb-4 border-2 border-slate-200 bg-white rounded-xl overflow-hidden";

        const drPref = (d.doctor === "Joan Silva") ? "Dra." : "Dr.";

        const insHtml = d.listaDetalladaInsumos
          ? d.listaDetalladaInsumos.map(ins => {
              const precioIns = parseFloat(ins.precio ?? ins.costo ?? 0)
                .toFixed(2);
              return `
                <div class="flex justify-between text-[11px] border-b border-dotted">
                  <span>${ins.nombre} x${ins.cant}</span>
                  <b>$${precioIns}</b>
                </div>`;
            }).join('')
          : "";

        div.innerHTML = `
          <details class="group">
            <summary class="flex justify-between p-4 cursor-pointer">
              <div>
                <span class="text-[10px] text-slate-400 font-bold">
                  ${d.fechaSimple || 'S/F'}
                </span>
                <h3 class="font-black text-blue-900 uppercase">${d.paciente}</h3>
                <p class="text-[10px] uppercase">${drPref} ${d.doctor}</p>
              </div>
              <div class="text-blue-500 text-xl group-open:rotate-180 transition-transform">‚ñæ</div>
            </summary>
            <div class="p-4 bg-slate-50 border-t border-slate-200">
              <p class="text-[10px] font-bold text-blue-600 border-b mb-1">
                TRATAMIENTO:
              </p>
              <p class="text-sm text-slate-700 whitespace-pre-wrap mb-4">
                ${d.tratamiento}
              </p>
              <p class="text-[10px] font-bold text-emerald-600 border-b mb-1">
                INSUMOS:
              </p>
              <div class="space-y-1">
                ${insHtml}
              </div>
              <div class="mt-4 pt-3 border-t-2 flex justify-between">
                <span class="text-[10px] font-bold">TOTAL:</span>
                <span class="text-xl font-black">
                  $${(d.montoVenta || 0).toFixed(2)}
                </span>
              </div>
            </div>
          </details>`;
        contenedor.appendChild(div);
      });
    } catch (e) {
      console.error("Error en b√∫squeda:", e);
    }
  };

  // =========================================================
  // [10] AUTOCOMPLETAR POR C√âDULA
  // =========================================================
 window.autocompletarPorCedula = async (ci) => {
  if (!ci) return;
  try {
    const q = query(collection(db, "consultas"), where("cedula", "==", ci.trim()));
    const snap = await getDocs(q);
    if (!snap.empty) {
      const registros = [];
      snap.forEach(docSnap => registros.push(docSnap.data()));
      registros.sort(
        (a, b) => (b.fecha?.seconds || 0) - (a.fecha?.seconds || 0)
      );
      const d = registros[0];

      console.log("Registro usado para autocompletar:", d); // <-- SOLO ESTO NUEVO

      const inputProp = document.getElementById('hProp');
      if (inputProp) {
        inputProp.value = d.propietario || "";
        if (d.alerta === true) {
          inputProp.style.color = "#b91c1c";
          inputProp.style.fontWeight = "bold";
          const chk = document.getElementById('hAlerta');
          if (chk) chk.checked = true;
          alert("‚ö†Ô∏è NOTA: Este cliente tiene una restricci√≥n administrativa.");
        } else {
          inputProp.style.color = "";
          inputProp.style.fontWeight = "";
          const chk = document.getElementById('hAlerta');
          if (chk) chk.checked = false;
        }
      }
      document.getElementById('hMail').value    = d.correo    || "";
      document.getElementById('hTlf').value     = d.telefono  || "";
      document.getElementById('hDir').value     = d.direccion || "";
      document.getElementById('hNombre').value  = d.paciente  || "";
      document.getElementById('hRaza').value    = d.raza      || "";
      document.getElementById('hEspecie').value = d.especie   || "";
      document.getElementById('hEdad').value    = d.edad      || "";
      document.getElementById('hSexo').value    = d.sexo      || "";
      document.getElementById('hPeso').value    = d.peso      || "";
      const hColor = document.getElementById('hColor');
      if (hColor) hColor.value = d.color || "";
    }
  } catch (e) {
    console.error(e);
  }
};

  // =========================================================
  // [23] RECEPCI√ìN: ENVIAR A COLA DE ESPERA
  // =========================================================
  window.enviarAColaEspera = async () => {
    try {
      const dVal = (id) => document.getElementById(id)?.value.trim() || "";

      const dataEspera = {
        cedula: dVal('hCI'),
        propietario: dVal('hProp'),
        paciente: dVal('hNombre'),
        especie: dVal('hEspecie'),
        raza: dVal('hRaza'),
        edad: dVal('hEdad'),
        sexo: dVal('hSexo'),
        peso: dVal('hPeso'),
        telefono: dVal('hTlf'),
        correo: dVal('hMail'),
        direccion: dVal('hDir'),
        color: dVal('hColor'), // NUEVO
        fechaIngreso: serverTimestamp(),
        fechaSimple: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`,
        estado: "en_espera"
      };

      if (!dataEspera.cedula || !dataEspera.paciente || !dataEspera.propietario) {
        alert("‚ö†Ô∏è C√©dula, Propietario y Paciente son obligatorios para enviar a espera.");
        return;
      }

      await addDoc(collection(db, "espera"), dataEspera);
      alert("‚úÖ Paciente enviado a cola de espera.");
    } catch (e) {
      console.error("Error enviando a espera:", e);
      alert("‚ùå Error al enviar a espera: " + e.message);
    }
  };

  // =========================================================
  // [11] REPORTE / CAJA
  // =========================================================
  window.cargarReporte = async () => {
    const listaDiv = document.getElementById('listaReporte');
    const netoDiv = document.getElementById('repNeto');
    if (!listaDiv) return;

    listaDiv.innerHTML =
      "<p class='text-center animate-pulse py-4 font-bold text-slate-400'>üîÑ SINCRONIZANDO CAJA...</p>";

    try {
      const querySnapshot = await getDocs(collection(db, "consultas"));
      listaDiv.innerHTML = "";

      let bruto = 0, gastos = 0, netoAvipet = 0, contador = 0;
      let sandovalTotal = 0, silvaTotal = 0;

      const hoy =
        `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`;

      querySnapshot.forEach(docSnap => {
        const d = docSnap.data();
        if (d.fechaSimple === hoy) {
          const pVenta = parseFloat(d.montoVenta) || 0;
          const pGasto = parseFloat(d.montoInsumos) || 0;
          const pagoRealDoc = parseFloat(d.pagoDoctor) || 0;

          bruto += pVenta;
          gastos += pGasto;

          let colorBorde = "border-l-slate-400";
          if (d.doctor && d.doctor.includes("Darwin Sandoval")) {
            sandovalTotal += pagoRealDoc;
            colorBorde = "border-l-blue-500";
          } else if (d.doctor && d.doctor.includes("Joan Silva")) {
            silvaTotal += pagoRealDoc;
            colorBorde = "border-l-emerald-500";
          }

          netoAvipet += (pVenta - pGasto - pagoRealDoc);
          contador++;

          listaDiv.innerHTML += `
            <div class="py-3 border-b flex justify-between items-center bg-white px-3 mb-2 rounded-xl shadow-sm border-l-4 ${colorBorde}">
              <div>
                <p class="font-black text-[11px] uppercase text-slate-700">
                  ${d.paciente}
                </p>
                <p class="text-[9px] font-bold text-slate-400 uppercase">
                  ü©∫ ${d.doctor}
                </p>
              </div>
              <div class="text-right">
                <p class="font-black text-[12px] text-slate-800">
                  $${pVenta.toFixed(2)}
                </p>
                <p class="text-[8px] font-bold text-blue-600">
                  Comisi√≥n: $${pagoRealDoc.toFixed(2)}
                </p>
              </div>
            </div>`;
        }
      });

      document.getElementById('totalPacientes').innerText = contador;
      document.getElementById('repBruto').innerText = `$${bruto.toFixed(2)}`;
      document.getElementById('repGastos').innerText = `$${gastos.toFixed(2)}`;
      document.getElementById('repDocSandoval').innerText = `$${sandovalTotal.toFixed(2)}`;
      document.getElementById('repDocSilva').innerText = `$${silvaTotal.toFixed(2)}`;

      if (netoDiv) {
        netoDiv.innerText = `$${netoAvipet.toFixed(2)}`;
        netoDiv.className =
          netoAvipet > 0
            ? "text-3xl font-black text-emerald-700 font-mono"
            : "text-3xl font-black text-orange-600 font-mono";
      }

      if (contador === 0) {
        listaDiv.innerHTML =
          "<p class='text-center py-4 text-slate-400 font-bold uppercase text-[10px]'>No hay consultas registradas hoy</p>";
      }
    } catch (e) {
      console.error("Error al cargar reporte:", e);
      listaDiv.innerHTML =
        "<p class='text-center text-red-500 font-bold'>Error de conexi√≥n</p>";
    }
  };
  // =========================================================
  // [12] PANEL DE CONTROL: SERVICIOS E INSUMOS
  // =========================================================
  window.cambiarSubTabConfig = (tab) => {
    const isServ = tab === 'servicios';

    const divServ = document.getElementById('contenedorTabServicios');
    const divIns = document.getElementById('contenedorTabInsumos');
    const areaBtnAgregar = document.getElementById('areaBtnAgregarInsumo');
    const bannerSincro = document.getElementById('bannerSincro');

    if (divServ && divIns) {
      divServ.classList.toggle('hidden', !isServ);
      divIns.classList.toggle('hidden', isServ);
    }
    if (areaBtnAgregar) areaBtnAgregar.classList.toggle('hidden', isServ);
    if (bannerSincro) bannerSincro.classList.toggle('hidden', !isServ);

    const btnServ = document.getElementById('btnTabServ');
    const btnIns = document.getElementById('btnTabIns');

    if (isServ) {
      if (btnServ) {
        btnServ.className =
          "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-blue-600 shadow-sm";
      }
      if (btnIns) {
        btnIns.className =
          "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg.white/50";
      }
      if (typeof window.renderizarTablaMaestra === 'function') {
        window.renderizarTablaMaestra();
      }
    } else {
      if (btnIns) {
        btnIns.className =
          "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-emerald-600 shadow-sm";
      }
      if (btnServ) {
        btnServ.className =
          "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg.white/50";
      }
      if (typeof window.renderizarTablaInsumos === 'function') {
        window.renderizarTablaInsumos();
      }
    }
  };

  window.renderizarTablaMaestra = async () => {
    const tabla = document.getElementById('tablaMaestraServicios');
    if (!tabla) {
      console.error("‚ùå Error: No se encontr√≥ 'tablaMaestraServicios'.");
      return;
    }

    tabla.innerHTML =
      "<tr><td colspan='4' class='p-4 text-center animate-pulse text-blue-500 font-bold'>‚è≥ Conectando con la nube...</td></tr>";

    try {
      const querySnapshot = await getDocs(collection(db, "servicios_maestro"));

      if (querySnapshot.empty) {
        tabla.innerHTML =
          "<tr><td colspan='4' class='p-4 text-center text-orange-500 font-bold'>‚ö†Ô∏è La base de datos est√° vac√≠a en Firebase.</td></tr>";
        return;
      }

      tabla.innerHTML = "";

      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const safeID = id.replace(/\s+/g, '_');

        const tr = document.createElement('tr');
        tr.className = "border-b hover:bg-slate-50 transition-colors";
        tr.innerHTML = `
          <td class="p-3 font-bold uppercase text-slate-700 text-[11px]">
            ${id}
          </td>
          <td class="p-3">
            <input type="number" id="precio-${safeID}"
                   value="${data.precioVenta || 0}" step="0.01"
                   class="w-full border border-slate-200 rounded p-1 text-center font-bold text-blue-600 focus:border-blue-400 outline-none">
          </td>
          <td class="p-3">
            <input type="number" id="porc-${safeID}"
                   value="${data.porcDoc ?? data.porcentajeDoc ?? 30}" step="0.1"
                   class="w-full border border-slate-200 rounded p-1 text-center font-bold text-orange-600 focus:border-orange-400 outline-none">
          </td>
          <td class="p-3 text-center">
            <button onclick="window.actualizarPrecioIndividual('${id}', '${safeID}')"
                    class="bg-blue-600 text-white px-4 py-1 rounded shadow hover:bg-emerald-600 transition-all text-[10px] font-black uppercase">
              üíæ Guardar
            </button>
          </td>`;
        tabla.appendChild(tr);
      });

      console.log("‚úÖ Renderizaci√≥n completa de servicios.");
    } catch (e) {
      console.error("‚ùå Error al renderizar tabla:", e);
      tabla.innerHTML =
        `<tr><td colspan='4' class='p-4 text-center text-red-500'>Error: ${e.message}</td></tr>`;
    }
  };

  window.actualizarPrecioIndividual = async (idOriginal, safeID) => {
    const inputPrecio = document.getElementById(`precio-${safeID}`);
    const inputPorc   = document.getElementById(`porc-${safeID}`);

    if (!inputPrecio || !inputPorc) {
      console.error("No se encontraron inputs para:", idOriginal, safeID);
      return;
    }

    const nuevoPrecio = parseFloat(inputPrecio.value);
    const nuevoPorc   = parseFloat(inputPorc.value);

    if (isNaN(nuevoPrecio) || isNaN(nuevoPorc)) {
      alert("‚ö†Ô∏è Valores no v√°lidos");
      return;
    }

    const btn = window.event ? window.event.currentTarget : null;

    try {
      await setDoc(
        doc(db, "servicios_maestro", idOriginal),
        { precioVenta: nuevoPrecio, porcDoc: nuevoPorc },
        { merge: true }
      );

      if (recetas[idOriginal]) recetas[idOriginal].precioVenta = nuevoPrecio;
      if (CONFIG_SERVICIOS[idOriginal]) CONFIG_SERVICIOS[idOriginal].porc = nuevoPorc;

      console.log(`Sincronizaci√≥n exitosa: ${idOriginal}`);

      if (btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚úÖ OK";
        btn.disabled = true;
        btn.classList.replace('bg-blue-600', 'bg-emerald-500');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
          btn.classList.replace('bg-emerald-500', 'bg-blue-600');
        }, 2000);
      }
    } catch (e) {
      console.error("Error Firebase:", e);
      alert("‚ùå Error al guardar: " + e.message);
    }
  };

  window.inicializarBaseDeDatosCompleta = async () => {
    if (!confirm("‚ö†Ô∏è Esto sobrescribir√° los precios en la nube con los del c√≥digo. ¬øContinuar?")) return;

    try {
      for (const [nombre, data] of Object.entries(recetas)) {
        const porc = CONFIG_SERVICIOS[nombre]
          ? CONFIG_SERVICIOS[nombre].porc
          : 30;
        await setDoc(
          doc(db, "servicios_maestro", nombre),
          { precioVenta: data.precioVenta, porcDoc: porc },
          { merge: true }
        );
      }

      const todosLosInsumos = [...insumosFijosMedicos, ...insumosBaseVacuna];
      for (const ins of todosLosInsumos) {
        await setDoc(
          doc(db, "insumos_maestro", ins.nombre),
          { costo: ins.costo },
          { merge: true }
        );
      }

      alert("üöÄ Sincronizaci√≥n Completa. Ahora puedes editar desde las tablas.");
      window.renderizarTablaMaestra();
    } catch (e) {
      alert("Error: " + e.message);
    }
  };

  window.renderizarTablaInsumos = async () => {
    const tabla = document.getElementById('tablaMaestraInsumos');
    if (!tabla) {
      console.error("‚ùå No encontr√© 'tablaMaestraInsumos'");
      return;
    }

    tabla.innerHTML =
      '<tr><td colspan="4" class="p-4 text-center text-emerald-600 font-bold animate-pulse text-[10px]">üîÑ CARGANDO INSUMOS...</td></tr>';

    try {
      const querySnapshot = await getDocs(collection(db, "insumos_maestro"));

      if (querySnapshot.empty) {
        tabla.innerHTML =
          '<tr><td colspan="4" class="p-4 text-center text-orange-500 font-bold text-[10px]">‚ö†Ô∏è NO HAY DATOS. AGREGA UNO NUEVO.</td></tr>';
        return;
      }

      tabla.innerHTML = "";

      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;

        const tr = document.createElement('tr');
        tr.className = "border-b hover:bg-emerald-50 transition";
        tr.innerHTML = `
          <td class="p-3 font-bold uppercase text-slate-700 text-[11px]">
            ${id}
          </td>
          <td class="p-3">
            <div class="flex items-center justify-center gap-1">
              <span class="text-slate-400 font-bold">$</span>
              <input type="number" id="costo-${id}" value="${data.costo || 0}" step="0.01"
                     class="w-20 border rounded px-2 py-1 text-center font-black text-emerald-700 bg-white border-emerald-200">
            </div>
          </td>
          <td class="p-3 text-center">
            <div class="flex justify-center gap-2">
              <button onclick="window.actualizarCostoInsumo('${id}')"
                      title="Guardar cambios"
                      class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-[10px] font-black shadow-sm transition-all active:scale-90">
                üíæ
              </button>
              <button onclick="window.eliminarInsumoIndividual('${id}')"
                      title="Eliminar insumo"
                      class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black shadow-sm transition-all active:scale-90">
                üóëÔ∏è
              </button>
            </div>
          </td>`;
        tabla.appendChild(tr);
      });
    } catch (error) {
      console.error("Error al cargar insumos:", error);
      tabla.innerHTML =
        `<tr><td colspan="4" class="p-4 text-center text-red-500 text-[10px]">‚ùå ERROR: ${error.message}</td></tr>`;
    }
  };

  window.actualizarCostoInsumo = async (idInsumo) => {
    const input = document.getElementById(`costo-${idInsumo}`);
    if (!input) return;
    const nuevoCosto = parseFloat(input.value);

    if (isNaN(nuevoCosto)) {
      alert("‚ö†Ô∏è Costo inv√°lido");
      return;
    }

    try {
      const docRef = doc(db, "insumos_maestro", idInsumo);
      await updateDoc(docRef, { costo: nuevoCosto });

      console.log(`‚úÖ ${idInsumo} actualizado en la nube a $${nuevoCosto}`);
      alert(`‚úÖ ${idInsumo} actualizado y sincronizado.`);
    } catch (e) {
      console.error("Error al actualizar:", e);
      alert("‚ùå Error al actualizar: " + e.message);
    }
  };

  window.eliminarInsumoIndividual = async (idInsumo) => {
    if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de eliminar "${idInsumo}" de la lista?`)) return;

    try {
      const { deleteDoc, doc: dDoc } =
        await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

      console.log(`üóëÔ∏è Eliminando de la nube: ${idInsumo}...`);
      await deleteDoc(dDoc(db, "insumos_maestro", idInsumo));

      console.log(`‚úÖ Insumo "${idInsumo}" eliminado.`);
      await window.renderizarTablaInsumos();
    } catch (e) {
      console.error("‚ùå Error al eliminar:", e);
      alert("Error de conexi√≥n: " + e.message);
    }
  };

  // =========================================================
// [16] GUARDAR CONSULTA EN FIREBASE
// =========================================================
window.guardarFirebase = async (imp) => {
  const selectorDoc = document.getElementById('selectDoctor');
  const nombreDoctor = selectorDoc ? selectorDoc.value : "";

  if (!nombreDoctor) {
    alert("‚ö†Ô∏è Por favor, seleccione un doctor para firmar la consulta.");
    return;
  }

  const pinIngresado = prompt(
    `üîê Firma M√©dica: Dr(a). ${nombreDoctor}\nIngrese su PIN o Llave Maestra para autorizar:`
  );
  if (!pinIngresado) return;

  const esValido = await window.validarDoctorConMaster(nombreDoctor, pinIngresado);

  if (esValido) {
    window.doctorVerificado = nombreDoctor;
    console.log("‚úÖ Firma validada correctamente.");
  } else {
    alert("‚ùå PIN incorrecto. No se puede guardar la consulta sin firma v√°lida.");
    return;
  }

  if (!window.doctorVerificado) {
    alert("‚ö†Ô∏è Error: Requiere firma del doctor.");
    return;
  }

  try {
    const configSnap = await getDoc(doc(db, "configuracion", "tarifas"));
    let porcGlobal =
      (configSnap.exists() && (configSnap.data().porcentajeDoc ?? configSnap.data().porcDoc) > 0)
        ? (configSnap.data().porcentajeDoc ?? configSnap.data().porcDoc)
        : null;

    const dInput = (id) => document.getElementById(id).value.trim();
    const montoVentaTotal =
      parseFloat(document.getElementById('precioVenta').value) || 0;

    const detalleInsumos = [];
    let totalGastos = 0;
    let pagoDoctorTotal = 0;

    const serviciosPrincipales = document.querySelectorAll('.servicio-principal');

    serviciosPrincipales.forEach(fila => {
      const grupoID = fila.getAttribute('data-grupo');
      const precioServicio = parseFloat(fila.getAttribute('data-precio')) || 0;

      const porcServicio = parseFloat(fila.getAttribute('data-porc')) || 0;
      const pEfect = (porcGlobal !== null) ? porcGlobal : porcServicio;

      let gastosEsteServicio = 0;

      document.querySelectorAll(`.${grupoID}.insumo-fila`).forEach(insumoFila => {
        const nombre = insumoFila.cells[0].innerText
          .replace('‚ûï ', '')
          .replace('üîπ ', '')
          .trim();
        const cant = parseFloat(insumoFila.querySelector('.i-cant').value) || 0;
        const costoUnidad =
          parseFloat(insumoFila.querySelector('.i-cost').value) || 0;
        const subtotalInsumo = cant * costoUnidad;

        gastosEsteServicio += subtotalInsumo;

        detalleInsumos.push({
          nombre,
          cant,
          costo: costoUnidad
        });
      });

      totalGastos += gastosEsteServicio;
      pagoDoctorTotal +=
        (Math.max(0, precioServicio - gastosEsteServicio) * (pEfect / 100));
    });

    const dataConsulta = {
      cedula: dInput('hCI'),
      propietario: dInput('hProp'),
      paciente: dInput('hNombre'),
      doctor: window.doctorVerificado,
      tratamiento: dInput('hTratamiento'),
      montoVenta: montoVentaTotal,
      montoInsumos: totalGastos,
      costoInsumosTotal: totalGastos,
      pagoDoctor: pagoDoctorTotal,
      pagoAvipet: (montoVentaTotal - totalGastos - pagoDoctorTotal),
      listaDetalladaInsumos: detalleInsumos,
      fecha: serverTimestamp(),
      fechaSimple: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`,
      alerta: !!document.getElementById('hAlerta')?.checked,
      color: dInput('hColor'),

      // NUEVO: guardar todos los datos que luego quieres autocompletar
      telefono: dInput('hTlf'),
      correo: dInput('hMail'),
      direccion: dInput('hDir'),
      especie: dInput('hEspecie'),
      raza: dInput('hRaza'),
      edad: dInput('hEdad'),
      sexo: dInput('hSexo'),
      peso: dInput('hPeso')
    };

    await addDoc(collection(db, "consultas"), dataConsulta);

    // EXPORTAR HISTORIAL AUTOM√ÅTICAMENTE DESPU√âS DE GUARDAR
    console.log("DEBUG: voy a llamar a exportarHistorialAExcel, doctorVerificado =", window.doctorVerificado);
    if (typeof window.exportarHistorialAExcel === 'function') {
      window.exportarHistorialAExcel();
    }

    if (imp) {
      const tArea = document.getElementById('hTratamientoPrint');
      if (tArea) tArea.innerText = dInput('hTratamiento');
      alert("‚úÖ Consulta guardada y lista para imprimir.");
      setTimeout(() => {
        window.print();
        // NO recargamos para no interrumpir descargas
      }, 600);
    } else {
      alert("‚úÖ Consulta guardada exitosamente.");
      // NO recargamos para no interrumpir descargas
    }
  } catch (e) {
    console.error("Error al guardar:", e);
    alert("‚ùå Error cr√≠tico al guardar: " + e.message);
  }
};
  // =========================================================
  // [17] SEGURIDAD: MODAL ADMIN
  // =========================================================
  let tabPendiente = '';

  window.validarAcceso = async () => {
    const pass = document.getElementById('inputPass').value;
    try {
      const snap = await getDoc(doc(db, "configuracion", "seguridad"));
      const pinActual = snap.exists() ? snap.data().pin : "AVIPET2026";

      if (pass === pinActual || pass === MASTER_KEY) {
        window.cerrarModalLogin();
        window.ejecutarCambioDeTab(tabPendiente);
      } else {
        alert("üö´ PIN Incorrecto.");
      }
    } catch (e) {
      console.error("Error seguridad:", e);
    }
    document.getElementById('inputPass').value = "";
  };

  window.recuperarPin = async () => {
    const respuesta =
      prompt("üõ†Ô∏è RECUPERACI√ìN DE ACCESO\n¬øCu√°l es el nombre de la cl√≠nica?");
    if (respuesta && respuesta.toUpperCase().trim() === "AVIPET") {
      const nuevoPin = prompt("‚úÖ Confirmado. Ingrese nuevo PIN administrativo:");
      if (nuevoPin && nuevoPin.length >= 4) {
        await setDoc(
          doc(db, "configuracion", "seguridad"),
          { pin: nuevoPin },
          { merge: true }
        );
        alert("üîí PIN administrativo actualizado.");
      }
    } else {
      alert("üö´ Respuesta incorrecta.");
    }
  };

  window.cerrarModalLogin = () => {
    document.getElementById('modalLogin').classList.add('hidden');
    document.getElementById('inputPass').value = "";
  };

  // =========================================================
  // [18] NAVEGACI√ìN TABS
  // =========================================================
  window.showTab = async (t) => {
    if (t === 'config_precios' || t === 'reporte') {
      tabPendiente = t;
      document.getElementById('modalLogin').classList.remove('hidden');
      return;
    }
    window.ejecutarCambioDeTab(t);
  };

  window.ejecutarCambioDeTab = async (t) => {
    document.getElementById('sectionHistoria').classList.toggle('hidden', t !== 'historia');
    document.getElementById('sectionBuscador').classList.toggle('hidden', t !== 'buscador');
    document.getElementById('sectionReporte').classList.toggle('hidden', t !== 'reporte');
    document.getElementById('sectionEspera')?.classList.toggle('hidden', t !== 'espera');

    const sectionConfig = document.getElementById('sectionConfigPrecios');
    if (sectionConfig) {
      sectionConfig.classList.toggle('hidden', t !== 'config_precios');
    }

    const tabH = document.getElementById('tabH');
    const tabB = document.getElementById('tabB');
    const tabR = document.getElementById('tabR');
    const tabE = document.getElementById('tabE');

    if (tabH) tabH.classList.toggle('tab-active', t === 'historia');
    if (tabB) tabB.classList.toggle('tab-active', t === 'buscador');
    if (tabR) tabR.classList.toggle('tab-active', t === 'reporte');
    if (tabE) tabE.classList.toggle('tab-active', t === 'espera');

    if (t === 'reporte') window.cargarReporte();
    if (t === 'espera') window.cargarListaEspera();
    if (t === 'config_precios') {
      if (typeof window.cambiarSubTabConfig === 'function') {
        window.cambiarSubTabConfig('servicios');
      }
    }
  };

  // =========================================================
  // [24] DOCTOR: VER Y ABRIR COLA DE ESPERA
  // =========================================================
  window.cargarListaEspera = async () => {
    const cont = document.getElementById('listaEspera');
    if (!cont) return;
    cont.innerHTML = "<p class='text-center text-slate-400 text-[10px]'>Cargando cola...</p>";

    try {
      const snap = await getDocs(collection(db, "espera"));
      let items = [];
      snap.forEach(docSnap => {
        const d = docSnap.data();
        items.push({ id: docSnap.id, ...d });
      });

      items = items
        .filter(i => i.estado === "en_espera")
        .sort((a, b) => (a.fechaIngreso?.seconds || 0) - (b.fechaIngreso?.seconds || 0));

      if (items.length === 0) {
        cont.innerHTML = "<p class='text-center text-slate-400 text-[10px]'>No hay pacientes en espera.</p>";
        return;
      }

      cont.innerHTML = "";
      items.forEach(p => {
        const div = document.createElement('div');
        div.className = "border rounded-lg p-2 bg-slate-50 flex justify-between items-center gap-2";
        div.innerHTML = `
          <div>
            <p class="font-bold uppercase text-[11px] text-slate-700">${p.paciente}</p>
            <p class="text-[9px] text-slate-500">${p.propietario} ‚Ä¢ CI: ${p.cedula}</p>
          </div>
          <div class="flex gap-2">
            <button class="bg-blue-600 text-white text-[10px] px-3 py-1 rounded font-black uppercase"
                    onclick="window.abrirPacienteDesdeEspera('${p.id}')">
              Atender
            </button>
            <button class="bg-red-500 text-white text-[10px] px-3 py-1 rounded font-black uppercase"
                    onclick="window.eliminarDeSalaEspera('${p.id}')">
              Eliminar
            </button>
          </div>
        `;
        cont.appendChild(div);
      });

    } catch (e) {
      console.error("Error cargando lista de espera:", e);
      cont.innerHTML = "<p class='text-center text-red-500 text-[10px]'>Error al cargar.</p>";
    }
  };

  window.abrirPacienteDesdeEspera = async (idEspera) => {
    try {
      const docRef = doc(db, "espera", idEspera);
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        alert("Registro no encontrado en espera.");
        return;
      }
      const d = snap.data();
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };

      set('hCI', d.cedula);
      set('hProp', d.propietario);
      set('hNombre', d.paciente);
      set('hEspecie', d.especie);
      set('hRaza', d.raza);
      set('hEdad', d.edad);
      set('hSexo', d.sexo);
      set('hPeso', d.peso);
      set('hTlf', d.telefono);
      set('hMail', d.correo);
      set('hDir', d.direccion);
      set('hColor', d.color); // NUEVO

      await updateDoc(docRef, { estado: "atendiendo", fechaAtencion: serverTimestamp() });

      showTab('historia');
      alert(`‚úÖ Paciente ${d.paciente} cargado en la historia cl√≠nica.`);
    } catch (e) {
      console.error("Error abriendo paciente desde espera:", e);
      alert("‚ùå Error al abrir paciente desde espera: " + e.message);
    }
  };

  // [24B] ELIMINAR PACIENTE DE LA SALA DE ESPERA
  window.eliminarDeSalaEspera = async (idEspera) => {
    if (!confirm("‚ö†Ô∏è ¬øEliminar este paciente de la cola de espera?")) return;
    try {
      const docRef = doc(db, "espera", idEspera);
      await updateDoc(docRef, { estado: "eliminado", fechaEliminacion: serverTimestamp() });
      alert("‚úÖ Paciente eliminado de la sala de espera.");
      window.cargarListaEspera();
    } catch (e) {
      console.error("Error eliminando de sala de espera:", e);
      alert("‚ùå No se pudo eliminar de la lista: " + e.message);
    }
  };

  // =========================================================
  // [20] AN√ÅLISIS INTELIGENTE MENSUAL
  // =========================================================
  window.generarAnalisisCompleto = async () => {
    const contAnalisis     = document.getElementById('contenedorAnalisis');
    const gridAnalisis     = document.getElementById('gridAnalisis');
    const analisisDoctores = document.getElementById('analisisDoctores');

    if (!contAnalisis || !gridAnalisis || !analisisDoctores) return;

    gridAnalisis.innerHTML     = "";
    analisisDoctores.innerHTML = "";
    contAnalisis.classList.remove('hidden');

    try {
      const hoy = new Date();
      const mes  = hoy.getMonth() + 1;
      const anio = hoy.getFullYear();

      const snap = await getDocs(collection(db, "consultas"));
      const registrosMes = [];

      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (!d.fechaSimple) return;
        const [diaStr, mesStr, anioStr] = d.fechaSimple.split('/');
        const m = parseInt(mesStr, 10);
        const y = parseInt(anioStr, 10);
        if (m === mes && y === anio) {
          registrosMes.push(d);
        }
      });

      if (registrosMes.length === 0) {
        gridAnalisis.innerHTML =
          `<div class="col-span-2 text-center text-slate-400 text-[11px] font-bold uppercase">
             No hay datos para este mes.
           </div>`;
        return;
      }

      let totalBruto        = 0;
      let totalGastos       = 0;
      let totalPagoDoctores = 0;
      let totalNeto         = 0;

      let mapaDoctores  = {};
      let mapaServicios = {};

      registrosMes.forEach(d => {
        const bruto   = parseFloat(d.montoVenta)   || 0;
        const gasto   = parseFloat(d.montoInsumos) || 0;
        const pagoDoc = parseFloat(d.pagoDoctor)   || 0;
        const neto    = bruto - gasto - pagoDoc;

        totalBruto        += bruto;
        totalGastos       += gasto;
        totalPagoDoctores += pagoDoc;
        totalNeto         += neto;

        const docName = d.doctor || "SIN DOCTOR";
        if (!mapaDoctores[docName]) {
          mapaDoctores[docName] = { bruto: 0, pacientes: 0, pago: 0 };
        }
        mapaDoctores[docName].bruto     += bruto;
        mapaDoctores[docName].pacientes += 1;
        mapaDoctores[docName].pago      += pagoDoc;

        if (d.tratamiento) {
          d.tratamiento.split('\n').forEach(linea => {
            const l = linea.trim();
            if (l.startsWith("=>") || l.startsWith("=&gt;") || l.startsWith("=&amp;gt;")) {
              const nombreServ = l
                .replace("=>", "")
                .replace("=&gt;", "")
                .replace("=&amp;gt;", "")
                .trim()
                .toUpperCase();
              if (!mapaServicios[nombreServ]) mapaServicios[nombreServ] = 0;
              mapaServicios[nombreServ] += 1;
            }
          });
        }
      });

      const margenDoctor = totalBruto > 0 ? ((totalPagoDoctores / totalBruto) * 100) : 0;
      const margenNeto   = totalBruto > 0 ? ((totalNeto / totalBruto) * 100) : 0;

      gridAnalisis.innerHTML = `
        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
          <p class="text-[9px] uppercase font-bold text-slate-400">Ventas Brutas Mes</p>
          <p class="text-xl font-black text-slate-800 font-mono">$${totalBruto.toFixed(2)}</p>
        </div>
        <div class="p-3 bg-amber-50 rounded-xl border border-amber-200">
          <p class="text-[9px] uppercase font-bold text-amber-600">Costos Operativos Mes</p>
          <p class="text-xl font-black text-amber-700 font-mono">$${totalGastos.toFixed(2)}</p>
        </div>
        <div class="p-3 bg-blue-50 rounded-xl border border-blue-200">
          <p class="text-[9px] uppercase font-bold text-blue-600">Pagos a Doctores</p>
          <p class="text-xl font-black text-blue-700 font-mono">
            $${totalPagoDoctores.toFixed(2)} (${margenDoctor.toFixed(1)}%)
          </p>
        </div>
        <div class="p-3 bg-emerald-50 rounded-xl border border-emerald-200">
          <p class="text-[9px] uppercase font-bold text-emerald-600">Utilidad Neta Mes</p>
          <p class="text-xl font-black text-emerald-700 font-mono">
            $${totalNeto.toFixed(2)} (${margenNeto.toFixed(1)}%)
          </p>
        </div>
      `;

      Object.entries(mapaDoctores).forEach(([docName, info]) => {
        const promTicket = info.pacientes > 0 ? (info.bruto / info.pacientes) : 0;
        const li = document.createElement('div');
        li.className =
          "flex justify-between items-center text-[11px] bg-white px-3 py-2 rounded-xl border border-slate-100";
        li.innerHTML = `
          <div>
            <p class="font-black text-slate-700 uppercase">${docName}</p>
            <p class="text-[9px] text-slate-400">Pacientes: ${info.pacientes}</p>
          </div>
          <div class="text-right">
            <p class="text-[10px] font-bold text-slate-500">
              Bruto: $${info.bruto.toFixed(2)}
            </p>
            <p class="text-[10px] font-bold text-blue-600">
              Comisi√≥n: $${info.pago.toFixed(2)}
            </p>
            <p class="text-[9px] text-emerald-600">
              Ticket prom.: $${promTicket.toFixed(2)}
            </p>
          </div>
        `;
        analisisDoctores.appendChild(li);
      });

      const serviciosOrdenados = Object.entries(mapaServicios)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      if (serviciosOrdenados.length > 0) {
        const divServ = document.createElement('div');
        divServ.className =
          "col-span-2 bg-white rounded-2xl border border-slate-100 p-3";
        divServ.innerHTML = `
          <p class="text-[9px] uppercase font-bold text-indigo-600 mb-2">
            Servicios Estrella del Mes
          </p>
          ${serviciosOrdenados.map(([nombre, cnt]) => `
            <div class="flex justify-between text-[10px] border-b border-dotted py-1">
              <span class="font-bold text-slate-700">${nombre}</span>
              <span class="text-slate-500">x${cnt}</span>
            </div>
          `).join('')}
        `;
        gridAnalisis.appendChild(divServ);
      }

    } catch (e) {
      console.error("Error en an√°lisis:", e);
      alert("‚ùå Error al generar an√°lisis: " + e.message);
    }
  };

  // =========================================================
  // [21] GUARDAR RESUMEN DEL D√çA EN LA NUBE
  // =========================================================
  window.guardarResumenDelDia = async () => {
    try {
      const hoy = new Date();
      const fechaSimple =
        `${hoy.getDate()}/${hoy.getMonth() + 1}/${hoy.getFullYear()}`;

      const snap = await getDocs(collection(db, "consultas"));

      let bruto = 0, gastos = 0, pagoDoctor = 0, neto = 0;
      let pacientes = 0;

      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (d.fechaSimple === fechaSimple) {
          const b = parseFloat(d.montoVenta)  || 0;
          const g = parseFloat(d.montoInsumos)|| 0;
          const p = parseFloat(d.pagoDoctor)  || 0;
          const n = b - g - p;
          bruto      += b;
          gastos     += g;
          pagoDoctor += p;
          neto       += n;
          pacientes++;
        }
      });

      const resumen = {
        fecha: serverTimestamp(),
        fechaSimple,
        pacientes,
        bruto,
        gastos,
        pagoDoctor,
        neto
      };

      await addDoc(collection(db, "resumen_caja"), resumen);
      alert("‚úÖ Resumen del d√≠a guardado en la nube.");
    } catch (e) {
      console.error("Error guardando resumen:", e);
      alert("‚ùå No se pudo guardar el resumen: " + e.message);
    }
  };

  // =========================================================
  // [22] DESCARGAR REPORTE TXT DEL D√çA
  // =========================================================
  window.descargarReporte = async () => {
    try {
      const hoy = new Date();
      const fechaSimple =
        `${hoy.getDate()}/${hoy.getMonth() + 1}/${hoy.getFullYear()}`;

      const snap = await getDocs(collection(db, "consultas"));

      let lineas = [];
      let bruto = 0, gastos = 0, pagoDoctor = 0, neto = 0;
      let pacientes = 0;

      lineas.push(`RESUMEN DE CAJA - ${fechaSimple}`);
      lineas.push("====================================");

      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (d.fechaSimple === fechaSimple) {
          const b = parseFloat(d.montoVenta)  || 0;
          const g = parseFloat(d.montoInsumos)|| 0;
          const p = parseFloat(d.pagoDoctor)  || 0;
          const n = b - g - p;

          bruto      += b;
          gastos     += g;
          pagoDoctor += p;
          neto       += n;
          pacientes++;

          lineas.push(
            `PACIENTE: ${d.paciente} | DR: ${d.doctor} | BRUTO: $${b.toFixed(2)} | INSUMOS: $${g.toFixed(2)} | DOC: $${p.toFixed(2)} | NETO: $${n.toFixed(2)}`
          );
        }
      });

     lineas.push("------------------------------------");
      lineas.push(`PACIENTES: ${pacientes}`);
      lineas.push(`BRUTO TOTAL: $${bruto.toFixed(2)}`);
      lineas.push(`GASTOS INSUMOS: $${gastos.toFixed(2)}`);
      lineas.push(`PAGOS DOCTORES: $${pagoDoctor.toFixed(2)}`);
      lineas.push(`UTILIDAD NETA AVIPET: $${neto.toFixed(2)}`);

      const contenido = lineas.join("\n");
      const blob = new Blob([contenido], { type: "text/plain;charset=utf-8" });
      const url  = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_caja_${fechaSimple.replace(/\//g, "-")}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Error al descargar reporte:", e);
      alert("‚ùå No se pudo generar el TXT: " + e.message);
    }
  };
  // =========================================================
  // [NUEVO] RECETA SIN COSTOS (IMPRESI√ìN SIMPLE)
  // =========================================================
  window.imprimirRecetaLimpia = () => {
    const texto = document.getElementById('hTratamiento')?.value || "";
    const paciente = document.getElementById('hNombre')?.value || "";
    const propietario = document.getElementById('hProp')?.value || "";

    const ventana = window.open("", "_blank", "width=800,height=600");
    if (!ventana) return;

    ventana.document.write(`
      <html>
      <head>
        <title>Receta - AVIPET</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          h1 { font-size: 18px; margin-bottom: 5px; }
          h2 { font-size: 14px; margin-bottom: 10px; }
          pre { white-space: pre-wrap; font-size: 12px; }
        </style>
      </head>
      <body>
        <h1>AVIPET - Receta sin costos</h1>
        <h2>Paciente: ${paciente} | Propietario: ${propietario}</h2>
        <hr/>
        <pre>${texto}</pre>
      </body>
      </html>
    `);
    ventana.document.close();
    ventana.focus();
    ventana.print();
  };

  // =========================================================
  // [19] INICIALIZACI√ìN B√ÅSICA
  // =========================================================
  window.addEventListener('DOMContentLoaded', () => {
    const f = new Date();
    const campoFecha = document.getElementById('fechaDoc');
    if (campoFecha) {
      campoFecha.value =
        `${f.getDate()}/${f.getMonth() + 1}/${f.getFullYear()}`;
    }
    window.ejecutarCambioDeTab('historia');
  });
// =========================================================
// [NUEVO] EXPORTAR HISTORIAL CL√çNICO A EXCEL (CSV) POR DOCTOR
// =========================================================
window.exportarHistorialAExcel = async () => {
  try {
    // Usar el doctor actualmente verificado / firmante (global en window)
    const doctorActual = window.doctorVerificado || "";
    console.log("DEBUG: exportarHistorialAExcel, doctorActual =", doctorActual);
    if (!doctorActual) {
      alert("No hay doctor verificado para exportar historial.");
      return;
    }

    const snap = await getDocs(collection(db, "consultas"));
    if (snap.empty) {
      alert("No hay registros en HISTORIAL (consultas) para exportar.");
      return;
    }

    // Columnas que ir√°n al Excel (AGREGAMOS 'tratamiento')
    const encabezados = [
      "fechaSimple",
      "cedula",
      "propietario",
      "paciente",
      "doctor",
      "telefono",
      "correo",
      "direccion",
      "especie",
      "raza",
      "edad",
      "sexo",
      "peso",
      "color",
      "alerta",
      "montoVenta",
      "montoInsumos",
      "pagoDoctor",
      "pagoAvipet",
      "tratamiento"          // ‚Üê NUEVA COLUMNA
    ];

    const filas = [];
    filas.push(encabezados.join(";")); // separador ;

    let hayFilasDoctor = false;

    snap.forEach(docSnap => {
      const d = docSnap.data();

      // Filtrar solo las consultas de este doctor
      if ((d.doctor || "") !== doctorActual) return;
      hayFilasDoctor = true;

      const fila = encabezados.map(col => {
        let val = d[col];

        // Booleanos -> SI / NO
        if (typeof val === "boolean") {
          val = val ? "SI" : "NO";
        }

        // N√∫meros -> cambiar punto por coma (si quieres formato ES)
        if (typeof val === "number") {
          val = val.toString().replace(".", ",");
        }

        if (val === undefined || val === null) val = "";

        // Limpiar saltos de l√≠nea y ; para no romper el CSV
        // (tratamiento puede tener saltos de l√≠nea)
        val = String(val)
          .replace(/\r?\n/g, " ")
          .replace(/;/g, ",");

        return `"${val}"`;
      });

      filas.push(fila.join(";"));
    });

    if (!hayFilasDoctor) {
      alert(`No hay registros para el doctor: ${doctorActual}`);
      return;
    }

    console.log("DEBUG: filas a exportar =", filas.length);
    const contenido = filas.join("\n");
    const blob = new Blob([contenido], { type: "text/csv;charset=utf-8" });

    const hoy = new Date();
    const nombreArchivo =
      `historial_${doctorActual.replace(/\s+/g, '_')}_${hoy.getFullYear()}-${hoy.getMonth() + 1}-${hoy.getDate()}.csv`;

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (e) {
    console.error("Error al exportar historial:", e);
    alert("‚ùå No se pudo exportar el historial: " + e.message);
  }
};
  // Copia datos de la Historia Cl√≠nica a la Hoja de Vacunas
// Copia datos de la Historia Cl√≠nica a la Hoja de Vacunas
window.abrirHojaVacunasDesdeHistoria = () => {
  const dVal = (id) => document.getElementById(id)?.value.trim() || "";
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = val || "";
  };

  // Fecha de emisi√≥n de la hoja
  const f = new Date();
  const fechaStr = `${f.getDate().toString().padStart(2, '0')}/${(f.getMonth()+1).toString().padStart(2,'0')}/${f.getFullYear()}`;
  set('hv_fecha', fechaStr);

  // Datos de propietario/paciente desde la Historia
  set('hv_propietario', dVal('hProp'));
  set('hv_cedula',      dVal('hCI'));
  set('hv_telefono',    dVal('hTlf'));
  set('hv_direccion',   dVal('hDir'));

  set('hv_especie',     dVal('hEspecie'));
  set('hv_raza',        dVal('hRaza'));
  set('hv_paciente',    dVal('hNombre'));
  set('hv_edad',        dVal('hEdad'));
  set('hv_sexo',        dVal('hSexo'));
  set('hv_peso',        dVal('hPeso') || dVal('hPesoKg') || "");
  set('hv_color',       dVal('hColor'));

  // Datos de doctor (logo, nombre, cl√≠nica)
  if (window.doctorActivoId && window.CONFIG_DOCTORES && window.CONFIG_DOCTORES[window.doctorActivoId]) {
    const conf = window.CONFIG_DOCTORES[window.doctorActivoId];

    const elLogo   = document.getElementById('hv_logoDoctor');
    const elNombre = document.getElementById('hv_nombreDoctor');
    const elClin   = document.getElementById('hv_clinicaDoctor');

    if (elLogo) {
      elLogo.src = conf.logo || "";
      elLogo.alt = conf.nombre || "Logo Doctor";
    }
    if (elNombre) elNombre.textContent = conf.nombre || "";
    if (elClin)   elClin.textContent   = conf.clinica || "";
  }

  // Mostrar hoja vacunas y ocultar historia
  document.getElementById('sectionHistoria')?.classList.add('hidden');
  document.getElementById('sectionHojaVacunas')?.classList.remove('hidden');
};

// Volver desde la Hoja de Vacunas a la Historia
window.volverAHistoriaDesdeVacunas = () => {
  document.getElementById('sectionHojaVacunas')?.classList.add('hidden');
  document.getElementById('sectionHistoria')?.classList.remove('hidden');
};

// Configuraci√≥n de doctores para logo y textos
window.CONFIG_DOCTORES = {
  "DR_PEREZ": {
    nombre: "Dr. Juan P√©rez",
    clinica: "AVIPET - Medicina Veterinaria",
    logo: "img/logos/dr_perez.png"
  },
  "DR_LOPEZ": {
    nombre: "Dra. Ana L√≥pez",
    clinica: "AVIPET - Cirug√≠a y Medicina Felina",
    logo: "img/logos/dr_lopez.png"
  }
  // agrega m√°s doctores...
};

window.doctorActivoId = null;

// (Opcional) Cuando autentiques al doctor, fija doctorActivoId
// Ejemplo de funci√≥n gen√©rica:
function onDoctorAutenticado(doctorId) {
  // doctorId ser√° "DR_PEREZ", "DR_LOPEZ", etc.
  window.doctorActivoId = doctorId;
  // resto de tu l√≥gica...
}

window.imprimirHojaVacunas = () => {
  const hv   = document.getElementById('sectionHojaVacunas');
  const hist = document.getElementById('sectionHistoria');

  // 1) Asegurar que la hoja de vacunas est√© visible
  if (hv) hv.classList.remove('hidden');
  // Opcional: ocultar historia para que no moleste visualmente
  if (hist) hist.classList.add('hidden');

  // 2) Llamar a imprimir tal como est√° la pantalla
  window.print();

  // 3) Restaurar pantalla despu√©s de imprimir
  setTimeout(() => {
    if (hist) hist.classList.remove('hidden');
    if (hv)   hv.classList.add('hidden');
  }, 500);
};
</script>

</body>
</html>























































































