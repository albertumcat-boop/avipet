<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AVIPET - SISTEMA INTEGRAL PROFESIONAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ==========================================================================
           [01] ESTILOS GENERALES Y UI (DISE√ëO Y PANTALLA)
           ========================================================================== */
        body { 
            background-color: #f1f5f9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1e293b; 
        }

        .print-area {
            background: #ffffff;
            border-radius: 28px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .header-box { border: 1px solid #cbd5e1; padding: 4px; text-align: center; font-weight: bold; font-size: 10px; background: #f8fafc; }
        .hidden { display: none !important; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; margin: 0; }
            .print-area { box-shadow: none; border: none; width: 100%; max-width: 100%; margin: 0; padding: 10mm; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24">

    <nav class="no-print fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-white/80 backdrop-blur-xl border border-white/20 shadow-2xl rounded-3xl px-6 py-3 flex justify-around items-center z-50">
        <button id="tabH" onclick="showTab('historia')" class="flex-1 flex flex-col items-center gap-1 py-2 rounded-xl transition bg-blue-600/10 text-blue-600">
            <span class="text-[10px] font-black uppercase tracking-tighter">Historia</span>
        </button>
        <button id="tabB" onclick="showTab('buscador')" class="flex-1 flex flex-col items-center gap-1 py-2 rounded-xl transition text-slate-400">
            <span class="text-[10px] font-black uppercase tracking-tighter">Buscador</span>
        </button>
        <button id="tabR" onclick="showTab('reporte')" class="flex-1 flex flex-col items-center gap-1 py-2 rounded-xl transition text-slate-400">
            <span class="text-[10px] font-black uppercase tracking-tighter">Reporte</span>
        </button>
        <button id="tabC" onclick="showTab('config_precios')" class="flex-1 flex flex-col items-center gap-1 py-2 rounded-xl transition text-slate-400">
            <span class="text-[10px] font-black uppercase tracking-tighter">Config</span>
        </button>
    </nav>

    <section id="sectionHistoria" class="p-4 max-w-4xl mx-auto pt-8">
        <div class="print-area p-8 relative overflow-hidden">
            <div class="flex justify-between items-start mb-8 border-b border-slate-100 pb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/30">
                        <span class="text-white font-black text-2xl tracking-tighter italic">A</span>
                    </div>
                    <div>
                        <h1 class="font-black text-3xl text-blue-900 tracking-tighter italic leading-none">AVIPET</h1>
                        <p class="text-[10px] font-bold text-slate-400 tracking-[0.2em] uppercase">Clinical Management System</p>
                    </div>
                </div>
                <div class="text-right">
                    <input type="text" id="fechaDoc" class="text-right font-black text-slate-400 bg-transparent border-none outline-none text-sm" readonly>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="relative group">
                    <label class="absolute -top-2 left-3 bg-white px-1 text-[9px] font-black text-blue-500 uppercase z-10">C√©dula del Propietario</label>
                    <input type="text" id="hCI" placeholder="V-00000000" onblur="autocompletarPorCedula(this.value)" 
                           class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-400 transition-all uppercase">
                </div>
                <div class="relative group">
                    <label class="absolute -top-2 left-3 bg-white px-1 text-[9px] font-black text-blue-500 uppercase z-10">Nombre del Propietario</label>
                    <input type="text" id="hProp" placeholder="NOMBRE COMPLETO" 
                           class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-400 transition-all uppercase">
                </div>
                <div class="relative group">
                    <label class="absolute -top-2 left-3 bg-white px-1 text-[9px] font-black text-blue-500 uppercase z-10">Nombre del Paciente</label>
                    <input type="text" id="hNombre" placeholder="MASCOTA" 
                           class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-400 transition-all uppercase">
                </div>
            </div>

            <div class="mb-8 no-print">
                <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Responsable M√©dico (Validaci√≥n PIN)</label>
                <select id="selectDoctor" onchange="validarAccesoDoctor(this.value)" 
                        class="w-full p-4 rounded-2xl border-2 border-slate-100 font-bold text-slate-700 bg-slate-50 outline-none focus:border-blue-400 transition-all cursor-pointer">
                    <option value="">-- SELECCIONE EL DOCTOR EN TURNO --</option>
                    <option value="Darwin Sandoval">Dr. Darwin Sandoval</option>
                    <option value="Joan Silva">Dra. Joan Silva</option>
                </select>
            </div>

            <div class="no-print mb-8">
                <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Procedimientos Cl√≠nicos</label>
                <select id="selectorServicios" onchange="insertarServicio(this.value)" 
                        class="w-full p-4 rounded-2xl border-2 border-blue-100 font-bold text-blue-700 bg-blue-50/50 outline-none focus:border-blue-400 transition-all shadow-sm">
                    <option value="">+ AGREGAR NUEVO SERVICIO</option>
                </select>
            </div>

            <div class="overflow-hidden mb-8">
                <table class="w-full">
                    <thead>
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                            <th class="pb-4 text-left">Descripci√≥n del Servicio</th>
                            <th class="pb-4 text-center">Cant</th>
                            <th class="pb-4 text-center no-print">Costo</th>
                            <th class="pb-4 text-right">Subtotal</th>
                            <th class="pb-4 no-print w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="listaServicios" class="divide-y divide-slate-50">
                        </tbody>
                </table>
            </div>

            <div class="mb-8">
                <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">Plan Terap√©utico / Observaciones M√©dicas</label>
                <textarea id="hTratamiento" rows="5" 
                          class="w-full p-5 rounded-3xl border-2 border-slate-100 font-medium text-slate-700 focus:border-blue-400 outline-none transition-all placeholder:text-slate-300 bg-slate-50/30" 
                          placeholder="Escriba aqu√≠ los hallazgos m√©dicos y el tratamiento indicado..."></textarea>
                <div id="hTratamientoPrint" class="hidden font-medium text-slate-800 leading-relaxed whitespace-pre-wrap py-4"></div>
            </div>

            <div class="flex flex-col items-end gap-3 pt-6 border-t border-slate-100">
                <div class="flex justify-between w-64 px-4 py-2 bg-slate-50 rounded-xl no-print">
                    <span class="text-[10px] font-black text-slate-400 uppercase">Gasto Insumos:</span>
                    <span id="totalInsumos" class="font-bold text-slate-600">$0.00</span>
                </div>
                <div class="flex justify-between w-64 px-4 py-3 bg-blue-900 rounded-2xl shadow-xl shadow-blue-900/20">
                    <span class="text-[10px] font-black text-white/60 uppercase self-center">Total a Pagar:</span>
                    <div class="flex items-center text-white">
                        <span class="text-xl font-black mr-1">$</span>
                        <input type="number" id="precioVenta" value="0.00" step="0.01" 
                               class="text-right w-24 bg-transparent outline-none text-xl font-black" readonly>
                    </div>
                </div>
            </div>

            <div class="mt-16 flex justify-between items-end px-4">
                <div class="text-center">
                    <div class="w-48 border-b-2 border-slate-200 mb-3 mx-auto"></div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Firma del Propietario</p>
                </div>
                <div class="text-center">
                    <p id="doctorPrint" class="font-black text-blue-900 uppercase text-xs mb-1">SELECCIONE DOCTOR</p>
                    <div class="w-48 border-b-2 border-blue-900 mb-3 mx-auto"></div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter italic">Sello y Firma M√©dico Veterinaria</p>
                </div>
            </div>
        </div>

        <div class="no-print mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="guardarFirebase(false)" 
                    class="bg-slate-800 text-white p-5 rounded-3xl font-black uppercase text-xs tracking-widest hover:bg-slate-900 transition-all shadow-xl active:scale-95">
                Solo Guardar en Nube
            </button>
            <button onclick="guardarFirebase(true)" 
                    class="bg-blue-600 text-white p-5 rounded-3xl font-black uppercase text-xs tracking-widest hover:bg-blue-700 transition-all shadow-xl active:scale-95 flex items-center justify-center gap-2">
                <span>Guardar e Imprimir Receta</span>
            </button>
        </div>
    </section>

    <section id="sectionBuscador" class="hidden p-4 max-w-4xl mx-auto pt-8">
        <div class="bg-white p-8 rounded-[32px] shadow-sm">
            <h2 class="font-black text-2xl mb-6 text-slate-800 flex items-center gap-3">
                <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-sm italic">B</span>
                BUSCADOR DE PACIENTES
            </h2>
            <div class="relative mb-8">
                <input type="text" id="inputBuscarCedula" onkeyup="buscarPorCedula(this.value)" 
                       placeholder="Buscar por n√∫mero de c√©dula..." 
                       class="w-full p-5 pl-14 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-400 transition-all font-bold">
                <span class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300">üîç</span>
            </div>
            <div id="resultadosBusqueda" class="space-y-4">
                </div>
        </div>
    </section>

    <section id="sectionReporte" class="hidden p-4 max-w-4xl mx-auto pt-8">
        <div class="bg-white p-8 rounded-[32px] shadow-sm">
            <div class="flex justify-between items-center mb-8">
                <h2 class="font-black text-2xl text-slate-800 italic uppercase tracking-tighter">Cierre de Caja</h2>
                <div class="text-[10px] font-black bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full uppercase">En Vivo</div>
            </div>

            <div id="resumenCaja" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                </div>

            <div class="border-t border-slate-50 pt-8">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Detalle de Consultas del D√≠a</h3>
                <div id="listaReporte" class="space-y-4">
                    </div>
            </div>
        </div>
    </section>

    <section id="sectionConfigPrecios" class="hidden p-4 max-w-5xl mx-auto pt-8">
        <div class="bg-white p-8 rounded-[32px] shadow-sm">
            <h2 class="font-black text-2xl mb-8 text-slate-800">CONFIGURACI√ìN DE TARIFAS</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                    <h3 class="font-black text-xs uppercase text-blue-600 mb-4">Ajustes Globales</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[9px] font-black uppercase text-slate-400">Insumo Base ($)</label>
                            <input type="number" id="cfgInsumos" step="0.01" class="w-full p-3 rounded-xl border-2 border-white outline-none focus:border-blue-400 font-bold">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black uppercase text-slate-400">% Doctor Global</label>
                            <input type="number" id="cfgPorcentaje" class="w-full p-3 rounded-xl border-2 border-white outline-none focus:border-blue-400 font-bold">
                        </div>
                    </div>
                    <button onclick="guardarConfiguracion()" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-blue-600/20 active:scale-95 transition-all">
                        Aplicar Cambios Globales
                    </button>
                </div>
            </div>

            <div class="bg-slate-900 rounded-[28px] overflow-hidden">
                <div class="flex p-2 gap-2">
                    <button id="btnTabServ" onclick="cambiarSubTabConfig('servicios')" class="flex-1 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest bg-white text-slate-900 transition-all">Servicios</button>
                    <button id="btnTabIns" onclick="cambiarSubTabConfig('insumos')" class="flex-1 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest text-white/40 transition-all">Insumos</button>
                </div>
                
                <div id="contenedorTabServicios" class="p-6">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[9px] font-black text-white/30 uppercase tracking-widest border-b border-white/5">
                                <th class="pb-4">Nombre del Servicio</th>
                                <th class="pb-4">P. Venta</th>
                                <th class="pb-4">% Doctor</th>
                                <th class="pb-4"></th>
                            </tr>
                        </thead>
                        <tbody id="tablaMaestraServicios" class="text-white divide-y divide-white/5"></tbody>
                    </table>
                </div>

                <div id="contenedorTabInsumos" class="p-6 hidden">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[9px] font-black text-white/30 uppercase tracking-widest border-b border-white/5">
                                <th class="pb-4">Nombre del Insumo</th>
                                <th class="pb-4">Costo Unidad ($)</th>
                                <th class="pb-4"></th>
                            </tr>
                        </thead>
                        <tbody id="tablaMaestraInsumos" class="text-white divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, serverTimestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================================================
        // [08] CONFIGURACI√ìN Y ESTADO INICIAL
        // ==========================================================================
        const firebaseConfig = {
            apiKey: "PON_AQUI_TU_API_KEY",
            authDomain: "avipet-system.firebaseapp.com",
            projectId: "avipet-system",
            storageBucket: "avipet-system.appspot.com",
            messagingSenderId: "PON_AQUI_TU_ID",
            appId: "PON_AQUI_TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables Globales
        const pinsDoctores = { "Darwin Sandoval": "1111", "Joan Silva": "2222" };
        let doctorVerificado = "";
        let recetas = {};
        let CONFIG_SERVICIOS = {};

        // ==========================================================================
        // [09] FUNCIONES DE NAVEGACI√ìN Y ACCESO (AJUSTADAS AL WINDOW)
        // ==========================================================================
        window.showTab = (t) => {
            if (t === 'config_precios') {
                const clave = prompt("üîê ACCESO RESTRINGIDO\nIngrese clave de administrador:");
                if (clave !== 'AVIPET2026') return alert("üö´ No autorizado.");
            }

            document.getElementById('sectionHistoria').classList.toggle('hidden', t !== 'historia');
            document.getElementById('sectionBuscador').classList.toggle('hidden', t !== 'buscador');
            document.getElementById('sectionReporte').classList.toggle('hidden', t !== 'reporte');
            document.getElementById('sectionConfigPrecios').classList.toggle('hidden', t !== 'config_precios');

            const ids = { 'historia': 'tabH', 'buscador': 'tabB', 'reporte': 'tabR', 'config_precios': 'tabC' };
            ['tabH', 'tabB', 'tabR', 'tabC'].forEach(id => {
                const b = document.getElementById(id);
                if (b) { b.classList.remove('bg-blue-600/10', 'text-blue-600'); b.classList.add('text-slate-400'); }
            });
            const activo = document.getElementById(ids[t]);
            if (activo) { activo.classList.add('bg-blue-600/10', 'text-blue-600'); activo.classList.remove('text-slate-400'); }

            if (t === 'reporte') window.cargarReporte();
            if (t === 'config_precios') { window.renderizarTablaMaestra(); window.renderizarTablaInsumos(); }
        };

        window.validarAccesoDoctor = async (nombre) => {
            if (!nombre) {
                doctorVerificado = "";
                document.getElementById('doctorPrint').innerText = "SELECCIONE DOCTOR";
                return;
            }
            const pin = prompt(`ACCESO RESTRINGIDO: PIN para ${nombre.toUpperCase()}:`);
            if (pin === pinsDoctores[nombre]) {
                doctorVerificado = nombre;
                const pfx = (nombre === "Joan Silva") ? "DRA. " : "DR. ";
                document.getElementById('doctorPrint').innerText = pfx + nombre.toUpperCase();
                alert(`‚úÖ Identidad confirmada: ${pfx}${nombre}`);
                await window.calcularTodo();
            } else {
                alert("‚ùå PIN INCORRECTO.");
                document.getElementById('selectDoctor').value = "";
                doctorVerificado = "";
                document.getElementById('doctorPrint').innerText = "SELECCIONE DOCTOR";
            }
        };

        // ==========================================================================
        // [10] L√ìGICA DE SERVICIOS E INSUMOS (TODO MANTENIDO)
        // ==========================================================================
        window.insertarServicio = (id) => {
            if (!id || !recetas[id]) return;
            const tabla = document.getElementById('listaServicios');
            const grupoID = `g-${Math.random().toString(36).substr(2, 5)}`;
            const pVenta = recetas[id].precioVenta;
            const porcDoc = CONFIG_SERVICIOS[id] ? CONFIG_SERVICIOS[id].porc : 30;

            let html = `
                <tr class="servicio-principal bg-blue-50/20" data-grupo="${grupoID}" data-precio="${pVenta}" data-porc="${porcDoc}">
                    <td class="p-4 font-black text-blue-900 text-xs uppercase">${id}</td>
                    <td class="p-4 text-center font-bold">1</td>
                    <td class="p-4 text-center no-print font-bold text-slate-400">$${pVenta}</td>
                    <td class="p-4 text-right font-black text-blue-900">$${pVenta.toFixed(2)}</td>
                    <td class="p-4 no-print text-center">
                        <button onclick="window.eliminarServicio('${grupoID}')" class="text-red-400 hover:text-red-600 transition-colors">‚úï</button>
                    </td>
                </tr>`;

            recetas[id].insumos.forEach(ins => {
                html += `
                    <tr class="${grupoID} insumo-fila text-[11px] text-slate-400 italic bg-white/50">
                        <td class="p-2 pl-10">üîπ ${ins.nombre}</td>
                        <td class="p-2 text-center">
                            <input type="number" value="${ins.cant}" step="0.1" class="i-cant w-10 text-center bg-transparent border-b border-slate-100" onchange="window.calcularTodo()">
                        </td>
                        <td class="p-2 text-center no-print">
                            $<input type="number" value="${ins.costo}" step="0.1" class="i-cost w-12 text-center bg-transparent" onchange="window.calcularTodo()">
                        </td>
                        <td class="p-2 text-right i-sub font-bold">$${(ins.cant * ins.costo).toFixed(2)}</td>
                        <td class="p-2"></td>
                    </tr>`;
            });

            tabla.insertAdjacentHTML('beforeend', html);
            window.calcularTodo();
            document.getElementById('selectorServicios').value = "";
        };

        window.calcularTodo = () => {
            let totalVenta = 0; let totalGasto = 0;
            document.querySelectorAll('.servicio-principal').forEach(f => {
                totalVenta += parseFloat(f.getAttribute('data-precio')) || 0;
            });
            document.querySelectorAll('.insumo-fila').forEach(f => {
                const c = parseFloat(f.querySelector('.i-cant').value) || 0;
                const cost = parseFloat(f.querySelector('.i-cost').value) || 0;
                const sub = c * cost;
                f.querySelector('.i-sub').innerText = `$${sub.toFixed(2)}`;
                totalGasto += sub;
            });
            document.getElementById('precioVenta').value = totalVenta.toFixed(2);
            document.getElementById('totalInsumos').innerText = `$${totalGasto.toFixed(2)}`;
        };

        window.eliminarServicio = (id) => {
            document.querySelectorAll(`[data-grupo="${id}"], .${id}`).forEach(el => el.remove());
            window.calcularTodo();
        };

        // ==========================================================================
        // [11] PERSISTENCIA Y FIREBASE (TODO MANTENIDO)
        // ==========================================================================
        window.sincronizarCatalogos = async () => {
            const snap = await getDocs(collection(db, "servicios_maestro"));
            const selector = document.getElementById('selectorServicios');
            selector.innerHTML = '<option value="">+ AGREGAR NUEVO SERVICIO</option>';
            snap.forEach(ds => {
                const d = ds.data();
                recetas[ds.id] = { precioVenta: d.precioVenta, insumos: d.insumos || [] };
                CONFIG_SERVICIOS[ds.id] = { porc: d.porcDoc };
                const opt = document.createElement('option'); opt.value = ds.id; opt.textContent = ds.id;
                selector.appendChild(opt);
            });
        };

        window.guardarFirebase = async (imp) => {
            if (!doctorVerificado) return alert("‚õî Requiere firma del doctor.");
            try {
                const configSnap = await getDoc(doc(db, "configuracion", "tarifas"));
                let porcGlobal = (configSnap.exists() && configSnap.data().porcentajeDoc > 0) ? configSnap.data().porcentajeDoc : null;

                const montoVentaTotal = parseFloat(document.getElementById('precioVenta').value) || 0;
                let totalGastos = 0; let pagoDoctorTotal = 0;
                const detalleInsumos = [];

                document.querySelectorAll('.servicio-principal').forEach(f => {
                    const gid = f.getAttribute('data-grupo');
                    const pS = parseFloat(f.getAttribute('data-precio')) || 0;
                    const pE = porcGlobal || parseFloat(f.getAttribute('data-porc')) || 0;

                    let gS = 0;
                    document.querySelectorAll(`.${gid}.insumo-fila`).forEach(iF => {
                        const n = iF.cells[0].innerText.replace('üîπ ', '').trim();
                        const c = parseFloat(iF.querySelector('.i-cant').value) || 0;
                        const cost = parseFloat(iF.querySelector('.i-cost').value) || 0;
                        const sub = c * cost;
                        gS += sub;
                        detalleInsumos.push({ nombre: n, cant: c, costo: cost });
                    });
                    totalGastos += gS;
                    pagoDoctorTotal += (Math.max(0, pS - gS) * (pE / 100));
                });

                const data = {
                    cedula: document.getElementById('hCI').value,
                    paciente: document.getElementById('hNombre').value,
                    propietario: document.getElementById('hProp').value,
                    doctor: doctorVerificado,
                    tratamiento: document.getElementById('hTratamiento').value,
                    montoVenta: montoVentaTotal,
                    montoInsumos: totalGastos,
                    pagoDoctor: pagoDoctorTotal,
                    pagoAvipet: (montoVentaTotal - totalGastos - pagoDoctorTotal),
                    listaDetalladaInsumos: detalleInsumos,
                    fecha: serverTimestamp(),
                    fechaSimple: new Date().toLocaleDateString('es-ES')
                };

                await addDoc(collection(db, "consultas"), data);
                if (imp) {
                    document.getElementById('hTratamientoPrint').innerText = data.tratamiento;
                    window.print();
                }
                alert("‚úÖ Guardado con √©xito.");
                location.reload();
            } catch (e) { alert("Error: " + e.message); }
        };

        // ==========================================================================
        // [12] PANEL DE CONFIGURACI√ìN (TODO MANTENIDO)
        // ==========================================================================
        window.renderizarTablaMaestra = () => {
            const t = document.getElementById('tablaMaestraServicios');
            t.innerHTML = "";
            Object.keys(recetas).forEach(id => {
                t.innerHTML += `
                    <tr class="text-[11px] font-bold">
                        <td class="py-4 uppercase">${id}</td>
                        <td class="py-4">$${recetas[id].precioVenta}</td>
                        <td class="py-4">${CONFIG_SERVICIOS[id].porc}%</td>
                        <td class="py-4 text-right">
                            <button onclick="window.actualizarPrecioIndividual('${id}')" class="text-blue-400 uppercase text-[9px]">Editar</button>
                        </td>
                    </tr>`;
            });
        };

        window.renderizarTablaInsumos = async () => {
            const snap = await getDocs(collection(db, "insumos_maestro"));
            const t = document.getElementById('tablaMaestraInsumos');
            t.innerHTML = "";
            snap.forEach(ds => {
                const d = ds.data();
                t.innerHTML += `
                    <tr class="text-[11px] font-bold">
                        <td class="py-4 uppercase">${ds.id}</td>
                        <td class="py-4">$${d.costo}</td>
                        <td class="py-4 text-right">
                            <button onclick="window.actualizarCostoInsumo('${ds.id}')" class="text-blue-400 uppercase text-[9px]">Editar</button>
                        </td>
                    </tr>`;
            });
        };

        window.cambiarSubTabConfig = (tab) => {
            document.getElementById('contenedorTabServicios').classList.toggle('hidden', tab !== 'servicios');
            document.getElementById('contenedorTabInsumos').classList.toggle('hidden', tab !== 'insumos');
            document.getElementById('btnTabServ').className = tab === 'servicios' ? "flex-1 py-3 rounded-2xl font-black text-[10px] uppercase bg-white text-slate-900" : "flex-1 py-3 rounded-2xl font-black text-[10px] uppercase text-white/40";
            document.getElementById('btnTabIns').className = tab === 'insumos' ? "flex-1 py-3 rounded-2xl font-black text-[10px] uppercase bg-white text-slate-900" : "flex-1 py-3 rounded-2xl font-black text-[10px] uppercase text-white/40";
        };

        // ==========================================================================
        // [13] ARRANQUE (DOMContentLoaded)
        // ==========================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üö¢ Avipet System: Iniciando motores...");
            await window.sincronizarCatalogos();
            try {
                // CORRECCI√ìN AQU√ç: Estaba doc(doc(db...))
                const snap = await getDoc(doc(db, "configuracion", "tarifas"));
                if (snap.exists()) {
                    const d = snap.data();
                    if(document.getElementById('cfgInsumos')) document.getElementById('cfgInsumos').value = d.insumoBase;
                    if(document.getElementById('cfgPorcentaje')) document.getElementById('cfgPorcentaje').value = d.porcentajeDoc;
                }
            } catch (e) { console.warn(e); }
            const fi = document.getElementById('fechaDoc');
            if(fi) fi.value = new Date().toLocaleDateString('es-ES');
        });

    </script>
</body>
</html>





























































































