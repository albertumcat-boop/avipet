<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Control Pro - AvicolaPet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #area-impresion, #area-impresion * { visibility: visible; }
            #area-impresion { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900">

    <nav class="bg-blue-700 shadow-md p-4 sticky top-0 z-50 flex justify-between items-center text-white no-print">
        <h1 class="text-xl font-bold">üêæ Pet Control Pro - AvicolaPet</h1>
        <div id="status-firebase" class="text-xs opacity-75">Conectado</div>
    </nav>

    <main class="max-w-6xl mx-auto p-4">
        
        <section id="login-section" class="bg-white p-8 rounded-xl shadow-lg text-center mt-10 max-w-md mx-auto no-print">
            <h2 class="text-2xl font-bold mb-4">Acceso Seguro</h2>
            <input type="password" id="pin-input" placeholder="PIN de 4 d√≠gitos" class="border-2 rounded-lg p-3 w-full text-center text-2xl mb-4 outline-none focus:border-blue-500">
            <button onclick="verificarPin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg w-full transition">Ingresar</button>
        </section>

        <section id="admin-panel" class="hidden space-y-6">
            
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500 no-print">
                <h3 class="text-lg font-bold mb-4 flex items-center">üìù Registro de Paciente</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <p class="font-semibold text-blue-600 border-b">Informaci√≥n General</p>
                        <input type="text" id="nombre_cliente" placeholder="Nombre del Due√±o" class="w-full border p-2 rounded">
                        <input type="text" id="cedula_cliente" placeholder="C√©dula / ID" class="w-full border p-2 rounded">
                        <input type="text" id="nombre_mascota" placeholder="Nombre Mascota" class="w-full border p-2 rounded">
                        <textarea id="diagnostico" placeholder="Informe m√©dico / Diagn√≥stico" class="w-full border p-2 rounded h-20"></textarea>
                    </div>

                    <div class="space-y-2 bg-slate-50 p-3 rounded border">
                        <p class="font-semibold text-red-600 border-b">Costos de Insumos ($)</p>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-xs">Alcohol</label><input type="number" id="ins_alcohol" value="0" class="insumo w-full border p-1 rounded text-sm"></div>
                            <div><label class="text-xs">Guantes</label><input type="number" id="ins_guantes" value="0" class="insumo w-full border p-1 rounded text-sm"></div>
                            <div><label class="text-xs">Jeringas</label><input type="number" id="ins_jeringas" value="0" class="insumo w-full border p-1 rounded text-sm"></div>
                            <div><label class="text-xs">Algod√≥n</label><input type="number" id="ins_algodon" value="0" class="insumo w-full border p-1 rounded text-sm"></div>
                            <div><label class="text-xs">Otros</label><input type="number" id="ins_otros" value="0" class="insumo w-full border p-1 rounded text-sm"></div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <p class="font-semibold text-green-600 border-b">Cobro al Cliente</p>
                        <select id="tipo_servicio" class="w-full border p-2 rounded font-bold">
                            <option value="Consulta">Consulta</option>
                            <option value="Cirug√≠a">Cirug√≠a</option>
                            <option value="Vacunaci√≥n">Vacunaci√≥n</option>
                        </select>
                        <label class="text-xs font-bold text-gray-500">PRECIO TOTAL A COBRAR ($)</label>
                        <input type="number" id="precio_publico" placeholder="0.00" class="w-full border p-3 rounded bg-yellow-50 text-xl font-bold">
                        <input type="number" id="pct_vet" placeholder="% Comisi√≥n Vet" value="30" class="w-full border p-2 rounded">
                    </div>
                </div>

                <button onclick="guardarTodo()" class="mt-6 w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 shadow-lg transition uppercase">
                    Guardar y Generar Recibo
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-x-auto no-print">
                <table class="w-full text-left">
                    <thead class="bg-slate-200 text-xs uppercase">
                        <tr>
                            <th class="p-3 border-b">Mascota / Due√±o</th>
                            <th class="p-3 border-b">Servicio</th>
                            <th class="p-3 border-b">Pago Vet</th>
                            <th class="p-3 border-b">Utilidad Neta</th>
                            <th class="p-3 border-b">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cuerpo" class="text-sm"></tbody>
                </table>
            </div>
        </section>

        <div id="area-impresion" class="hidden p-10 bg-white border-2">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-800">AVICOLA PET</h1>
                <p class="text-sm">Informe de Servicio Veterinario</p>
                <hr class="my-4">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <p><strong>Fecha:</strong> <span id="p-fecha"></span></p>
                    <p><strong>Due√±o:</strong> <span id="p-dueno"></span></p>
                    <p><strong>C√©dula:</strong> <span id="p-cedula"></span></p>
                </div>
                <div>
                    <p><strong>Mascota:</strong> <span id="p-mascota"></span></p>
                    <p><strong>Servicio:</strong> <span id="p-servicio"></span></p>
                </div>
            </div>
            <div class="border p-4 rounded mb-6 min-h-[150px]">
                <p class="font-bold border-b mb-2">INFORME M√âDICO / DIAGN√ìSTICO:</p>
                <p id="p-diagnostico"></p>
            </div>
            <div class="text-right text-xl font-bold">
                TOTAL PAGADO: $<span id="p-total"></span>
            </div>
            <div class="mt-20 text-center text-xs text-gray-400">
                <p>__________________________</p>
                <p>Firma del M√©dico</p>
            </div>
        </div>

    </main>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.verificarPin = function() {
            if(document.getElementById('pin-input').value === "1234") {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                cargarDatos();
            } else { alert("PIN Incorrecto"); }
        };

        window.guardarTodo = async function() {
            // Sumar todos los insumos
            const insumosInputs = document.querySelectorAll('.insumo');
            let totalInsumos = 0;
            insumosInputs.forEach(input => totalInsumos += parseFloat(input.value) || 0);

            const datos = {
                cliente: document.getElementById('nombre_cliente').value,
                cedula: document.getElementById('cedula_cliente').value,
                mascota: document.getElementById('nombre_mascota').value,
                diagnostico: document.getElementById('diagnostico').value,
                servicio: document.getElementById('tipo_servicio').value,
                precio: parseFloat(document.getElementById('precio_publico').value) || 0,
                costoInsumos: totalInsumos,
                pct: parseFloat(document.getElementById('pct_vet').value) / 100,
                fecha: new Date().toLocaleString()
            };

            const pagoVet = (datos.precio - datos.costoInsumos) * datos.pct;
            const utilidad = datos.precio - datos.costoInsumos - pagoVet;

            try {
                await addDoc(collection(db, "historial_clinico"), { ...datos, pagoVet, utilidad });
                
                // Llenar hoja de impresi√≥n
                document.getElementById('p-fecha').innerText = datos.fecha;
                document.getElementById('p-dueno').innerText = datos.cliente;
                document.getElementById('p-cedula').innerText = datos.cedula;
                document.getElementById('p-mascota').innerText = datos.mascota;
                document.getElementById('p-servicio').innerText = datos.servicio;
                document.getElementById('p-diagnostico').innerText = datos.diagnostico;
                document.getElementById('p-total').innerText = datos.precio.toFixed(2);

                alert("‚úÖ Guardado. Se abrir√° la ventana de impresi√≥n.");
                window.print();
                location.reload();
            } catch (e) {
                alert("Error al guardar: " + e.message);
            }
        };

        async function cargarDatos() {
            const q = query(collection(db, "historial_clinico"), orderBy("fecha", "desc"));
            const querySnapshot = await getDocs(q);
            const tabla = document.getElementById('tabla-cuerpo');
            tabla.innerHTML = "";
            
            querySnapshot.forEach((doc) => {
                const d = doc.data();
                tabla.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3"><strong>${d.mascota}</strong><br><span class="text-xs text-gray-500">${d.cliente}</span></td>
                        <td class="p-3 text-xs">${d.servicio}<br>${d.fecha}</td>
                        <td class="p-3 text-orange-600 font-bold">$${d.pagoVet.toFixed(2)}</td>
                        <td class="p-3 text-green-700 font-bold">$${d.utilidad.toFixed(2)}</td>
                        <td class="p-3"><button onclick="alert('Diagn√≥stico: ${d.diagnostico}')" class="bg-gray-200 px-2 py-1 rounded text-xs">Ver Info</button></td>
                    </tr>`;
            });
        }
    </script>
</body>
</html>

