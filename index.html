<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AVIPET - SISTEMA INTEGRAL PROFESIONAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ==========================================================================
           [01] ESTILOS GENERALES Y UI (DISE√ëO Y PANTALLA)
           ========================================================================== */
        body { 
            background-color: #f1f5f9; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1e293b; 
        }

        .print-area {
            background: #ffffff;
            border-radius: 28px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .header-box { border: 1px solid #cbd5e1; padding: 4px; text-align: center; font-weight: bold; font-size: 10px; background: #f8fafc; text-transform: uppercase; margin-bottom: 8px; }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: bold; }
        
        input, textarea { outline: none; background: transparent; width: 100%; transition: all 0.2s; }
        input:focus { border-bottom: 2px solid #2563eb !important; }

        button { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        button:active { transform: scale(0.95); }
        button:hover { filter: brightness(1.1); }

        .menu-desplegable {
            width: 100%; padding: 14px; border: 2px solid #3b82f6; border-radius: 10px;
            background-color: #eff6ff; font-weight: bold; color: #1e40af; font-size: 13px;
            margin-bottom: 10px; cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e40af' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em;
        }

        @media screen { #doctorPrint { display: none; } #hTratamientoPrint { display: none; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }

        /* ==========================================================================
           [02] MOTOR DE IMPRESI√ìN (PDF Y RECETAS)
           ========================================================================== */
        @media print {
            .no-print, button, select, nav, #loginSection, .finanzas-ocultar, .menu-desplegable { display: none !important; }
            body { background-color: white !important; padding: 0; margin: 0; }
            .print-area { border: none !important; box-shadow: none !important; width: 100% !important; }
            #doctorPrint { display: block !important; font-weight: 800; text-transform: uppercase; font-size: 14px; color: black; margin-top: 10px; }
            #hTratamiento { display: none !important; } 
            #hTratamientoPrint { display: block !important; border: none !important; height: auto !important; overflow: visible !important; white-space: pre-wrap !important; font-size: 13px; line-height: 1.6; color: black !important; width: 100% !important; }
            input { border: none !important; color: black !important; font-weight: bold; }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

    <main id="adminSection" class="max-w-5xl mx-auto p-2 md:p-4">
        
        <nav class="flex justify-around border-b-2 border-gray-200 mb-4 no-print bg-white sticky top-0 z-40 py-1">
            <button onclick="showTab('historia')" id="tabH" class="tab-active py-2 text-[11px] px-2 uppercase font-bold">Historia Cl√≠nica</button>
            <button onclick="showTab('buscador')" id="tabB" class="py-2 text-gray-500 text-[11px] px-2 uppercase font-bold">Buscador</button>
            <button onclick="showTab('reporte')" id="tabR" class="py-2 text-gray-500 text-[11px] px-2 uppercase font-bold">Finanzas / Caja</button>
            <button onclick="showTab('config_precios')" class="px-4 py-2 font-black text-[10px] uppercase bg-slate-100 rounded-lg shadow-sm border border-slate-200">
                ‚öôÔ∏è Ajustes de Precios
            </button>
        </nav>

        <!-- ========== HISTORIA CL√çNICA ========== -->
        <section id="sectionHistoria" class="block bg-white p-4 shadow-sm border border-slate-200 rounded-xl print-area">
            
            <div class="flex justify-between items-center border-b-2 border-blue-600 pb-4 mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-600 flex items-center justify-center text-white font-black text-2xl rounded-lg">A</div>
                    <div>
                        <h1 class="text-xl font-black text-slate-800">AVIPET</h1>
                        <select id="selectDoctor" onchange="window.validarAccesoDoctor(this.value)" class="no-print text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 outline-none">
                            <option value="">-- SELECCIONE DOCTOR --</option>
                            <option value="Darwin Sandoval">DR. DARWIN SANDOVAL</option>
                            <option value="Joan Silva">DRA. JOAN SILVA</option>
                        </select>
                        <h2 id="doctorPrint" class="hidden print:block font-bold text-sm uppercase text-slate-700">DOCTOR CARGO</h2>
                    </div>
                </div>
                <div class="text-right">
                    <input type="text" id="fechaDoc" class="w-24 text-right font-black text-xs text-slate-500 bg-transparent" readonly>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 border border-slate-400 text-[11px] mb-4">
                <div class="p-3 border-b md:border-b-0 md:border-r border-slate-400 space-y-2">
                    <div class="header-box italic">Ficha T√©cnica de Mascota</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="col-span-2">
                            <label class="text-[9px] font-bold text-slate-400">MASCOTA</label>
                            <input id="hNombre" class="border-b w-full font-bold uppercase text-blue-700">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400">ESPECIE</label>
                            <input id="hEspecie" class="border-b w-full uppercase">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400">RAZA</label>
                            <input id="hRaza" class="border-b w-full uppercase">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400">PESO (KG)</label>
                            <input id="hPeso" class="border-b w-full">
                        </div>
                        <div class="grid grid-cols-2 gap-1">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400">EDAD</label>
                                <input id="hEdad" class="border-b w-full uppercase">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400">SEXO</label>
                                <input id="hSexo" class="border-b w-full uppercase">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3 space-y-2">
                    <div class="header-box italic">Datos del Propietario</div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] font-bold text-slate-400">NOMBRE Y APELLIDO</label>
                            <label class="flex items-center gap-1 cursor-pointer no-print opacity-60">
                                <input type="checkbox" id="hAlerta" class="w-3 h-3 accent-red-600">
                                <span class="text-[8px] font-bold text-slate-400 italic">Ref. Interna</span>
                            </label>
                        </div>
                        <input id="hProp" class="border-b w-full uppercase">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400">C√âDULA</label>
                            <input id="hCI" onblur="autocompletarPorCedula(this.value)" class="border-b w-full font-bold text-blue-700">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400">TEL√âFONO</label>
                            <input id="hTlf" class="border-b w-full">
                        </div>
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400">CORREO ELECTR√ìNICO</label>
                        <input id="hMail" class="border-b w-full">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400">DIRECCI√ìN</label>
                        <input id="hDir" class="border-b w-full uppercase text-[10px]">
                    </div>
                </div>
            </div>

            <div class="border border-slate-400 mb-6 rounded-lg overflow-hidden">
                <div class="bg-slate-100 p-3 no-print">
                    <label class="block text-blue-900 text-[10px] font-black uppercase mb-1">A√±adir Servicios R√°pidos:</label>
                    <select id="selectorServicios" class="menu-desplegable" onchange="window.insertarServicio(this.value)">
                        <option value="">-- SELECCIONE UN SERVICIO --</option>
                        <optgroup label="ü©∫ CONSULTAS">
                            <option value="CONSULTA GENERAL">CONSULTA GENERAL</option>
                            <option value="CONSULTA OFTALMOL√ìGICA">CONSULTA OFTALMOL√ìGICA</option>
                            <option value="CONSULTA CAMADA 3-4 CACHORROS">CONSULTA CAMADA 3-4 CACHORROS</option>
                            <option value="CONSULTA CAMADA HASTA 8 CACHORROS">CONSULTA CAMADA HASTA 8 CACHORROS</option>
                            <option value="CONSULTA CAMADA MAS DE 8 CACHORROS">CONSULTA CAMADA MAS DE 8 CACHORROS</option>
                        </optgroup>
                        <optgroup label="üíâ VACUNAS">
                            <option value="VACUNA SEXTUPLE">VACUNA SEXTUPLE</option>
                            <option value="VACUNA PUPPY">VACUNA PUPPY</option>
                            <option value="VACUNA ANTIRR√ÅBICA">VACUNA ANTIRR√ÅBICA</option>
                            <option value="VACUNA KC (TOS DE LAS PERRERAS)">VACUNA KC (TOS DE LAS PERRERAS)</option>
                            <option value="VACUNA TRIPLE FELINA">VACUNA TRIPLE FELINA</option>
                            <option value="VACUNA QUINTUPLE FELINA">VACUNA QUINTUPLE FELINA</option>
                            <option value="VACUNA BIOVETA">VACUNA BIOVETA</option>
                        </optgroup>
                        <optgroup label="üî¨ LABORATORIO">
                            <option value="HEMATOLOG√çA COMPLETA">HEMATOLOG√çA COMPLETA</option>
                            <option value="QU√çMICA SANGU√çNEA">QU√çMICA SANGU√çNEA</option>
                            <option value="DESCARTE HEMOPARASITO">DESCARTE HEMOPARASITO</option>
                            <option value="DISTEMPER">DISTEMPER</option>
                            <option value="PARVOVIRUS - CORONAVIRUS">PARVOVIRUS - CORONAVIRUS</option>
                            <option value="FILARIASIS">FILARIASIS</option>
                            <option value="SIDA - LEUCEMIA">SIDA - LEUCEMIA</option>
                            <option value="HEMATOLOGIA+QUIMICA+HEMOPARASITOS">COMBO LABORATORIO</option>
                            <option value="EXAMEN DE HECES">EXAMEN DE HECES</option>
                            <option value="EXAMENES DE ORINA">EXAMENES DE ORINA</option>
                            <option value="CITOLOGIA 1 OIDO">CITOLOG√çA 1 O√çDO</option>
                            <option value="CITOLOGIA 2 OIDOS">CITOLOG√çA 2 O√çDOS</option>
                            <option value="RASPADO PIEL">RASPADO PIEL</option>
                            <option value="PERFIL ANEMICO">PERFIL AN√âMICO</option>
                        </optgroup>
                        <optgroup label="üêæ OTROS PROCEDIMIENTOS">
                            <option value="ABSCESO">ABSCESO</option>
                            <option value="ECOGRAF√çA">ECOGRAF√çA</option>
                            <option value="EUTANASIA HASTA 5KG">EUTANASIA HASTA 5KG</option>
                            <option value="EUTANASIA HASTA 15KG">EUTANASIA HASTA 15KG</option>
                            <option value="EUTANASIA HASTA 25KG">EUTANASIA HASTA 25KG</option>
                            <option value="EUTANASIA HASTA 35KG">EUTANASIA HASTA 35KG</option>
                            <option value="KG ADICIONAL">KG ADICIONAL</option>
                            <option value="DISPOSICION">DISPOSICI√ìN</option>
                            <option value="CREMACION CON CENIZAS">CREMACI√ìN CON CENIZAS</option>
                        </optgroup>
                    </select>
                </div>
                <textarea id="hTratamiento" class="w-full h-64 p-4 text-sm font-medium leading-relaxed bg-white outline-none" placeholder="Escriba aqu√≠ el diagn√≥stico..." oninput="document.getElementById('hTratamientoPrint').innerText = this.value"></textarea>
                <div id="hTratamientoPrint" class="hidden print:block p-4 whitespace-pre-wrap text-sm leading-relaxed border-none"></div>
            </div>

            <div id="contenedorInsumos" class="no-print mt-4 mb-6 border-2 border-blue-100 rounded-xl overflow-hidden hidden">
                <table class="w-full text-[11px] text-left">
                    <thead class="bg-blue-600 text-white uppercase italic">
                        <tr>
                            <th class="p-2">Insumo</th>
                            <th class="p-2 w-16 text-center">Cant.</th>
                            <th class="p-2 w-16 text-center">Precio $</th>
                            <th class="p-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="listaInsumosDinamica" class="bg-white"></tbody>
                </table>
                <div class="bg-slate-50 p-2 border-t border-blue-100 flex gap-2 items-center">
                    <input type="text" id="nombreExtra" placeholder="A√±adir algo extra..." class="flex-1 text-[10px] p-2 border rounded bg-white">
                    <input type="number" id="costoExtra" placeholder="0.00" class="w-14 text-[10px] p-2 border rounded bg-white">
                    <button onclick="window.agregarInsumoManual()" class="bg-blue-600 text-white px-4 py-2 rounded text-[10px] font-black">+ AGREGAR</button>
                </div>
            </div>

            <div class="no-print flex justify-center mb-6">
    <div class="w-full md:w-2/3 lg:w-1/2 bg-blue-50 p-6 rounded-3xl border-2 border-blue-200 text-center shadow-inner">
        <label class="text-[10px] text-blue-600 font-bold uppercase block mb-1 tracking-widest">Monto Total a Cobrar ($)</label>
        <input type="number" id="precioVenta" value="0" oninput="window.calcularTodo()" 
               class="text-5xl font-black w-full bg-transparent text-center text-blue-700 outline-none placeholder-blue-300">
    </div>

    <div id="displayGananciaDoctor" class="hidden">
        <p id="montoDoctor">$ 0.00</p>
    </div>
    <input type="number" id="gastoInsumos" value="0" class="hidden" readonly>
</div>
            <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="guardarFirebase(false)" class="bg-slate-200 py-4 rounded-xl font-black uppercase text-xs">Guardar Datos</button>
                <button type="button" onclick="guardarFirebase(true)" class="bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">Guardar e Imprimir</button>
            </div>
            <button type="button" onclick="imprimirRecetaLimpia()" class="w-full bg-cyan-500 text-white py-4 rounded-xl font-black uppercase text-xs mt-3">üìÑ Receta Sin Costos</button>
        </section>

        <!-- ========== BUSCADOR ========== -->
        <section id="sectionBuscador" class="hidden p-4 animate-fadeIn">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100 max-w-2xl mx-auto">
                <h2 class="text-blue-600 font-black uppercase text-center mb-6">üîé Central de B√∫squeda</h2>
                <div class="flex gap-2 mb-6">
                    <input type="text" id="searchCI" placeholder="C√©dula del propietario..." class="w-full p-4 border rounded-xl outline-none focus:border-blue-500">
                    <button onclick="window.buscarPorCedula()" class="bg-blue-600 text-white px-6 rounded-xl font-bold">BUSCAR</button>
                </div>
                <div id="resultadosBusqueda" class="space-y-4"></div>
            </div>
        </section>

        <!-- ========== REPORTE / CAJA ========== -->
        <section id="sectionReporte" class="hidden p-4 animate-fadeIn">
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm max-w-2xl mx-auto">
                <h2 class="font-black text-center mb-2 uppercase text-slate-700 text-2xl tracking-tighter">Gesti√≥n de Caja Diaria</h2>
                
                <div class="text-center mb-4">
                    <span class="bg-slate-100 text-slate-500 px-4 py-1 rounded-full text-[10px] font-bold uppercase border border-slate-200">
                        Pacientes: <span id="totalPacientes" class="text-slate-800">0</span>
                    </span>
                </div>

                <div id="listaReporte" class="divide-y mb-6 text-[10px] max-h-40 overflow-y-auto bg-slate-50 p-2 rounded-lg border border-slate-100"></div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <p class="text-[10px] font-bold uppercase text-slate-400">Bruto Total</p>
                        <p id="repBruto" class="text-2xl font-black text-slate-700 font-mono">$0.00</p>
                    </div>

                    <div class="p-4 bg-amber-50 rounded-2xl border-l-4 border-amber-400">
                        <p class="text-[10px] font-bold uppercase text-amber-600">Costos Operativos</p>
                        <p id="repGastos" class="text-2xl font-black text-amber-700 font-mono">$0.00</p>
                    </div>
                    
                    <div class="p-4 bg-blue-50 rounded-2xl border-l-4 border-blue-400 col-span-2 space-y-2">
                        <div class="flex justify-between items-center border-b border-blue-100 pb-1">
                            <span class="text-[11px] font-black uppercase text-blue-800">Dr. Darwin Sandoval:</span>
                            <span id="repDocSandoval" class="text-lg font-black text-blue-600 font-mono">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center pt-1">
                            <span class="text-[11px] font-black uppercase text-blue-800">Dra. Joan Silva:</span>
                            <span id="repDocSilva" class="text-lg font-black text-blue-600 font-mono">$0.00</span>
                        </div>
                    </div>

                    <div class="p-4 bg-emerald-50 rounded-2xl border-l-4 border-emerald-500 col-span-2 shadow-sm">
                        <p class="text-[10px] font-bold uppercase text-emerald-600">Utilidad Neta (Avipet)</p>
                        <p id="repNeto" class="text-3xl font-black text-emerald-700 font-mono">$0.00</p>
                    </div>
                </div>
<div id="contenedorAnalisis" class="hidden mt-6 pt-6 border-t-2 border-slate-100 animate-fadeIn">
    <h3 class="text-center font-black text-indigo-900 uppercase text-sm mb-4 tracking-widest">üìä An√°lisis Estrat√©gico Mensual</h3>
    
    <div id="gridAnalisis" class="grid grid-cols-2 gap-3 mb-4">
        </div>

    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 mb-6">
        <p class="text-[10px] font-bold uppercase text-indigo-600 mb-2">Desempe√±o de Equipo</p>
        <div id="analisisDoctores" class="space-y-2">
            </div>
    </div>
</div>

<button onclick="generarAnalisisCompleto()" class="w-full mb-4 bg-indigo-600 text-white py-3 rounded-xl font-black shadow-lg active:scale-95 transition-all uppercase text-xs">
    üìà Generar An√°lisis Inteligente
</button>
                <div class="flex flex-col gap-2">
                    <button onclick="cargarReporte()" class="w-full bg-slate-700 text-white py-3 rounded-xl font-black shadow-md active:scale-95 transition-all uppercase text-xs">
                        üîÑ Actualizar Balance
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="descargarReporte()" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-black text-[10px] hover:bg-slate-200 transition-colors uppercase">
                            üì• Descargar TXT
                        </button>
                        <button onclick="guardarResumenDelDia()" class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[10px] shadow-md hover:bg-emerald-700 transition-colors uppercase">
                            üíæ Guardar en Nube
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== CONFIG PRECIOS ========== -->
       <section id="sectionConfigPrecios" class="hidden p-4 animate-fadeIn">
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg max-w-4xl mx-auto">
        <h2 class="text-2xl font-black text-blue-900 mb-2 uppercase italic">üõ† Panel de Control Maestro</h2>
        <p class="text-[10px] text-slate-500 mb-6 font-bold uppercase tracking-widest text-center border-b pb-2">Gesti√≥n de Tarifas, Comisiones y Costos de Materiales</p>

        <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
            <button onclick="window.cambiarSubTabConfig('servicios')" id="btnTabServ" class="flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-blue-600 shadow-sm">
                üíâ Servicios y Ganancias
            </button>
            <button onclick="window.cambiarSubTabConfig('insumos')" id="btnTabIns" class="flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg-white/50">
                üì¶ Costo de Insumos
            </button>
        </div>

        <div id="areaBtnAgregarInsumo" class="hidden mb-4 flex justify-end">
            <button onclick="window.agregarInsumoNuevoManual()" 
                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow-md font-black text-[10px] uppercase transition-all">
                ‚ûï Agregar Insumo Nuevo
            </button>
        </div>

        <div id="bannerSincro" class="mb-6 p-4 bg-orange-50 border border-orange-200 rounded-xl flex items-center justify-between gap-4">
            <div class="flex-1">
                <h3 class="text-[10px] font-black text-orange-600 uppercase">Sincronizaci√≥n Maestra</h3>
                <p class="text-[9px] text-orange-400">Usa esto solo para subir los datos del c√≥digo a la nube por primera vez.</p>
            </div>
            <button onclick="window.inicializarBaseDeDatosCompleta()" class="bg-orange-600 text-white px-6 py-3 rounded-xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-transform">
                üöÄ Sincronizar Todo
            </button>
        </div>

        <div id="contenedorTabServicios" class="overflow-x-auto bg-slate-50 rounded-xl border border-slate-100 p-2">
            <table class="w-full text-left text-[12px]">
                <thead>
                    <tr class="text-blue-900 font-black uppercase text-[10px]">
                        <th class="p-3">Servicio / Tratamiento</th>
                        <th class="p-3 w-28 text-center">Precio ($)</th>
                        <th class="p-3 w-28 text-center">Doc (%)</th>
                        <th class="p-3 w-24 text-center">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaMaestraServicios" class="bg-white divide-y"></tbody>
            </table>
        </div>

        <div id="contenedorTabInsumos" class="hidden overflow-x-auto bg-slate-50 rounded-xl border border-slate-100 p-2">
            <table class="w-full text-left text-[12px]">
                <thead>
                    <tr class="text-emerald-900 font-black uppercase text-[10px]">
                        <th class="p-3">Insumo / Material</th>
                        <th class="p-3 w-32 text-center">Costo Unitario ($)</th>
                        <th class="p-3 w-24 text-center">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaMaestraInsumos" class="bg-white divide-y"></tbody>
            </table>
        </div>
    </div>
           <div id="modalLogin" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full border border-slate-200">
        <h3 class="text-center font-black text-slate-700 uppercase text-sm mb-4">üîê Acceso Privado</h3>
        <input type="password" id="inputPass" placeholder="Ingrese PIN" class="w-full p-3 rounded-xl border border-slate-200 mb-2 text-center text-lg font-mono">
        
        <button onclick="validarAcceso()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black uppercase text-xs mb-3">Entrar</button>
        
        <button onclick="recuperarPin()" class="w-full text-slate-400 text-[10px] uppercase font-bold hover:text-indigo-600 transition-colors">
            He olvidado mi PIN
        </button>
        <button onclick="cerrarModalLogin()" class="w-full mt-2 text-red-400 text-[10px] uppercase font-bold">Cancelar</button>
    </div>
</div>
</section>
<script type="module">
    // ==========================================================================
    // [01] IMPORTACIONES Y CONFIGURACI√ìN FIREBASE
    // ==========================================================================
    import { db } from './firebase-config.js';
import { 
    collection, addDoc, query, where, getDocs, serverTimestamp, 
    doc, getDoc, setDoc, updateDoc,
    orderBy // <--- SOLDADURA REALIZADA: Agregamos la herramienta de ordenamiento
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================================================================
    // [02] CAT√ÅLOGOS, DATA MAESTRA Y UTILIDADES
    // ==========================================================================
    const normalizarNombre = (n) => {
        if (!n) return "";
        return n.toLowerCase()
            .replace(/\s+/g, '')
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    };

    // ==========================================================================
// [02] CAT√ÅLOGO MAESTRO DE SERVICIOS E INSUMOS (VERSI√ìN BLINDADA)
// ==========================================================================

const CONFIG_SERVICIOS = {
    "CONSULTA GENERAL": { precio: 0, porc: 40 },
    "CONSULTA OFTALMOL√ìGICA": { precio: 0, porc: 12.5 },
    "CONSULTA CAMADA 3-4 CACHORROS": { precio: 0, porc: 40 },
    "CONSULTA CAMADA HASTA 8 CACHORROS": { precio: 0, porc: 40 },
    "CONSULTA CAMADA MAS DE 8 CACHORROS": { precio: 0, porc: 40 },
    "ABSCESO": { precio: 0, porc: 50 },
    "ECOGRAF√çA": { precio: 0, porc: 40 },
    "COLOCACION VIA": { precio: 0, porc: 50 },
    "ADMINISTRACION MEDICINA": { precio: 0, porc: 50 },
    "TOMA DE MUESTRA SANGRE": { precio: 0, porc: 50 },
    "VACUNA SEXTUPLE": { precio: 0, porc: 50 },
    "VACUNA PUPPY": { precio: 0, porc: 50 },
    "VACUNA ANTIRR√ÅBICA": { precio: 0, porc: 50 },
    "VACUNA KC (TOS DE LAS PERRERAS)": { precio: 0, porc: 50 },
    "VACUNA TRIPLE FELINA": { precio: 0, porc: 50 },
    "VACUNA QUINTUPLE FELINA": { precio: 0, porc: 50 },
    "VACUNA BIOVETA": { precio: 0, porc: 50 },
    "HEMATOLOG√çA COMPLETA": { precio: 0, porc: 34.78 },
    "QU√çMICA SANGU√çNEA": { precio: 0, porc: 50 },
    "DESCARTE HEMOPARASITO": { precio: 0, porc: 50 },
    "DISTEMPER": { precio: 0, porc: 50 },
    "PARVOVIRUS - CORONAVIRUS": { precio: 0, porc: 50 },
    "FILARIASIS": { precio: 0, porc: 50 },
    "SIDA - LEUCEMIA": { precio: 0, porc: 50 },
    "HEMATOLOGIA + QUIMICA + HEMOPARASITOS": { precio: 0, porc: 50 },
    "EXAMEN DE HECES": { precio: 0, porc: 50 },
    "EXAMENES DE ORINA": { precio: 0, porc: 50 },
    "CITOLOGIA 1 OIDO": { precio: 0, porc: 50 },
    "CITOLOGIA 2 OIDOS": { precio: 0, porc: 50 },
    "RASPADO PIEL": { precio: 0, porc: 50 },
    "PERFIL ANEMICO": { precio: 0, porc: 17.5 },
    "CITOLOGIA FLUIDOS, SECRECIONES": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 5KG": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 15KG": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 25KG": { precio: 0, porc: 50 },
    "EUTANASIA HASTA 35KG": { precio: 0, porc: 50 },
    "KG ADICIONAL": { precio: 0, porc: 0 },
    "DISPOSICION": { precio: 0, porc: 0 },
    "CREMACION CON CENIZAS": { precio: 0, porc: 0 },
    "REFERIDO: EXAMEN DE HECES": { precio: 0, porc: 50 },
    "REFERIDO: EXAMENES DE ORINA": { precio: 0, porc: 50 },
    "REFERIDO: CULTIVOS": { precio: 0, porc: 50 },
    "REFERIDO: DESCARTE HEMOPARASITO": { precio: 0, porc: 50 },
    "REFERIDO: DISTEMPER": { precio: 0, porc: 50 },
    "REFERIDO: PARVOVIRUS - CORONAVIRUS": { precio: 0, porc: 50 }
};

const insumosFijosMedicos = [
    { nombre: "Guantes de examen", costo: 0.50 }, 
    { nombre: "Alcohol", costo: 0.10 }, 
    { nombre: "Algod√≥n", costo: 0.10 },
    { nombre: "Hojas - Papeler√≠a", costo: 0.10 }
];

const insumosBaseVacuna = [
    { nombre: "Jeringa 3cc", costo: 0.25 }, 
    { nombre: "Xeruk", costo: 0.10 }, 
    { nombre: "Crema", costo: 0.10 }
];

const recetas = {
    "CONSULTA GENERAL": { precioVenta: 30, insumos: [{ nombre: "Crema", costo: 0.50 }] },
    "CONSULTA OFTALMOL√ìGICA": { precioVenta: 80, insumos: [{ nombre: "Tiras Fluoresce√≠na - Insumos", costo: 2.50 }] },
    "CONSULTA CAMADA 3-4 CACHORROS": { precioVenta: 50, insumos: [{ nombre: "Insumos Camada", costo: 2.00 }] },
    "CONSULTA CAMADA HASTA 8 CACHORROS": { precioVenta: 80, insumos: [{ nombre: "Insumos Camada Grande", costo: 4.00 }] },
    "CONSULTA CAMADA MAS DE 8 CACHORROS": { precioVenta: 100, insumos: [{ nombre: "Insumos Camada XL", costo: 6.00 }] },
    "ABSCESO": { precioVenta: 25, insumos: [{ nombre: "Jelco", costo: 4.50 }, { nombre: "Agua Oxigenada", costo: 0.50 }, { nombre: "Compresa", costo: 0.50 }, { nombre: "Antibiotico", costo: 0.50 }, { nombre: "Antinflamatorio", costo: 0.50 }, { nombre: "Sedacion", costo: 0.50 }] },
    "ECOGRAF√çA": { precioVenta: 40, insumos: [{ nombre: "Gel Ecogr√°fico", costo: 1.00 }, { nombre: "Papel Absorbente", costo: 0.50 }, { nombre: "Toall√≠n/Servilletas", costo: 0.30 }] },
    "COLOCACION VIA": { precioVenta: 15, insumos: [{ nombre: "Jelco", costo: 1.50 }, { nombre: "Jeringa 5cc", costo: 0.50 }, { nombre: "Adhesivo", costo: 0.30 }, { nombre: "Mariposa", costo: 1.00 }, { nombre: "Obturador", costo: 1.00 }] },
    "ADMINISTRACION MEDICINA": { precioVenta: 10, insumos: [{ nombre: "Jeringa", costo: 0.50 }] },
    "TOMA DE MUESTRA SANGRE": { precioVenta: 10, insumos: [{ nombre: "Jeringa", costo: 0.50 }, { nombre: "Mariposa", costo: 1.00 }, { nombre: "Tubo Morado o Naranja", costo: 1.20 }] },
    "VACUNA SEXTUPLE": { precioVenta: 40, insumos: [{ nombre: "Vial Sextuple", costo: 8.50 }] },
    "VACUNA PUPPY": { precioVenta: 40, insumos: [{ nombre: "Vial Puppy", costo: 7.00 }] },
    "VACUNA ANTIRR√ÅBICA": { precioVenta: 30, insumos: [{ nombre: "Vial Antirr√°bica", costo: 4.00 }] },
    "VACUNA KC (TOS DE LAS PERRERAS)": { precioVenta: 45, insumos: [{ nombre: "Vial KC", costo: 9.00 }] },
    "VACUNA TRIPLE FELINA": { precioVenta: 45, insumos: [{ nombre: "Vial Triple Felina", costo: 10.00 }] },
    "VACUNA QUINTUPLE FELINA": { precioVenta: 50, insumos: [{ nombre: "Vial Quintuple Felina", costo: 15.00 }] },
    "VACUNA BIOVETA": { precioVenta: 60, insumos: [{ nombre: "Vial Bioveta", costo: 6.50 }] },
    "HEMATOLOG√çA COMPLETA": { precioVenta: 23, insumos: [{ nombre: "Tubo EDTA - Reactivos", costo: 4.50 }] },
    "QU√çMICA SANGU√çNEA": { precioVenta: 60, insumos: [{ nombre: "Tubo Seco - Reactivos Qu√≠mica", costo: 10.00 }] },
    "DESCARTE HEMOPARASITO": { precioVenta: 50, insumos: [{ nombre: "Test Hemopar√°sitos", costo: 9.00 }] },
    "DISTEMPER": { precioVenta: 35, insumos: [{ nombre: "Kit Test Distemper", costo: 11.00 }] },
    "PARVOVIRUS - CORONAVIRUS": { precioVenta: 35, insumos: [{ nombre: "Kit Test Parvo - Corona", costo: 12.00 }] },
    "FILARIASIS": { precioVenta: 40, insumos: [{ nombre: "Kit Test Filarias", costo: 11.00 }] },
    "SIDA - LEUCEMIA": { precioVenta: 40, insumos: [{ nombre: "Kit Test Sida - Leucemia", costo: 15.00 }] },
    "HEMATOLOGIA + QUIMICA + HEMOPARASITOS": { precioVenta: 110, insumos: [{ nombre: "Pack Laboratorio Completo", costo: 25.00 }] },
    "EXAMEN DE HECES": { precioVenta: 10, insumos: [{ nombre: "Portas - Soluci√≥n - Envase", costo: 1.50 }] },
    "EXAMENES DE ORINA": { precioVenta: 10, insumos: [{ nombre: "Tira Reactiva - Sedimento", costo: 2.00 }] },
    "CITOLOGIA 1 OIDO": { precioVenta: 15, insumos: [{ nombre: "Hisopo - Tincion", costo: 2.50 }] },
    "CITOLOGIA 2 OIDOS": { precioVenta: 20, insumos: [{ nombre: "Hisopos - Tinciones", costo: 4.00 }] },
    "RASPADO PIEL": { precioVenta: 10, insumos: [{ nombre: "Hoja Bistur√≠ - Aceite - Porta", costo: 3.00 }] },
    "PERFIL ANEMICO": { precioVenta: 25, insumos: [{ nombre: "Kit Anemia", costo: 8.00 }] },
    "CITOLOGIA FLUIDOS, SECRECIONES": { precioVenta: 20, insumos: [{ nombre: "Insumos Citolog√≠a Especial", costo: 5.00 }] },
    "EUTANASIA HASTA 5KG": { precioVenta: 80, insumos: [{ nombre: "Propofol", costo: 4.00 }, { nombre: "Xilacina", costo: 1.00 }] },
    "EUTANASIA HASTA 15KG": { precioVenta: 110, insumos: [{ nombre: "Propofol", costo: 7.00 }, { nombre: "Xilacina", costo: 2.00 }] },
    "EUTANASIA HASTA 25KG": { precioVenta: 140, insumos: [{ nombre: "Propofol", costo: 10.00 }, { nombre: "Xilacina", costo: 3.00 }] },
    "EUTANASIA HASTA 35KG": { precioVenta: 170, insumos: [{ nombre: "Propofol", costo: 15.00 }, { nombre: "Xilacina", costo: 4.00 }] }
};

    // ==========================================================================
    // [03] VARIABLES DE ESTADO Y SEGURIDAD
    // ==========================================================================
    const pinsDoctores = { "Darwin Sandoval": "1111", "Joan Silva": "2222" };
    let doctorVerificado = ""; 
    let serviciosEnLista = [];

    window.validarAccesoDoctor = async (nombre) => {
        if (!nombre) { 
            doctorVerificado = ""; 
            document.getElementById('doctorPrint').innerText = "SELECCIONE DOCTOR"; 
            return; 
        }
        const pinIngresado = prompt(`ACCESO RESTRINGIDO: PIN para ${nombre.toUpperCase()}:`);
        if (pinIngresado === pinsDoctores[nombre]) {
            doctorVerificado = nombre; 
            const prefijo = (nombre === "Joan Silva") ? "DRA. " : "DR. ";
            document.getElementById('doctorPrint').innerText = prefijo + nombre.toUpperCase();
            alert(`‚úÖ Identidad confirmada: ${prefijo}${nombre}`);
            await window.calcularTodo();
        } else {
            alert("‚ùå PIN INCORRECTO.");
            document.getElementById('selectDoctor').value = "";
            doctorVerificado = "";
            document.getElementById('doctorPrint').innerText = "SELECCIONE DOCTOR";
        }
    };

    window.insertarServicio = async (v) => {
    if (!v) return;
    const area = document.getElementById('hTratamiento');
    
    let nombreFinal = v;
    let precioFinal = 0;
    let porcentajeServicio = 30; 

    const vLimpio = normalizarNombre(v);

    try {
        const docRef = doc(db, "servicios_maestro", v);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            precioFinal = parseFloat(data.precioVenta) || 0;
            porcentajeServicio = parseFloat(data.porcDoc) || 30;
        } else {
            const llaveReceta = Object.keys(recetas).find(k => normalizarNombre(k) === vLimpio);
            const llaveConfig = Object.keys(CONFIG_SERVICIOS).find(k => normalizarNombre(k) === vLimpio);

            precioFinal = llaveReceta ? recetas[llaveReceta].precioVenta : 0;
            porcentajeServicio = llaveConfig ? CONFIG_SERVICIOS[llaveConfig].porc : 30;
        }
    } catch (e) {
        console.warn("‚ö†Ô∏è Error de conexi√≥n. Usando respaldo local con normalizaci√≥n.");
        const llaveReceta = Object.keys(recetas).find(k => normalizarNombre(k) === vLimpio);
        const llaveConfig = Object.keys(CONFIG_SERVICIOS).find(k => normalizarNombre(k) === vLimpio);
        
        precioFinal = llaveReceta ? recetas[llaveReceta].precioVenta : 0;
        porcentajeServicio = llaveConfig ? CONFIG_SERVICIOS[llaveConfig].porc : 30;
    }

    // ========== SECCI√ìN RECTIFICADA POR ALBERT (EXCEPCIONES DE NEGOCIO) ==========
    if (vLimpio.includes("kgadicional")) {
        const kgs = prompt("Ingrese la cantidad de KG adicionales:");
        if (kgs && !isNaN(kgs)) {
            const numKgs = parseFloat(kgs);
            nombreFinal = `KG ADICIONAL (${numKgs}kg)`;
            precioFinal = numKgs * 7; 
            porcentajeServicio = 0; 
        } else return;
    } 
    else if (vLimpio === "disposicion" || vLimpio === "cremacionconcenizas") {
        const monto = prompt(`Precio pactado para ${v}:`);
        if (monto && !isNaN(monto)) {
            precioFinal = parseFloat(monto);
            porcentajeServicio = 0;
        } else return;
    }
    else {
        // L√≥gica de Combos Espec√≠ficos por Familia
        if (vLimpio.includes("vacunakc")) {
            const tieneOtraVacuna = serviciosEnLista.some(s => {
                const n = normalizarNombre(s);
                return n.includes("vacuna") || n.includes("sextuple") || n.includes("puppy") || n.includes("antirrabica") || n.includes("triplefelina");
            });

            if (tieneOtraVacuna) {
                precioFinal = 40; 
                nombreFinal += " (Combo)";
            } else {
                precioFinal = 45;
            }
        } 
        else if (vLimpio.includes("hematologiacompleta")) {
            const tieneOtroLab = serviciosEnLista.some(s => {
                const n = normalizarNombre(s);
                return n.includes("quimica") || n.includes("hemoparasito") || n.includes("heces") || n.includes("orina") || n.includes("perfil") || n.includes("citologia");
            });

            if (tieneOtroLab) {
                precioFinal = 20;
                nombreFinal += " (Combo)";
            } else {
                precioFinal = 23;
            }
        }
    }
    // ========== FIN DE LA SECCI√ìN RECTIFICADA ==========

    const grupoID = "srv-" + Date.now();
    serviciosEnLista.push(v);
    area.value += (area.value ? "\n" : "") + "=> " + nombreFinal;
    
    document.getElementById('contenedorInsumos').classList.remove('hidden');
    const cuerpo = document.getElementById('listaInsumosDinamica');
    
    const filaTitulo = document.createElement('tr');
    filaTitulo.className = "bg-slate-50 border-b-2 border-slate-200 text-slate-700 font-black servicio-principal";
    filaTitulo.setAttribute('data-grupo', grupoID);
    filaTitulo.setAttribute('data-precio', precioFinal);
    filaTitulo.setAttribute('data-porc', porcentajeServicio); 

    filaTitulo.innerHTML = `
        <td colspan="3" class="p-2 text-[11px] uppercase">
            üîπ ${nombreFinal} ($${precioFinal.toFixed(2)}) 
            <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full ml-2 text-[9px] border border-blue-200">
                ${porcentajeServicio.toFixed(1)}% DOC
            </span>
        </td>
        <td class="p-2 text-center">
            <button onclick="window.eliminarServicioCompleto('${grupoID}', ${precioFinal}, event)" class="text-red-500 font-bold text-lg">√ó</button>
        </td>`;
    cuerpo.appendChild(filaTitulo);

    let listaNuevos = [];
    if (cuerpo.querySelectorAll('.servicio-principal').length === 1) { 
        listaNuevos = [...insumosFijosMedicos]; 
    }
    
    if (vLimpio.includes("vacuna")) {
        const yaHayVacuna = Array.from(cuerpo.querySelectorAll('td')).some(td => td.innerText.includes("VIAL"));
        if (!yaHayVacuna) listaNuevos = [...listaNuevos, ...insumosBaseVacuna];
    }

    const llaveRecetaIns = Object.keys(recetas).find(k => normalizarNombre(k) === vLimpio);
    if (llaveRecetaIns && recetas[llaveRecetaIns].insumos) { 
        listaNuevos = [...listaNuevos, ...recetas[llaveRecetaIns].insumos]; 
    }

    listaNuevos.forEach(insumo => {
        const tr = document.createElement('tr');
        tr.className = `border-b border-gray-100 insumo-fila ${grupoID}`; 
        tr.innerHTML = `
            <td class="p-2 font-bold text-gray-700 text-[11px] italic">${insumo.nombre.toUpperCase()}</td>
            <td class="p-2 text-center"><input type="number" value="1" oninput="window.calcularTodo()" class="i-cant w-12 text-center border rounded"></td>
            <td class="p-2 text-center"><input type="number" value="${insumo.costo.toFixed(2)}" step="0.01" oninput="window.calcularTodo()" class="i-cost w-16 text-center border rounded"></td>
            <td class="p-2 text-center text-red-500 font-bold cursor-pointer" onclick="this.parentElement.remove(); window.calcularTodo()">‚úï</td>`;
        cuerpo.appendChild(tr);
    });

    await window.calcularTodo();
    document.getElementById('selectorServicios').value = "";
};

 window.eliminarServicioCompleto = async (idGrupo, precioARestar, event) => {
    if (event) event.preventDefault();
    if (!confirm("¬øEliminar este servicio y sus insumos?")) return;

    const area = document.getElementById('hTratamiento');
    const filaTitulo = document.querySelector(`[data-grupo="${idGrupo}"]`);
    
    if (filaTitulo) {
        // --- NUEVO: Limpieza de Tratamiento y Descripci√≥n ---
        // Extraemos el nombre tal cual se muestra (sin el emoji ni el precio)
        // Ejemplo: de "üîπ VACUNA KC ($45.00)" extraemos "VACUNA KC"
        const nombreParaTexto = filaTitulo.innerText.split('($')[0].replace('üîπ', '').trim();
        
        if (area && area.value) {
            const lineas = area.value.split('\n');
            // Filtramos el array: mantenemos solo las l√≠neas que NO incluyen el nombre que borramos
            const lineasLimpias = lineas.filter(linea => !linea.includes("=> " + nombreParaTexto));
            area.value = lineasLimpias.join('\n');
        }

        // 1. Limpiamos el array de control
        const nombreBorrando = normalizarNombre(filaTitulo.innerText);
        const index = serviciosEnLista.indexOf(nombreBorrando);
        if (index !== -1) serviciosEnLista.splice(index, 1);
        
        filaTitulo.remove();
    }

    // 2. Borrar insumos asociados
    document.querySelectorAll('.' + idGrupo).forEach(el => el.remove());

    // 3. RE-EVALUACI√ìN DIN√ÅMICA (Escaneo de Gremio)
    const filasRestantes = document.querySelectorAll('.servicio-principal');
    
    filasRestantes.forEach(fila => {
        const texto = normalizarNombre(fila.innerText);
        
        if (texto.includes("vacunakc")) {
            const tieneOtraVacuna = Array.from(filasRestantes).some(f => {
                const n = normalizarNombre(f.innerText);
                return f !== fila && (n.includes("vacuna") || n.includes("sextuple") || n.includes("puppy") || n.includes("antirrabica"));
            });

            if (!tieneOtraVacuna) {
                fila.setAttribute('data-precio', 45);
                fila.querySelector('td').innerHTML = fila.querySelector('td').innerHTML
                    .replace("40.00", "45.00").replace("(Combo)", "").replace("(COMBO)", "");
            }
        }
        
        if (texto.includes("hematologiacompleta")) {
            const tieneOtroLab = Array.from(filasRestantes).some(f => {
                const n = normalizarNombre(f.innerText);
                return f !== fila && (n.includes("quimica") || n.includes("hemoparasito") || n.includes("perfil") || n.includes("examen"));
            });

            if (!tieneOtroLab) {
                fila.setAttribute('data-precio', 23);
                fila.querySelector('td').innerHTML = fila.querySelector('td').innerHTML
                    .replace("20.00", "23.00").replace("(Combo)", "").replace("(COMBO)", "");
            }
        }
    });

    // 4. Actualizar el input de precio (Rec√°lculo real basado en lo que qued√≥)
    const inputPrecioVenta = document.getElementById('precioVenta');
    if (inputPrecioVenta) {
        let nuevoTotalVenta = 0;
        document.querySelectorAll('.servicio-principal').forEach(f => {
            nuevoTotalVenta += parseFloat(f.getAttribute('data-precio')) || 0;
        });
        inputPrecioVenta.value = nuevoTotalVenta.toFixed(2);
    }

    // 5. Recalcular todo (Darwin y Joan reciben el monto correcto)
    await window.calcularTodo();
};
    window.agregarInsumoManual = () => {
        const n = document.getElementById('nombreExtra');
        const c = document.getElementById('costoExtra');
        if (!n.value) return alert("Ingrese nombre del insumo.");
        const todasLasFilas = document.querySelectorAll('.servicio-principal');
        const ultimoGrupo = todasLasFilas.length > 0 ? todasLasFilas[todasLasFilas.length - 1].getAttribute('data-grupo') : "manual"; 
        const tr = document.createElement('tr');
        tr.className = `border-b border-gray-100 insumo-fila bg-yellow-50 ${ultimoGrupo}`;
        tr.innerHTML = `
            <td class="p-2 font-bold text-[11px] italic">‚ûï ${n.value.toUpperCase()}</td>
            <td class="p-2 text-center"><input type="number" value="1" oninput="window.calcularTodo()" class="i-cant w-12 text-center border rounded"></td>
            <td class="p-2 text-center"><input type="number" value="${parseFloat(c.value || 0).toFixed(2)}" step="0.01" oninput="window.calcularTodo()" class="i-cost w-16 text-center border rounded"></td>
            <td class="p-2 text-center text-red-500 font-bold cursor-pointer" onclick="this.parentElement.remove(); window.calcularTodo()">‚úï</td>`;
        document.getElementById('listaInsumosDinamica').appendChild(tr);
        n.value = ""; c.value = ""; window.calcularTodo(); 
    };

    // ==========================================================================
    // [05] MOTOR FINANCIERO
    // ==========================================================================
    window.calcularTodo = async () => {
    let totalComisionDoctores = 0;
    let totalGastosInsumos = 0;
    let totalVentaCalculada = 0;

    // 1. En lugar de ir a la nube cada vez, intentamos usar una variable global
    // Si no existe, la buscamos UNA VEZ.
    if (window.porcGlobalCache === undefined) {
        try {
            const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const configSnap = await getDoc(doc(db, "configuracion", "tarifas"));
            window.porcGlobalCache = configSnap.exists() ? (configSnap.data().porcDoc ?? configSnap.data().porcentajeDoc) : null;
        } catch (e) {
            window.porcGlobalCache = null;
        }
    }

    const filasServicios = document.querySelectorAll('.servicio-principal');
    
    filasServicios.forEach(fila => {
        const precioServicio = parseFloat(fila.getAttribute('data-precio')) || 0;
        const porcServicioDefault = parseFloat(fila.getAttribute('data-porc')) || 0;
        
        // Prioridad: 1. Porcentaje Global de la DB | 2. Porcentaje espec√≠fico del servicio
        const porcAEfectuar = (window.porcGlobalCache !== null && window.porcGlobalCache !== undefined) 
                               ? window.porcGlobalCache 
                               : porcServicioDefault;
        
        totalVentaCalculada += precioServicio;
        
        const grupoID = fila.getAttribute('data-grupo');
        let gastosGrupo = 0;

        // 2. SUMA DE INSUMOS (Aqu√≠ es donde el combo se "desarma" y se suma correctamente)
        const insumosDelGrupo = document.querySelectorAll(`.${grupoID}.insumo-fila`);
        insumosDelGrupo.forEach(insumo => {
            const cant = parseFloat(insumo.querySelector('.i-cant').value) || 0;
            const cost = parseFloat(insumo.querySelector('.i-cost').value) || 0;
            gastosGrupo += (cant * cost);
        });

        totalGastosInsumos += gastosGrupo;
        
        // 3. C√ÅLCULO DE COMISI√ìN (Base Neta)
        // Se resta el gasto de insumos ANTES de aplicar el porcentaje
        const utilidadNetaServicio = precioServicio - gastosGrupo;
        if (utilidadNetaServicio > 0) {
            totalComisionDoctores += (utilidadNetaServicio * (porcAEfectuar / 100));
        }
    });

    // 4. ACTUALIZAR INTERFAZ
    const inputVenta = document.getElementById('precioVenta');
    if (inputVenta) inputVenta.value = totalVentaCalculada.toFixed(2);

    const inputGasto = document.getElementById('gastoInsumos');
    if (inputGasto) inputGasto.value = totalGastosInsumos.toFixed(2);

    const displayDr = document.getElementById('montoDoctor');
    if (displayDr) displayDr.innerText = `$ ${totalComisionDoctores.toFixed(2)}`;

    console.log(`‚úÖ Combo Calculado: Bruto $${totalVentaCalculada} | Insumos $${totalGastosInsumos} | Dr $${totalComisionDoctores.toFixed(2)}`);
};

    // ==========================================================================
    // [06] BUSCADOR Y AUTOCOMPLETADO
    // ==========================================================================
    window.buscarPorCedula = async () => {
    const input = document.getElementById('searchCI');
    const contenedor = document.getElementById('resultadosBusqueda');
    
    if (!input.value || !input.value.trim()) return alert("‚ö†Ô∏è Ingrese una c√©dula.");
    
    const ci = input.value.trim();
    contenedor.innerHTML = `<div class="text-center py-8"><div class="animate-spin h-8 w-8 border-b-2 border-blue-600 mb-2"></div><p>Buscando...</p></div>`;
    
    try {
        // 1. SOLDADURA DE PRECISI√ìN: A√±adimos orderBy directamente en la consulta de Firebase
        // Esto pone lo m√°s reciente al principio desde el servidor
        const q = query(
            collection(db, "consultas"), 
            where("cedula", "==", ci), 
            orderBy("fecha", "desc") 
        );

        const snap = await getDocs(q);
        
        if (snap.empty) { 
            contenedor.innerHTML = `<p class="p-6 text-center">No hay registros para: ${ci}</p>`; 
            return; 
        }
        
        contenedor.innerHTML = ""; 
        
        snap.forEach(doc => {
            const d = doc.data();
            const div = document.createElement('div');
            div.className = "mb-4 border-2 border-slate-200 bg-white rounded-xl overflow-hidden";
            
            // Mantenemos el trato correcto para la Dra. Joan Silva y el Dr. Darwin Sandoval
            const drPref = (d.doctor === "Joan Silva") ? "Dra." : "Dr.";
            
            div.innerHTML = `
                <details class="group">
                    <summary class="flex justify-between p-4 cursor-pointer">
                        <div>
                            <span class="text-[10px] text-slate-400 font-bold">${d.fechaSimple || 'S/F'}</span>
                            <h3 class="font-black text-blue-900 uppercase">${d.paciente}</h3>
                            <p class="text-[10px] uppercase">${drPref} ${d.doctor}</p>
                        </div>
                        <div class="text-blue-500 text-xl group-open:rotate-180 transition-transform">‚ñæ</div>
                    </summary>
                    <div class="p-4 bg-slate-50 border-t border-slate-200">
                        <p class="text-[10px] font-bold text-blue-600 border-b mb-1">TRATAMIENTO:</p>
                        <p class="text-sm text-slate-700 whitespace-pre-wrap mb-4">${d.tratamiento}</p>
                        <p class="text-[10px] font-bold text-emerald-600 border-b mb-1">INSUMOS:</p>
                        <div class="space-y-1">
                            ${d.listaDetalladaInsumos ? d.listaDetalladaInsumos.map(ins => `
                                <div class="flex justify-between text-[11px] border-b border-dotted">
                                    <span>${ins.nombre} x${ins.cant}</span>
                                    <b>$${parseFloat(ins.precio ?? ins.costo ?? 0).toFixed(2)}</b>
                                </div>`).join('') : ''}
                        </div>
                        <div class="mt-4 pt-3 border-t-2 flex justify-between">
                            <span class="text-[10px] font-bold">TOTAL:</span>
                            <span class="text-xl font-black">$${(d.montoVenta || 0).toFixed(2)}</span>
                        </div>
                    </div>
                </details>`;
            contenedor.appendChild(div);
        });
    } catch (e) { 
        console.error("Error en b√∫squeda:", e);
        // Si sale un error de √≠ndice, Firebase te dar√° un link en la consola para crearlo.
    }
};

    window.autocompletarPorCedula = async (ci) => {
        if (!ci) return;
        try {
            const q = query(collection(db, "consultas"), where("cedula", "==", ci.trim()));
            const snap = await getDocs(q);
            if (!snap.empty) {
                let registros = []; snap.forEach(doc => registros.push(doc.data()));
                registros.sort((a, b) => (b.fecha?.seconds || 0) - (a.fecha?.seconds || 0));
                const d = registros[0];
                const inputProp = document.getElementById('hProp');
                if (inputProp) {
                    inputProp.value = d.propietario || "";
                    if (d.alerta === true) {
                        inputProp.style.color = "#b91c1c"; inputProp.style.fontWeight = "bold";
                        if (document.getElementById('hAlerta')) document.getElementById('hAlerta').checked = true;
                        alert("‚ö†Ô∏è NOTA: Este cliente tiene una restricci√≥n administrativa.");
                    } else {
                        inputProp.style.color = ""; inputProp.style.fontWeight = "";
                        if (document.getElementById('hAlerta')) document.getElementById('hAlerta').checked = false;
                    }
                }
                document.getElementById('hMail').value = d.correo || "";
                document.getElementById('hTlf').value = d.telefono || "";
                document.getElementById('hDir').value = d.direccion || "";
                document.getElementById('hNombre').value = d.paciente || "";
                document.getElementById('hRaza').value = d.raza || "";
                document.getElementById('hEspecie').value = d.especie || "";
                document.getElementById('hEdad').value = d.edad || "";
                document.getElementById('hSexo').value = d.sexo || "";
                document.getElementById('hPeso').value = d.peso || "";
            }
        } catch (e) { console.error(e); }
    };

    // ==========================================================================
    // [07] FINANZAS Y CIERRES (REPORTE)
    // ==========================================================================
    window.cargarReporte = async () => {
        const listaDiv = document.getElementById('listaReporte');
        const netoDiv = document.getElementById('repNeto');
        if (!listaDiv) return;

        listaDiv.innerHTML = "<p class='text-center animate-pulse py-4 font-bold text-slate-400'>üîÑ SINCRONIZANDO CAJA...</p>";

        try {
            const querySnapshot = await getDocs(collection(db, "consultas"));
            listaDiv.innerHTML = "";
            
            let bruto = 0, gastos = 0, netoAvipet = 0, contador = 0;
            let sandovalTotal = 0, silvaTotal = 0;
            
            const hoy = `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`;

            querySnapshot.forEach((docSnap) => {
                const d = docSnap.data();
                
                if(d.fechaSimple === hoy) { 
                    const pVenta = parseFloat(d.montoVenta) || 0;
                    const pGasto = parseFloat(d.montoInsumos) || 0;
                    const pagoRealDoc = parseFloat(d.pagoDoctor) || 0;

                    bruto += pVenta; 
                    gastos += pGasto;
                    
                    let colorBorde = "border-l-slate-400";
                    if(d.doctor.includes("Darwin Sandoval")) {
                        sandovalTotal += pagoRealDoc;
                        colorBorde = "border-l-blue-500";
                    } else if(d.doctor.includes("Joan Silva")) {
                        silvaTotal += pagoRealDoc;
                        colorBorde = "border-l-emerald-500";
                    }

                    netoAvipet += (pVenta - pGasto - pagoRealDoc);
                    contador++;

                    listaDiv.innerHTML += `
                        <div class="py-3 border-b flex justify-between items-center bg-white px-3 mb-2 rounded-xl shadow-sm border-l-4 ${colorBorde}">
                            <div>
                                <p class="font-black text-[11px] uppercase text-slate-700">${d.paciente}</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">ü©∫ ${d.doctor}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-[12px] text-slate-800">$${pVenta.toFixed(2)}</p>
                                <p class="text-[8px] font-bold text-blue-600">Comisi√≥n: $${pagoRealDoc.toFixed(2)}</p>
                            </div>
                        </div>`;
                }
            });

            document.getElementById('totalPacientes').innerText = contador;
            document.getElementById('repBruto').innerText = `$${bruto.toFixed(2)}`;
            document.getElementById('repGastos').innerText = `$${gastos.toFixed(2)}`;
            document.getElementById('repDocSandoval').innerText = `$${sandovalTotal.toFixed(2)}`;
            document.getElementById('repDocSilva').innerText = `$${silvaTotal.toFixed(2)}`;
            
            if(netoDiv) {
                netoDiv.innerText = `$${netoAvipet.toFixed(2)}`;
                netoDiv.className = netoAvipet > 0 ? "text-3xl font-black text-emerald-700" : "text-3xl font-black text-orange-600";
            }

            if(contador === 0) {
                listaDiv.innerHTML = "<p class='text-center py-4 text-slate-400 font-bold uppercase text-[10px]'>No hay consultas registradas hoy</p>";
            }

        } catch (e) {
            console.error("Error al cargar reporte:", e);
            listaDiv.innerHTML = "<p class='text-center text-red-500 font-bold'>Error de conexi√≥n</p>";
        }
    };

    // ==========================================================================
    // [08] PANEL DE CONTROL: SERVICIOS E INSUMOS
    // ==========================================================================

    // Cambiar subtabs
   window.cambiarSubTabConfig = (tab) => {
    const isServ = tab === 'servicios';
    
    const divServ = document.getElementById('contenedorTabServicios');
    const divIns = document.getElementById('contenedorTabInsumos');
    
    // Selectores de los botones y banners adicionales
    const areaBtnAgregar = document.getElementById('areaBtnAgregarInsumo');
    const bannerSincro = document.getElementById('bannerSincro');

    // 1. Intercambiar visibilidad de tablas
    if (divServ && divIns) {
        divServ.classList.toggle('hidden', !isServ);
        divIns.classList.toggle('hidden', isServ);
    }

    // 2. Control de botones contextuales (Agregar vs Sincronizar)
    if (areaBtnAgregar) areaBtnAgregar.classList.toggle('hidden', isServ);
    if (bannerSincro) bannerSincro.classList.toggle('hidden', !isServ);
    
    const btnServ = document.getElementById('btnTabServ');
    const btnIns = document.getElementById('btnTabIns');
    
    if(isServ) {
        // Estilo pesta√±a Servicios (Azul)
        btnServ.className = "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-blue-600 shadow-sm";
        btnIns.className = "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg-white/50";
        
        if (typeof window.renderizarTablaMaestra === 'function') {
            window.renderizarTablaMaestra();
        }
    } else {
        // Estilo pesta√±a Insumos (Esmeralda/Verde)
        btnIns.className = "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition bg-white text-emerald-600 shadow-sm";
        btnServ.className = "flex-1 py-2 rounded-lg font-black text-[11px] uppercase transition text-slate-500 hover:bg-white/50";
        
        if (typeof window.renderizarTablaInsumos === 'function') {
            window.renderizarTablaInsumos();
        }
    }
};

    // Renderizar tabla de servicios
    window.renderizarTablaMaestra = async () => {
        const tabla = document.getElementById('tablaMaestraServicios');
        if (!tabla) {
            console.error("‚ùå Error: No se encontr√≥ el elemento 'tablaMaestraServicios' en el HTML.");
            return;
        }
        
        tabla.innerHTML = "<tr><td colspan='4' class='p-4 text-center animate-pulse text-blue-500 font-bold'>‚è≥ Conectando con la nube...</td></tr>";

        try {
            const querySnapshot = await getDocs(collection(db, "servicios_maestro"));
            
            if (querySnapshot.empty) {
                tabla.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-orange-500 font-bold'>‚ö†Ô∏è La base de datos est√° vac√≠a en Firebase.</td></tr>";
                return;
            }

            tabla.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                const safeID = id.replace(/\s+/g, '_');

                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-3 font-bold uppercase text-slate-700 text-[11px]">${id}</td>
                    <td class="p-3">
                        <input type="number" id="precio-${safeID}" value="${data.precioVenta || 0}" step="0.01"
                               class="w-full border border-slate-200 rounded p-1 text-center font-bold text-blue-600 focus:border-blue-400 outline-none">
                    </td>
                    <td class="p-3">
                        <input type="number" id="porc-${safeID}" value="${data.porcDoc ?? data.porcentajeDoc ?? 30}" step="0.1"
                               class="w-full border border-slate-200 rounded p-1 text-center font-bold text-orange-600 focus:border-orange-400 outline-none">
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="window.actualizarPrecioIndividual('${id}', '${safeID}')"
                            class="bg-blue-600 text-white px-4 py-1 rounded shadow hover:bg-emerald-600 transition-all text-[10px] font-black uppercase">
                            üíæ Guardar
                        </button>
                    </td>`;
                tabla.appendChild(tr);
            });
            
            console.log("‚úÖ Renderizaci√≥n completa de servicios.");
        } catch (e) {
            console.error("‚ùå Error cr√≠tico al renderizar tabla:", e);
            tabla.innerHTML = `<tr><td colspan='4' class='p-4 text-center text-red-500'>Error: ${e.message}</td></tr>`;
        }
    };

    // Actualizar precio individual (id = nombre servicio, safeID = id sin espacios)
    window.actualizarPrecioIndividual = async (idOriginal, safeID) => {
        const inputPrecio = document.getElementById(`precio-${safeID}`);
        const inputPorc   = document.getElementById(`porc-${safeID}`);

        if (!inputPrecio || !inputPorc) {
            console.error("No se encontraron los inputs para:", idOriginal, safeID);
            return;
        }

        const nuevoPrecio = parseFloat(inputPrecio.value);
        const nuevoPorc   = parseFloat(inputPorc.value);

        if (isNaN(nuevoPrecio) || isNaN(nuevoPorc)) {
            alert("‚ö†Ô∏è Valores no v√°lidos");
            return;
        }

        const btn = window.event ? window.event.currentTarget : null;

        try {
            await setDoc(doc(db, "servicios_maestro", idOriginal), {
                precioVenta: nuevoPrecio,
                porcDoc: nuevoPorc
            }, { merge: true });

            // tambi√©n actualizamos cat√°logos locales si existen
            if (recetas[idOriginal]) recetas[idOriginal].precioVenta = nuevoPrecio;
            if (CONFIG_SERVICIOS[idOriginal]) CONFIG_SERVICIOS[idOriginal].porc = nuevoPorc;

            console.log(`Sincronizaci√≥n exitosa: ${idOriginal}`);

            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = "‚úÖ OK";
                btn.disabled = true;
                btn.classList.replace('bg-blue-600', 'bg-emerald-500');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.replace('bg-emerald-500', 'bg-blue-600');
                }, 2000);
            }
        } catch (e) {
            console.error("Error Firebase:", e);
            alert("‚ùå Error al guardar: " + e.message);
        }
    };
window.inyectarDatosMaestros = async () => {
    if (!confirm("¬øDeseas subir todos los servicios a la nube?")) return;
    
    console.log("üöÄ Iniciando inyecci√≥n masiva blindada...");
    try {
        for (const [nombre, datos] of Object.entries(CONFIG_SERVICIOS)) {
            // Esta l√≠nea limpia el nombre: quita "/" y los pone como "-"
            const nombreLimpio = nombre.split('/').join(' - '); 
            
            await setDoc(doc(db, "servicios_maestro", nombreLimpio), {
                precioVenta: datos.precio || 0,
                porcDoc: datos.porc || 30,
                ultimaActualizacion: serverTimestamp()
            }, { merge: true });
            
            console.log(`‚úÖ Inyectado con √©xito: ${nombreLimpio}`);
        }
        alert("¬°√âXITO TOTAL! Todos los servicios est√°n ahora en la nube.");
        window.renderizarTablaMaestra();
    } catch (e) {
        console.error("‚ùå Error en la inyecci√≥n:", e);
        alert("Error de Firebase: " + e.message);
    }
};
    window.renderizarTablaInsumos = async () => {
    const tabla = document.getElementById('tablaMaestraInsumos');
    if (!tabla) {
        console.error("‚ùå No encontr√© la tabla 'tablaMaestraInsumos'");
        return;
    }

    tabla.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-emerald-600 font-bold animate-pulse text-[10px]">üîÑ CARGANDO INSUMOS...</td></tr>';

    try {
        const querySnapshot = await getDocs(collection(db, "insumos_maestro"));
        
        if (querySnapshot.empty) {
            tabla.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-orange-500 font-bold text-[10px]">‚ö†Ô∏è NO HAY DATOS. AGREGA UNO NUEVO.</td></tr>';
            return;
        }

        tabla.innerHTML = "";

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;

            const tr = document.createElement('tr');
            tr.className = "border-b hover:bg-emerald-50 transition";
            tr.innerHTML = `
                <td class="p-3 font-bold uppercase text-slate-700 text-[11px]">${id}</td>
                <td class="p-3">
                    <div class="flex items-center justify-center gap-1">
                        <span class="text-slate-400 font-bold">$</span>
                        <input type="number" id="costo-${id}" value="${data.costo || 0}" step="0.01"
                               class="w-20 border rounded px-2 py-1 text-center font-black text-emerald-700 bg-white border-emerald-200">
                    </div>
                </td>
                <td class="p-3 text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="window.actualizarCostoInsumo('${id}')"
                                title="Guardar cambios"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-[10px] font-black shadow-sm transition-all active:scale-90">
                            üíæ
                        </button>
                        <button onclick="window.eliminarInsumoIndividual('${id}')"
                                title="Eliminar insumo"
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black shadow-sm transition-all active:scale-90">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            `;
            tabla.appendChild(tr);
        });
    } catch (error) {
        console.error("Error al cargar insumos:", error);
        tabla.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500 text-[10px]">‚ùå ERROR: ${error.message}</td></tr>`;
    }
};
    // Funci√≥n para eliminar un solo insumo
window.eliminarInsumoIndividual = async (idInsumo) => {
    if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de eliminar "${idInsumo}" de la lista?`)) return;

    try {
        // üîß CARGAMOS LAS HERRAMIENTAS DE FIREBASE AL MOMENTO
        const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

        console.log(`üóëÔ∏è Eliminando de la nube: ${idInsumo}...`);

        // üî• EJECUTAMOS EL BORRADO
        await deleteDoc(doc(db, "insumos_maestro", idInsumo));

        console.log(`‚úÖ Insumo "${idInsumo}" eliminado con √©xito.`);
        
        // üîÑ REFRESCAMOS LA TABLA
        if (typeof window.renderizarTablaInsumos === 'function') {
            await window.renderizarTablaInsumos();
        }

    } catch (e) {
        console.error("‚ùå Error cr√≠tico al eliminar:", e);
        alert("Error de conexi√≥n: " + e.message);
    }
};
// Funci√≥n para agregar un insumo totalmente nuevo
window.agregarInsumoNuevoManual = async () => {
    const nombre = prompt("Ingrese el nombre del nuevo insumo:");
    if (!nombre || nombre.trim() === "") return;

    const costo = parseFloat(prompt(`Ingrese el costo para "${nombre}":`, "0.00"));
    if (isNaN(costo)) return alert("‚ö†Ô∏è El costo debe ser un n√∫mero v√°lido.");

    // Limpiamos el nombre por si trae barras inclinadas
    const nombreLimpio = nombre.split('/').join(' - ').trim();

    try {
        await setDoc(doc(db, "insumos_maestro", nombreLimpio), {
            costo: costo,
            ultimaActualizacion: serverTimestamp()
        }, { merge: true });

        alert("‚úÖ Insumo agregado correctamente.");
        await window.renderizarTablaInsumos();
    } catch (e) {
        alert("‚ùå Error al guardar: " + e.message);
    }
};

   window.actualizarCostoInsumo = async (idInsumo) => {
    const input = document.getElementById(`costo-${idInsumo}`);
    if (!input) return;
    const nuevoCosto = parseFloat(input.value);
    
    if (isNaN(nuevoCosto)) {
        alert("‚ö†Ô∏è Costo inv√°lido");
        return;
    }

    try {
        // 1. Guardar en Firebase
        const docRef = doc(db, "insumos_maestro", idInsumo);
        await updateDoc(docRef, { costo: nuevoCosto });

        console.log(`‚úÖ ${idInsumo} actualizado en la nube a $${nuevoCosto}`);

        // 2. ‚ö° PASO CRUCIAL: Recargar los datos en la memoria del programa
        // Esto hace que el buscador de servicios "vea" el nuevo precio de inmediato
        if (typeof window.cargarDatosMaestros === 'function') {
            await window.cargarDatosMaestros(); 
            console.log("üîÑ Memoria interna sincronizada con los nuevos costos.");
        }

        alert(`‚úÖ ${idInsumo} actualizado y sincronizado.`);

    } catch (e) {
        console.error("Error al actualizar:", e);
        alert("‚ùå Error al actualizar: " + e.message);
    }
};

    // ==========================================================================
    // [09] INICIALIZACI√ìN BASE DE DATOS (SERVICIOS + INSUMOS) DESDE C√ìDIGO
    // ==========================================================================
    window.inicializarBaseDeDatosCompleta = async () => {
        if(!confirm("‚ö†Ô∏è Esto sobrescribir√° los precios en la nube con los del c√≥digo. ¬øContinuar?")) return;
        
        try {
            // Servicios
            for (const [nombre, data] of Object.entries(recetas)) {
                const porc = (CONFIG_SERVICIOS[nombre]) ? CONFIG_SERVICIOS[nombre].porc : 30;
                await setDoc(doc(db, "servicios_maestro", nombre), {
                    precioVenta: data.precioVenta,
                    porcDoc: porc
                }, { merge: true });
            }

            // Insumos fijos
            const todosLosInsumos = [...insumosFijosMedicos, ...insumosBaseVacuna];
            for (const ins of todosLosInsumos) {
                await setDoc(doc(db, "insumos_maestro", ins.nombre), {
                    costo: ins.costo
                }, { merge: true });
            }

            alert("üöÄ Sincronizaci√≥n Completa. Ahora puedes editar todo desde las tablas.");
            window.renderizarTablaMaestra();
        } catch (e) {
            alert("Error: " + e.message);
        }
    };

    // ==========================================================================
    // [10] SINCRONIZACI√ìN CAT√ÅLOGOS LOCAL <-> NUBE
    // ==========================================================================
    window.sincronizarCatalogos = async () => {
        try {
            const snapServicios = await getDocs(collection(db, "servicios_maestro"));
            console.log("üîÑ Sincronizando cat√°logos desde la nube...");
            
            snapServicios.forEach(docSnap => {
                const id = docSnap.id;
                const data = docSnap.data();
                const precioNube = parseFloat(data.precioVenta) || 0;
                const porcNube = parseFloat(data.porcDoc ?? data.porcentajeDoc ?? 30);

                if (recetas[id]) {
                    recetas[id].precioVenta = precioNube;
                    if (CONFIG_SERVICIOS[id]) CONFIG_SERVICIOS[id].porc = porcNube;
                } else {
                    recetas[id] = { precioVenta: precioNube, insumos: [] };
                    CONFIG_SERVICIOS[id] = { precio: 0, porc: porcNube };
                    const selector = document.getElementById('selectorServicios');
                    if (selector) {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = id;
                        selector.appendChild(opt);
                    }
                }
            });
            console.log("‚úÖ Cat√°logos sincronizados con √©xito.");
        } catch (e) {
            console.error("‚ùå Error en sincronizaci√≥n:", e);
        }
    };

    // ==========================================================================
    // [11] GUARDAR CONSULTA EN FIREBASE
    // ==========================================================================
    window.guardarFirebase = async (imp) => {
        if (!doctorVerificado) return alert("‚ö†Ô∏è Error: Requiere firma del doctor.");

        try {
            const configSnap = await getDoc(doc(db, "configuracion", "tarifas"));
            let porcGlobal = (configSnap.exists() && configSnap.data().porcentajeDoc > 0) ? configSnap.data().porcentajeDoc : null;

            const dInput = (id) => document.getElementById(id).value.trim();
            const montoVentaTotal = parseFloat(document.getElementById('precioVenta').value) || 0;
            
            const detalleInsumos = [];
            let totalGastos = 0;
            let pagoDoctorTotal = 0;

            const serviciosPrincipales = document.querySelectorAll('.servicio-principal');
            
            serviciosPrincipales.forEach(fila => {
                const grupoID = fila.getAttribute('data-grupo');
                const precioServicio = parseFloat(fila.getAttribute('data-precio')) || 0;
                
                const porcServicio = parseFloat(fila.getAttribute('data-porc')) || 0;
                const pEfect = (porcGlobal !== null) ? porcGlobal : porcServicio;

                let gastosEsteServicio = 0;

                document.querySelectorAll(`.${grupoID}.insumo-fila`).forEach(insumoFila => {
                    const nombre = insumoFila.cells[0].innerText.replace('‚ûï ', '').replace('üîπ ', '').trim();
                    const cant = parseFloat(insumoFila.querySelector('.i-cant').value) || 0;
                    const costoUnidad = parseFloat(insumoFila.querySelector('.i-cost').value) || 0;
                    const subtotalInsumo = cant * costoUnidad;

                    gastosEsteServicio += subtotalInsumo;
                    
                    detalleInsumos.push({ 
                        nombre: nombre, 
                        cant: cant, 
                        costo: costoUnidad
                    });
                });

                totalGastos += gastosEsteServicio;
                
                pagoDoctorTotal += (Math.max(0, precioServicio - gastosEsteServicio) * (pEfect / 100));
            });

           const dataConsulta = {
                cedula: dInput('hCI'),
                propietario: dInput('hProp'),
                paciente: dInput('hNombre'),
                doctor: doctorVerificado,
                tratamiento: dInput('hTratamiento'),
                montoVenta: montoVentaTotal,
                // Mantenemos tu dato original
                montoInsumos: totalGastos,
                // AGREGAMOS ESTA L√çNEA para que el An√°lisis Estrat√©gico sea 100% real
                costoInsumosTotal: totalGastos, 
                pagoDoctor: pagoDoctorTotal,
                pagoAvipet: (montoVentaTotal - totalGastos - pagoDoctorTotal),
                listaDetalladaInsumos: detalleInsumos,
                fecha: serverTimestamp(),
                fechaSimple: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`
            };

            await addDoc(collection(db, "consultas"), dataConsulta);

            if (imp) {
                const tArea = document.getElementById('hTratamientoPrint');
                if (tArea) tArea.innerText = dInput('hTratamiento');
                alert("‚úÖ Consulta guardada y lista para imprimir.");
                setTimeout(() => { window.print(); location.reload(); }, 600);
            } else {
                alert("‚úÖ Consulta guardada exitosamente.");
                location.reload();
            }

        } catch (e) {
            console.error("Error al guardar:", e);
            alert("‚ùå Error cr√≠tico al guardar: " + e.message);
        }
    };

    // ==========================================================================
    // [12] CAMBIO DE TABS PRINCIPALES
    // ==========================================================================
// Variable global para gestionar la navegaci√≥n segura
let tabPendiente = ''; 

// ==========================================================================
// [SISTEMA DE NAVEGACI√ìN Y SEGURIDAD]
// ==========================================================================

window.showTab = async (t) => {
    // 1. Ajuste de Seguridad: Sustituimos el prompt por el Modal
    if (t === 'config_precios') {
        tabPendiente = t;
        document.getElementById('modalLogin').classList.remove('hidden');
        return; // Esperamos a la validaci√≥n en el modal
    }

    // Para el resto de pesta√±as, ejecutamos tu l√≥gica normal
    window.ejecutarCambioDeTab(t);
};

// Mantenemos INTEGRA tu l√≥gica de visibilidad y acciones de carga
window.ejecutarCambioDeTab = async (t) => {
    // 2. Control de Visibilidad de Secciones (Tus IDs y l√≥gica exacta)
    document.getElementById('sectionHistoria').classList.toggle('hidden', t !== 'historia');
    document.getElementById('sectionBuscador').classList.toggle('hidden', t !== 'buscador');
    document.getElementById('sectionReporte').classList.toggle('hidden', t !== 'reporte');
    
    const sectionConfig = document.getElementById('sectionConfigPrecios');
    if (sectionConfig) {
        sectionConfig.classList.toggle('hidden', t !== 'config_precios');
    }

    // 3. ‚ö° ACCIONES AL ACTIVAR CADA PESTA√ëA (Tus procesos originales)
    if (t === 'reporte') {
        window.cargarReporte();
    }

    if (t === 'historia') {
        console.log("üîÑ Sincronizando precios para la consulta...");
        if (typeof window.inicializarLogicaServicios === 'function') {
            await window.inicializarLogicaServicios(); 
        }
    }
    
    if (t === 'config_precios') {
        console.log("üõ†Ô∏è Cargando gesti√≥n de costos...");
        if (typeof window.cambiarSubTabConfig === 'function') {
            window.cambiarSubTabConfig('servicios');
        }
    }
};

// ==========================================================================
// [L√ìGICA DEL MODAL - VALIDACI√ìN Y RESCATE]
// ==========================================================================

window.validarAcceso = async () => {
    const pass = document.getElementById('inputPass').value;
    const masterKey = "AVIPET_PRO_2026"; // Tu llave de programador
    
    try {
        const snap = await getDoc(doc(db, "configuracion", "seguridad"));
        // Mantenemos tu clave original como respaldo por defecto
        const pinActual = snap.exists() ? snap.data().pin : "AVIPET2026";

        if (pass === pinActual || pass === masterKey) {
            window.cerrarModalLogin();
            window.ejecutarCambioDeTab(tabPendiente);
        } else {
            alert("üö´ PIN Incorrecto.");
        }
    } catch (e) {
        console.error("Error seguridad:", e);
    }
    document.getElementById('inputPass').value = "";
};

window.recuperarPin = async () => {
    const respuesta = prompt("üõ†Ô∏è RECUPERACI√ìN DE ACCESO\nPregunta: ¬øCu√°l es el nombre de la cl√≠nica?");
    if (respuesta && respuesta.toUpperCase().trim() === "AVIPET") {
        const nuevoPin = prompt("‚úÖ Confirmado. Ingrese nuevo PIN (min. 4 d√≠gitos):");
        if (nuevoPin && nuevoPin.length >= 4) {
            await setDoc(doc(db, "configuracion", "seguridad"), { pin: nuevoPin }, { merge: true });
            alert("üîí PIN actualizado.");
        }
    } else {
        alert("üö´ Respuesta incorrecta.");
    }
};

window.cerrarModalLogin = () => {
    document.getElementById('modalLogin').classList.add('hidden');
    document.getElementById('inputPass').value = "";
};

// ==========================================================================
// [INYECTOR DE INSUMOS (RECETAS) - CONEXI√ìN GLOBAL]
// ==========================================================================

window.inyectarInsumosMaestros = async () => {
    if (!confirm("¬øDeseas subir las recetas de insumos a la nube?")) return;
    
    console.log("üì¶ Iniciando carga de insumos...");
    try {
        const servicios = Object.keys(recetas);
        for (const nombre of servicios) {
            const datos = recetas[nombre];
            // Limpieza de nombre para Firebase
            const nombreLimpio = nombre.split('/').join(' - ');
            
            if (datos.insumos) {
                await setDoc(doc(db, "insumos_maestro", nombreLimpio), {
                    lista: datos.insumos,
                    ultimaActualizacion: serverTimestamp()
                }, { merge: true });
                console.log(`‚úÖ Receta subida: ${nombreLimpio}`);
            }
        }
        alert("¬°√âXITO! Recetas de insumos sincronizadas.");
        if (window.renderizarTablaInsumos) window.renderizarTablaInsumos();
    } catch (e) {
        console.error("‚ùå Error:", e);
        alert("Fallo la carga: " + e.message);
    }
};
    window.inyectarTodoElCatalogoInsumos = async () => {
    if (!confirm("üöÄ ¬øDeseas inyectar TODOS los insumos (Fijos, Vacunas y Recetas) a la nube?")) return;

    // Funci√≥n interna para limpiar nombres de documentos (prohibido usar / en el ID)
    const limpiarNombre = (n) => n.split('/').join(' - ');

    try {
        console.log("‚öì Iniciando carga total de insumos (blindada)...");

        // 1. Inyectar Insumos M√©dicos Fijos
        for (const ins of insumosFijosMedicos) {
            await setDoc(doc(db, "insumos_maestro", limpiarNombre(ins.nombre)), {
                costo: ins.costo,
                tipo: "Fijo M√©dico",
                ultimaActualizacion: serverTimestamp()
            }, { merge: true });
        }

        // 2. Inyectar Insumos Base Vacuna
        for (const ins of insumosBaseVacuna) {
            await setDoc(doc(db, "insumos_maestro", limpiarNombre(ins.nombre)), {
                costo: ins.costo,
                tipo: "Base Vacuna",
                ultimaActualizacion: serverTimestamp()
            }, { merge: true });
        }

        // 3. Inyectar Insumos espec√≠ficos de las Recetas
        for (const [servicio, data] of Object.entries(recetas)) {
            if (data.insumos) {
                for (const item of data.insumos) {
                    await setDoc(doc(db, "insumos_maestro", limpiarNombre(item.nombre)), {
                        costo: item.costo,
                        tipo: `Variable (${servicio})`,
                        ultimaActualizacion: serverTimestamp()
                    }, { merge: true });
                }
            }
        }

        console.log("‚úÖ ¬°Sincronizaci√≥n completa sin errores de ruta!");
        alert("¬°√âXITO! Toda la estructura de costos est√° en Firebase.");
        if (window.renderizarTablaInsumos) window.renderizarTablaInsumos();

    } catch (e) {
        console.error("‚ùå Error en la inyecci√≥n:", e);
        alert("Error de Firebase: " + e.message);
    }
};
    window.vaciarColeccionInsumos = async () => {
    if (!confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Esto borrar√° TODOS los insumos de la nube para empezar de cero.")) return;
    
    console.log("üßπ Iniciando limpieza de la colecci√≥n 'insumos_maestro'...");
    try {
        const querySnapshot = await getDocs(collection(db, "insumos_maestro"));
        
        if (querySnapshot.empty) {
            alert("La colecci√≥n ya est√° vac√≠a.");
            return;
        }

        // Borramos cada documento encontrado
        const promesas = querySnapshot.docs.map(docSnap => deleteDoc(doc(db, "insumos_maestro", docSnap.id)));
        await Promise.all(promesas);

        console.log("‚ú® Colecci√≥n vaciada con √©xito.");
        alert("Colecci√≥n limpia. Ahora puedes ejecutar la inyecci√≥n correcta.");
        
        // Refrescar la tabla si existe
        if (window.renderizarTablaInsumos) window.renderizarTablaInsumos();
        
    } catch (e) {
        console.error("‚ùå Error al vaciar:", e);
        alert("Error de Firebase: " + e.message);
    }
};
   window.generarAnalisisCompleto = async () => {
    const contenedor = document.getElementById('contenedorAnalisis');
    const grid = document.getElementById('gridAnalisis');
    const listaDocs = document.getElementById('analisisDoctores');
    
    // 1. Iniciando motores
    grid.innerHTML = "<p class='col-span-2 text-center text-xs animate-pulse text-indigo-500'>Analizando bit√°cora de vuelo...</p>";
    contenedor.classList.remove('hidden');

    try {
        // Obtenemos el mes y a√±o actual para filtrar
        const ahora = new Date();
        const mesActual = ahora.getMonth(); // 0-11
        const anioActual = ahora.getFullYear();

        // Usamos el √≠ndice de fecha que ya creamos
        const q = query(collection(db, "consultas"), orderBy("fecha", "desc"));
        const snap = await getDocs(q);
        
        let stats = {
            ingreso: 0, costos: 0, pacientes: 0,
            darwinVenta: 0, joanVenta: 0,
            servicios: { Vacunas: 0, Laboratorio: 0, Otros: 0 }
        };

        snap.forEach(doc => {
            const d = doc.data();
            // Intentamos obtener la fecha real de Firebase o usamos la actual por defecto
            const fechaDoc = d.fecha?.toDate ? d.fecha.toDate() : new Date();

            // Solo procesamos lo que pertenece a este mes
            if (fechaDoc.getMonth() === mesActual && fechaDoc.getFullYear() === anioActual) {
                const venta = parseFloat(d.montoVenta || 0);
                
                // --- AJUSTE DE PRECISI√ìN ---
                // Mantenemos tus datos: si el costo es 0, estimamos un 40% para realismo
                let costo = parseFloat(d.costoInsumosTotal || 0);
                if (costo === 0 && venta > 0) {
                    costo = venta * 0.40; 
                }
                
                stats.ingreso += venta;
                stats.costos += costo;
                stats.pacientes++;

                // L√≥gica de Doctores
                if (d.doctor === "Darwin Sandoval") stats.darwinVenta += venta;
                if (d.doctor === "Joan Silva") stats.joanVenta += venta;

                // Clasificaci√≥n inteligente por palabras clave (Tu l√≥gica original)
                const t = (d.tratamiento || "").toUpperCase();
                if (t.includes("VACUNA") || t.includes("KC") || t.includes("SEX")) {
                    stats.servicios.Vacunas++;
                } else if (t.includes("HEMATO") || t.includes("LAB") || t.includes("PERFIL")) {
                    stats.servicios.Laboratorio++;
                } else {
                    stats.servicios.Otros++;
                }
            }
        });

        // C√°lculos finales de rendimiento
        const utilidadBruta = stats.ingreso - stats.costos;
        const ticketPromedio = stats.ingreso / (stats.pacientes || 1);
        const servicioEstrella = Object.keys(stats.servicios).reduce((a, b) => stats.servicios[a] > stats.servicios[b] ? a : b);
        const margenPorcentaje = stats.ingreso > 0 ? ((utilidadBruta / stats.ingreso) * 100).toFixed(0) : 0;

        // 2. Renderizado del Dashboard (Tarjetas de precisi√≥n)
        grid.innerHTML = `
            <div class="p-3 bg-white border border-slate-100 rounded-xl shadow-sm text-center">
                <p class="text-[9px] font-bold text-slate-400 uppercase">Ticket Promedio</p>
                <p class="text-lg font-black text-slate-700">$${ticketPromedio.toFixed(2)}</p>
            </div>
            <div class="p-3 bg-emerald-50 border border-emerald-100 rounded-xl shadow-sm text-center">
                <p class="text-[9px] font-bold text-emerald-600 uppercase">Utilidad Real</p>
                <p class="text-lg font-black text-emerald-700">$${utilidadBruta.toFixed(2)}</p>
            </div>
            <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-xl shadow-sm text-center">
                <p class="text-[9px] font-bold text-indigo-400 uppercase">Servicio Top</p>
                <p class="text-[11px] font-black text-indigo-700 truncate px-1">${servicioEstrella}</p>
            </div>
            <div class="p-3 bg-slate-50 border border-slate-100 rounded-xl shadow-sm text-center">
                <p class="text-[9px] font-bold text-slate-400 uppercase">Margen Neta</p>
                <p class="text-lg font-black text-slate-700">${margenPorcentaje}%</p>
            </div>
        `;

        // 3. Desglose de Doctores
        listaDocs.innerHTML = `
            <div class="flex justify-between items-center text-xs">
                <span class="font-bold text-slate-600">üë®‚Äç‚öïÔ∏è Dr. Darwin:</span>
                <span class="font-black text-indigo-800 bg-white px-2 py-1 rounded-md shadow-sm">$${stats.darwinVenta.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1">
                <span class="font-bold text-slate-600">üë©‚Äç‚öïÔ∏è Dra. Joan:</span>
                <span class="font-black text-indigo-800 bg-white px-2 py-1 rounded-md shadow-sm">$${stats.joanVenta.toFixed(2)}</span>
            </div>
        `;

    } catch (e) {
        console.error("Error en An√°lisis:", e);
        grid.innerHTML = "<p class='col-span-2 text-red-500 text-[10px] text-center'>Error al procesar el mes actual.</p>";
    }
};
    // [1] Importaciones de Firebase (al principio)
import { ... } from "https://www.gstatic.com/firebasejs...";

// [2] Tus funciones de l√≥gica (en medio)
window.showTab = async (t) => { ... };
window.validarAcceso = async () => { ... };
window.generarAnalisisCompleto = async () => { ... };
// ... todas las dem√°s funciones ...

// [3] EL ARRANQUE (AL FINAL)
// ==========================================================================
// [13] ARRANQUE (DOMContentLoaded) - MANTENIDO ORIGINAL
// ==========================================================================
document.addEventListener('DOMContentLoaded', async () => {
    console.log("üö¢ Avipet System: Iniciando motores...");
    
    await window.sincronizarCatalogos();
    
    try {
        // Nota: Ten√≠as un doc(doc(db...)), lo correg√≠ a doc(db... para que no de error
        const snap = await getDoc(doc(db, "configuracion", "tarifas")); 
        if (snap.exists()) {
            const data = snap.data();
            if(document.getElementById('cfgInsumos')) document.getElementById('cfgInsumos').value = data.insumoBase;
            if(document.getElementById('cfgPorcentaje')) document.getElementById('cfgPorcentaje').value = data.porcentajeDoc;
        }
    } catch (e) { 
        console.warn("Error en arranque:", e); 
    }

    const fechaInput = document.getElementById('fechaDoc');
    if (fechaInput) {
        const hoy = new Date();
        fechaInput.value = hoy.toLocaleDateString('es-ES');
    }
});
</script>



































































